I"q¾<p><img src="http://favorites.ren/assets/images/2017/life/router.jpg" alt="" /></p>

<p>å‰ä¸€æ®µæ—¶é—´ï¼Œä¸šåŠ¡éƒ¨é—¨åŒäº‹åé¦ˆåœ¨ä¸€æ¬¡ç”Ÿäº§æœåŠ¡å™¨å‡çº§ä¹‹åï¼ŒPOSæ¶ˆè´¹ä¸Šä¼ å°ç¥¨ä¸šåŠ¡å¶ç°å¼‚å¸¸ï¼Œä¸Šä¼ å°ç¥¨ä¸šåŠ¡æœ‰é‡è¯•æœºåˆ¶ï¼Œæœ‰äº›é‡è¯•ä¸‰æ¬¡ä¹Ÿä¸ä¼šæˆåŠŸï¼Œä»–ä»¬æ’æŸ¥äº†ä¸€ä¸‹æ²¡æœ‰æ‰¾åˆ°åŸå› ï¼Œå¸Œæœ›æ¶æ„éƒ¨å¸®å¿™è§£å†³ã€‚</p>

<p>å…¬å¸ä½¿ç”¨çš„æ˜¯FastDFSæ¥åšçš„å›¾ç‰‡æœåŠ¡å™¨ï¼Œç”Ÿäº§ä½¿ç”¨äº†å…­å°æœåŠ¡å™¨å¤–åŠ ä¸€ä¸ªå­˜å‚¨ï¼Œé›†ç¾¤é‡‡ç”¨çš„æ˜¯ï¼š2ä¸ªtracker+4ä¸ªstorageï¼Œstorageåˆ†ä¸ºä¸¤ä¸ªgroupï¼Œä½¿ç”¨ç‹¬ç«‹çš„nginxåšæ–‡ä»¶ä»£ç†è®¿é—®ã€‚å„è½¯ä»¶ç‰ˆæœ¬ä¿¡æ¯å¦‚ä¸‹ï¼š</p>

<ul>
  <li>æ“ä½œç³»ç»Ÿï¼šcentos6.9</li>
  <li>FastDFS ï¼š5.05</li>
  <li>libfastcommonï¼š1.0.36</li>
  <li>nginx ï¼š1.7.9</li>
  <li>fastdfs-nginx-moduleï¼š1.16</li>
</ul>

<p>ä¸ºäº†å°½å¯èƒ½çš„æ¨¡æ‹Ÿç”Ÿäº§ï¼Œæˆ‘åœ¨æµ‹è¯•ç¯å¢ƒ1:1æ­å»ºäº†ä¸€å¥—å’Œç”Ÿäº§ä¸€æ ·çš„FastDFSé›†ç¾¤ï¼Œå½“æ—¶ä¹Ÿå†™äº†æ­å»ºè¿‡ç¨‹ï¼š<a href="http://www.ityouknow.com/fastdfs/2017/10/10/cluster-building-fastdfs.html">FastDFS é›†ç¾¤ å®‰è£… é…ç½®</a></p>

<h2 id="ä»æ—¥å¿—ä¸­æ‰¾çº¿ç´¢">ä»æ—¥å¿—ä¸­æ‰¾çº¿ç´¢</h2>

<p>ä¸šåŠ¡éƒ¨é—¨åŒäº‹åé¦ˆï¼Œåœ¨ä¸€æ¬¡ç”Ÿäº§æœåŠ¡å™¨å‡çº§ä¹‹åï¼Œé‡æ–°æ­å»ºäº†ä¸€å¥—FastDFSé›†ç¾¤ï¼Œç„¶åè¿‡äº†å‡ å¤©å°±å¼€å§‹å‡ºç°ä¸Šä¼ å°ç¥¨å¶å°”å¤±è´¥çš„é—®é¢˜ã€‚æ ¹æ®è¿™äº›ä¿¡æ¯çš„åé¦ˆï¼Œæˆ‘æ€€ç–‘æ˜¯å¦æ˜¯FastDFSæ­å»ºæœ‰é—®é¢˜ï¼Ÿè¿™ä¸ªæ€€ç–‘ç‚¹å·®ç‚¹æŠŠæˆ‘å¸¦åˆ°æ²Ÿé‡Œå»ã€‚</p>

<p>æˆ‘æ‹‰å–äº†FastDFSçš„æ—¥å¿—ï¼ŒtrackeræœåŠ¡å™¨æ—¥å¿—å¦‚ä¸‹ï¼š</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[2017-09-19 09:13:52] ERROR - file: tracker_nio.c, line: 306, client ip: 192.168.0.1, pkg length: 15150 &gt; max pkg size: 8192
[2017-09-19 10:34:57] ERROR - file: tracker_nio.c, line: 306, client ip: 192.168.0.1, pkg length: 16843 &gt; max pkg size: 8192
[2017-09-19 10:34:57] ERROR - file: tracker_nio.c, line: 306, client ip: 192.168.0.1, pkg length: 16843 &gt; max pkg size: 8192
[2017-09-19 11:31:08] ERROR - file: tracker_nio.c, line: 306, client ip: 192.168.03, pkg length: 23955 &gt; max pkg size: 8192
[2017-09-19 11:42:56] ERROR - file: tracker_nio.c, line: 306, client ip: 192.168.01, pkg length: 12284 &gt; max pkg size: 8192
[2017-09-19 12:10:28] ERROR - file: tracker_service.c, line: 2452, cmd=103, client ip: 192.168.0.3, package size 6258 is too long, exceeds 144

</code></pre></div></div>

<p>æ ¹æ®trackerçš„æ—¥å¿—ä¿¡æ¯å¯ä»¥çœ‹å‡ºï¼Œä¸æ—¶æœ‰ä¸€äº›å°ç¥¨æ–‡ä»¶çš„å¤§å°å¤§äºæœ€å¤§ä¼ è¾“å€¼8192ï¼Œè·Ÿç€è¿™ä¸ªçº¿ç´¢é¡ºç€ä¸Šä¼ çš„é‚£æ¡çº¿è¿›è¡Œäº†æ’æŸ¥ï¼Œæ¯”å¦‚nginxä¸Šä¼ å¤§å°çš„é™åˆ¶ï¼Œtrackerä¸Šä¼ å¤§å°çš„é™åˆ¶ï¼Œæ˜¯ä¸æ˜¯ç”Ÿæˆçš„å°ç¥¨å‡ºç°å¼‚å¸¸ï¼Œå¤§å°çªç„¶å˜å¤§ã€‚éº»æºœçš„æ•´äº†åŠå¤©å¾—å‡ºç»“è®ºï¼Œä¸Šä¼ å°ç¥¨å¤±è´¥å’Œè¿™ä¸ªå¼‚å¸¸æ²¡æœ‰å…³ç³»ã€‚</p>

<p>æ¥ä¸‹æ¥çœ‹äº†ä¸‹storagedçš„æ—¥å¿—ï¼š</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[2017-09-25 14:22:38] WARNING - file: storage_service.c, line: 7135, client ip: 192.168.1.11, logic file: M00/D1/04/wKg5ZlnIoKWAAkNRAAAY86__WXA920.jpg-m not exist
[2017-09-25 14:22:39] WARNING - file: storage_service.c, line: 7135, client ip: 192.168.1.11, logic file: M00/D1/04/wKg5ZlnIoKuAUXeVAAAeASIvHGw673.jpg not exist
[2017-09-25 14:22:50] ERROR - file: storage_nio.c, line: 475, client ip: 192.168.1.13, recv failed, errno: 104, error info: Connection reset by peer
[2017-09-25 14:22:56] ERROR - file: tracker_proto.c, line: 48, server: 192.168.1.11:23001, response status 2 != 0
[2017-09-25 14:23:06] ERROR - file: tracker_proto.c, line: 48, server: 192.168.1.11:23001, response status 2 != 0
[2017-09-25 14:23:11] ERROR - file: storage_service.c, line: 3287, client ip:192.168.1.13, group_name: group2 not correct, should be: group1
</code></pre></div></div>

<p>é™¤äº†çœ‹åˆ°ä¸€äº›æ–‡ä»¶ä¸å­˜åœ¨çš„è­¦å‘Šå’Œå“åº”çŠ¶æ€ä¸å¯¹çš„é”™è¯¯å¤–ï¼Œä¹Ÿæ²¡æœ‰å‘ç°å…¶å®ƒçš„å¼‚å¸¸ã€‚</p>

<p>æœ€åæ¥çœ‹åº”ç”¨ä¸­çš„é”™è¯¯æ—¥å¿—ï¼Œå…¶ä¸­æœ‰ä¸¤æ®µé”™è¯¯æ—¥å¿—å¼•èµ·äº†æˆ‘çš„æ³¨æ„ï¼š</p>

<p>ç¬¬ä¸€æ®µæ—¥å¿—å¦‚ä¸‹ï¼š</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>org.csource.common.MyException: body length: 0 &lt;= 16
	at org.csource.fastdfs.StorageClient.do_upload_file(StorageClient.java:799)
	at org.csource.fastdfs.StorageClient.upload_file(StorageClient.java:208)
	at org.csource.fastdfs.StorageClient.upload_file(StorageClient.java:226)
	at com.xxx.neo.fastdfs.FileManager.upload(FileManager.java:86)
	at com.xxx.neo.controller.QpayUploadSignController.saveSign(QpayUploadSignController.java:84)
	at com.xxx.neo.controller.QpayUploadSignController.uploadSign(QpayUploadSignController.java:65)
	at com.xxx.neo.controller.QpayUploadSignController$$FastClassByCGLIB$$5debf81b.invoke(&lt;generated&gt;)
	at net.sf.cglib.proxy.MethodProxy.invoke(MethodProxy.java:191)
	at org.springframework.aop.framework.Cglib2AopProxy$CglibMethodInvocation.invokeJoinpoint(Cglib2AopProxy.java:689)
	at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:150)
</code></pre></div></div>

<p>è·Ÿäº†ä¸€ä¸‹fastdfs-client-javaä¸­çš„æºç çš„do_upload_fileæ–¹æ³•ï¼Œæœ‰è¿™ä¹ˆä¸€æ®µï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">ProtoCommon</span><span class="o">.</span><span class="na">RecvPackageInfo</span> <span class="n">pkgInfo</span> <span class="o">=</span> <span class="nc">ProtoCommon</span><span class="o">.</span><span class="na">recvPackage</span><span class="o">(</span><span class="n">storageSocket</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">(),</span>
              <span class="nc">ProtoCommon</span><span class="o">.</span><span class="na">STORAGE_PROTO_CMD_RESP</span><span class="o">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">);</span>
<span class="c1">//çœç•¥ä¸­é—´ä»£ç               </span>
<span class="k">if</span> <span class="o">(</span><span class="n">pkgInfo</span><span class="o">.</span><span class="na">body</span><span class="o">.</span><span class="na">length</span> <span class="o">&lt;=</span> <span class="nc">ProtoCommon</span><span class="o">.</span><span class="na">FDFS_GROUP_NAME_MAX_LEN</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nf">MyException</span><span class="o">(</span><span class="s">"body length: "</span> <span class="o">+</span> <span class="n">pkgInfo</span><span class="o">.</span><span class="na">body</span><span class="o">.</span><span class="na">length</span> <span class="o">+</span> <span class="s">" &lt;= "</span> <span class="o">+</span> <span class="nc">ProtoCommon</span><span class="o">.</span><span class="na">FDFS_GROUP_NAME_MAX_LEN</span><span class="o">);</span>
  <span class="o">}</span>
</code></pre></div></div>

<p>pkgInfoæ˜¯å°è£…å¥½çš„æ–‡ä»¶æµä¿¡æ¯ï¼ŒProtoCommonæ˜¯fastdfs-client-javaä¸­å°è£…å¥½çš„å‚æ•°ç±»ï¼Œå…¶ä¸­FDFS_GROUP_NAME_MAX_LENçš„å€¼ä¸º16ï¼Œä»£ç çš„æ„æ€å°±æ˜¯å½“è¯»å–çš„å¤§å°å°äº16å­—èŠ‚çš„æ—¶å€™ï¼ŒæŠ›å‡ºMyExceptionå¼‚å¸¸ã€‚</p>

<p>ç¬¬äºŒæ®µæ—¥å¿—å¦‚ä¸‹ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span> <span class="no">INFO</span><span class="o">]</span> <span class="o">[</span><span class="nl">http:</span><span class="c1">//*:8083-69096 2017-09-25 14:07:32] (FileManager.java:upload:92) upload_file time used:76 ms</span>
<span class="o">[</span> <span class="no">INFO</span><span class="o">]</span> <span class="o">[</span><span class="nl">http:</span><span class="c1">//*:8083-69096 2017-09-25 14:07:32] (FileManager.java:upload:103) upload file successfully!!!group_name:group2, remoteFileName: M00/3C/A8/wKg5Z1nInSOAaHSNAAAdNipAyrQ611.jpg</span>
<span class="n">upload</span> <span class="n">file</span> <span class="n">successfully</span><span class="o">!!!</span><span class="nl">group_name:</span><span class="n">group2</span><span class="o">,</span> <span class="nl">remoteFileName:</span> <span class="no">M00</span><span class="o">/</span><span class="mi">3</span><span class="no">C</span><span class="o">/</span><span class="no">A8</span><span class="o">/</span><span class="n">wKg5Z1nInSOAaHSNAAAdNipAyrQ611</span><span class="o">.</span><span class="na">jpg</span>
<span class="o">[</span><span class="nc">Ljava</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span><span class="o">;</span><span class="err">@</span><span class="mi">17584701</span>
<span class="o">[</span><span class="no">ERROR</span><span class="o">]</span> <span class="o">[</span><span class="nl">http:</span><span class="c1">//*:8083-69087 2017-09-25 14:07:32] (FileManager.java:upload:90) Non IO Exception when uploadind the file:520</span>
<span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">NullPointerException</span>
	<span class="n">at</span> <span class="n">org</span><span class="o">.</span><span class="na">csource</span><span class="o">.</span><span class="na">fastdfs</span><span class="o">.</span><span class="na">StorageClient</span><span class="o">.</span><span class="na">do_upload_file</span><span class="o">(</span><span class="nc">StorageClient</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">842</span><span class="o">)</span>
	<span class="n">at</span> <span class="n">org</span><span class="o">.</span><span class="na">csource</span><span class="o">.</span><span class="na">fastdfs</span><span class="o">.</span><span class="na">StorageClient</span><span class="o">.</span><span class="na">upload_file</span><span class="o">(</span><span class="nc">StorageClient</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">208</span><span class="o">)</span>
	<span class="n">at</span> <span class="n">org</span><span class="o">.</span><span class="na">csource</span><span class="o">.</span><span class="na">fastdfs</span><span class="o">.</span><span class="na">StorageClient</span><span class="o">.</span><span class="na">upload_file</span><span class="o">(</span><span class="nc">StorageClient</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">226</span><span class="o">)</span>
	<span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="na">xxx</span><span class="o">.</span><span class="na">neo</span><span class="o">.</span><span class="na">fastdfs</span><span class="o">.</span><span class="na">FileManager</span><span class="o">.</span><span class="na">upload</span><span class="o">(</span><span class="nc">FileManager</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">86</span><span class="o">)</span>
	<span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="na">xxx</span><span class="o">.</span><span class="na">neo</span><span class="o">.</span><span class="na">controller</span><span class="o">.</span><span class="na">QpayUploadSignController</span><span class="o">.</span><span class="na">saveSign</span><span class="o">(</span><span class="nc">QpayUploadSignController</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">84</span><span class="o">)</span>
	<span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="na">xxx</span><span class="o">.</span><span class="na">neo</span><span class="o">.</span><span class="na">controller</span><span class="o">.</span><span class="na">QpayUploadSignController</span><span class="o">.</span><span class="na">uploadSign</span><span class="o">(</span><span class="nc">QpayUploadSignController</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">65</span><span class="o">)</span>
	<span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="na">xxx</span><span class="o">.</span><span class="na">neo</span><span class="o">.</span><span class="na">controller</span><span class="o">.</span><span class="na">QpayUploadSignController</span><span class="err">$</span><span class="n">$FastClassByCGLIB</span><span class="err">$$</span><span class="mi">5</span><span class="n">debf81b</span><span class="o">.</span><span class="na">invoke</span><span class="o">(&lt;</span><span class="n">generated</span><span class="o">&gt;)</span>
	<span class="n">at</span> <span class="n">net</span><span class="o">.</span><span class="na">sf</span><span class="o">.</span><span class="na">cglib</span><span class="o">.</span><span class="na">proxy</span><span class="o">.</span><span class="na">MethodProxy</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="nc">MethodProxy</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">191</span><span class="o">)</span>
	<span class="n">at</span> <span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">aop</span><span class="o">.</span><span class="na">framework</span><span class="o">.</span><span class="na">Cglib2AopProxy</span><span class="n">$CglibMethodInvocation</span><span class="o">.</span><span class="na">invokeJoinpoint</span><span class="o">(</span><span class="nc">Cglib2AopProxy</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">689</span><span class="o">)</span>
</code></pre></div></div>

<p>æ—¥å¿—ä¸­å…³äºç©ºæŒ‡é’ˆçš„å¼‚å¸¸æœ€å¤šï¼Œè·Ÿè¸ªäº†fastdfs-client-javaçš„æºç ï¼Œç©ºæŒ‡é’ˆéƒ½å‡ºç°åœ¨ä»¥ä¸‹å‡ æ®µä»£ç ï¼š</p>

<p>ç¬¬ä¸€å¤„ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">...</span>
<span class="n">storageSocket</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">storageServer</span><span class="o">.</span><span class="na">getSocket</span><span class="o">();</span>
<span class="n">ext_name_bs</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="nc">ProtoCommon</span><span class="o">.</span><span class="na">FDFS_FILE_EXT_NAME_MAX_LEN</span><span class="o">];</span>
<span class="nc">Arrays</span><span class="o">.</span><span class="na">fill</span><span class="o">(</span><span class="n">ext_name_bs</span><span class="o">,</span> <span class="o">(</span><span class="kt">byte</span><span class="o">)</span> <span class="mi">0</span><span class="o">);</span>
<span class="o">...</span>
</code></pre></div></div>

<p>ç¬¬äºŒå¤„ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="o">(!</span><span class="n">bNewConnection</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">storageServer</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">ex1</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">ex1</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">storageServer</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>ç¬¬ä¸‰å¤„ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="o">(</span><span class="n">bNewConnection</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">storageServer</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">ex1</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">ex1</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">storageServer</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>
</code></pre></div></div>

<p>å¤§å®¶æœ‰æ²¡æœ‰å‘ç°è¿™ä¸‰æ®µä»£ç éƒ½æœ‰ä¸€ä¸ªå…±åŒä¹‹å¤„ï¼Ÿå°±æ˜¯å­˜åœ¨storageServerå˜é‡çš„ä½¿ç”¨ï¼Œå¹¶ä¸”åœ¨è°ƒç”¨çš„åœ°æ–¹å‡ºç°äº†ç©ºæŒ‡é’ˆå¼‚å¸¸ï¼Œéš¾é“fastdfs-client-javaæœ‰bugï¼Ÿè§‰å¾—ä¸å¤ªå¯èƒ½ï¼Œæ¯•ç«Ÿé‚£ä¹ˆå¤šäººä½¿ç”¨ï¼Œä¼šä¸ä¼šæ˜¯æˆ‘ä»¬ä½¿ç”¨çš„ç‰ˆæœ¬å¤ªæ—§æˆ–è€…ä½¿ç”¨æ–¹å¼ä¸å¯¹å‘¢?</p>

<blockquote>
  <p>æ—¥å¿—ä¸­çš„IPåœ°å€å’Œå…¬å¸ä¿¡æ¯å‡å·²è¿›è¡Œè„±æ•</p>
</blockquote>

<h2 id="fastdfsæä¾›çš„jaråŒ…æœ‰é—®é¢˜">FastDFSæä¾›çš„JaråŒ…æœ‰é—®é¢˜ï¼Ÿ</h2>

<p>å¸¦ç€ä¸Šé¢çš„æ€€ç–‘æˆ‘å‡†å¤‡æä¸ªå¤šçº¿ç¨‹å‹æµ‹ä¸€ä¸‹ï¼Œçœ‹æ˜¯ä¸æ˜¯å¹¶å‘çš„æ—¶å€™äº§ç”Ÿçš„é—®é¢˜ã€‚ä½¿ç”¨CountDownLatchè®©çº¿ç¨‹é›†ä¸­æ‰§è¡Œï¼Œä»£ç å¦‚ä¸‹ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">latchTest</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">CountDownLatch</span> <span class="n">start</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CountDownLatch</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
        <span class="kd">final</span> <span class="nc">CountDownLatch</span> <span class="n">end</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CountDownLatch</span><span class="o">(</span><span class="n">poolSize</span><span class="o">);</span>
        <span class="nc">ExecutorService</span> <span class="n">exce</span> <span class="o">=</span> <span class="nc">Executors</span><span class="o">.</span><span class="na">newFixedThreadPool</span><span class="o">(</span><span class="n">poolSize</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">poolSize</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="nc">Runnable</span> <span class="n">run</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Runnable</span><span class="o">()</span> <span class="o">{</span>
                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                    <span class="k">try</span> <span class="o">{</span>
                        <span class="n">start</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
                        <span class="n">testLoad</span><span class="o">();</span>
                    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                        <span class="n">end</span><span class="o">.</span><span class="na">countDown</span><span class="o">();</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">};</span>
            <span class="n">exce</span><span class="o">.</span><span class="na">submit</span><span class="o">(</span><span class="n">run</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">start</span><span class="o">.</span><span class="na">countDown</span><span class="o">();</span>
        <span class="n">end</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
        <span class="n">exce</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span>
    <span class="o">}</span>
</code></pre></div></div>

<blockquote>
  <p>CountDownLatchæ˜¯Javaå¤šçº¿ç¨‹åŒæ­¥å™¨çš„å››å¤§é‡‘åˆšä¹‹ä¸€ï¼ŒCountDownLatchèƒ½å¤Ÿä½¿ä¸€ä¸ªçº¿ç¨‹ç­‰å¾…å…¶ä»–çº¿ç¨‹å®Œæˆå„è‡ªçš„å·¥ä½œåå†æ‰§è¡Œã€‚</p>
</blockquote>

<p>ä½¿ç”¨Executors.newFixedThreadPoolåˆ›å»ºå›ºå®šå¤§å°çš„çº¿ç¨‹æ± ï¼Œåˆšå¼€å§‹è®¾ç½®çš„æ˜¯12ï¼Œæ¯ä¸ªçº¿ç¨‹æ‰§è¡Œä¸€ä¸‡æ¬¡ä¸Šä¼ è¯·æ±‚ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">testLoad</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">String</span> <span class="n">filePath</span><span class="o">=</span><span class="s">"C:\\Users\\xxx\\Pictures\\xz.jpg"</span><span class="o">;</span>
    <span class="nc">File</span> <span class="n">file</span><span class="o">=</span><span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="n">filePath</span><span class="o">);</span>
    <span class="nc">String</span> <span class="n">serverUrl</span><span class="o">=</span><span class="s">"http://localhost:8080/uploadSign"</span><span class="o">;</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span><span class="n">i</span><span class="o">&lt;</span><span class="mi">10000</span><span class="o">;</span><span class="n">i</span><span class="o">++){</span>
        <span class="nc">HttpClientUtils</span><span class="o">.</span><span class="na">uploadFile</span><span class="o">(</span><span class="n">file</span><span class="o">,</span><span class="n">serverUrl</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Controllerå±‚æ¥åˆ°è¯·æ±‚åï¼Œç»„è£…FastDFSFileè¿›è¡Œä¸Šä¼ </p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">....</span>
<span class="kt">byte</span><span class="o">[]</span> <span class="n">file_buff</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
	<span class="k">if</span><span class="o">(</span><span class="n">inputStream</span><span class="o">!=</span><span class="kc">null</span><span class="o">){</span>
		<span class="kt">int</span> <span class="n">len1</span> <span class="o">=</span> <span class="n">inputStream</span><span class="o">.</span><span class="na">available</span><span class="o">();</span>
		<span class="n">file_buff</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="n">len1</span><span class="o">];</span>
		<span class="n">inputStream</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">file_buff</span><span class="o">);</span>
	<span class="o">}</span>
<span class="nc">FastDFSFile</span> <span class="n">file</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FastDFSFile</span><span class="o">(</span><span class="s">"520"</span><span class="o">,</span> <span class="n">file_buff</span><span class="o">,</span> <span class="s">"jpg"</span><span class="o">);</span>
<span class="k">try</span> <span class="o">{</span>
	 <span class="n">fileAbsolutePath</span> <span class="o">=</span> <span class="nc">FileManager</span><span class="o">.</span><span class="na">upload</span><span class="o">(</span><span class="n">file</span><span class="o">);</span>  <span class="c1">//ä¸Šä¼ åˆ°åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿ</span>
	<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">fileAbsolutePath</span><span class="o">);</span>
<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e1</span><span class="o">)</span> <span class="o">{</span>
	<span class="n">e1</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
<span class="o">}</span>
<span class="o">...</span>
</code></pre></div></div>

<p>å†è¿›è¡Œä¸€äº›å°è£…ä¹‹åï¼Œæœ€ç»ˆè°ƒç”¨fastdfs-client-javaçš„<code class="highlighter-rouge">upload_file()</code>æ–¹æ³•</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">....</span>
<span class="n">uploadResults</span> <span class="o">=</span> <span class="n">storageClient</span><span class="o">.</span><span class="na">upload_file</span><span class="o">(</span><span class="n">file</span><span class="o">.</span><span class="na">getContent</span><span class="o">(),</span> <span class="n">file</span><span class="o">.</span><span class="na">getExt</span><span class="o">(),</span> <span class="n">meta_list</span><span class="o">);</span>
<span class="o">....</span>
</code></pre></div></div>

<p>å‹æµ‹ä»£ç å†™å®Œä¹‹åï¼Œè¿«ä¸åŠå¾…çš„è¿è¡Œäº†èµ·æ¥ï¼Œå‡†å¤‡éªŒè¯ä¸€æŠŠï¼Œç»“æœéå¸¸å‡ºæ„æ–™ï¼Œåˆšä¸€å¯åŠ¨å°±ä¸æ–­çš„æŠ¥ç©ºæŒ‡é’ˆå¼‚å¸¸ï¼Œçœ‹åˆ°è¿™ä¸ªç©ºæŒ‡é’ˆå¼‚å¸¸æˆ‘å´ä¸€é˜µæ¬¢å–œï¼Œè¿™ä¸ªå¼‚å¸¸å’Œæˆ‘åœ¨ç”Ÿäº§çœ‹åˆ°çš„å¼‚å¸¸ä¸€æ¨¡ä¸€æ ·ã€‚å¹³æ—¶æœ€æ£˜æ‰‹çš„é—®é¢˜ï¼Œå°±æ˜¯ç”Ÿäº§å¶ç°æµ‹è¯•ç¯å¢ƒåˆä¸èƒ½å¤ç°çš„é—®é¢˜ï¼Œå¾ˆéš¾å®šä½å¼‚å¸¸çš„åŸå› ï¼Œä¸€æ—¦å¯ä»¥åœ¨æµ‹è¯•ç¯å¢ƒå¤ç°é—®é¢˜ï¼Œé‚£å°±æ„å‘³ç€é—®é¢˜è§£å†³äº†ä¸€åŠã€‚</p>

<p>æ¥ä¸‹æ¥ï¼Œæˆ‘å°†çº¿ç¨‹æ± çš„ä¸ªæ•°å‡å°‘åˆ°6ä¸ªï¼Œå¯åŠ¨æµ‹è¯•åè¿˜æ˜¯ç‹‚æŠ¥å¼‚å¸¸ï¼›æ¥ç€å°†çº¿ç¨‹æ•°å‡åˆ°2ä¸ªï¼Œæ¯ä¸ªçº¿ç¨‹æ•°æ‰§è¡Œçš„æ•°é‡ç”±ä»¥å‰çš„10000æ”¹ä¸º100ä¸ªï¼Œä¿®æ”¹åå†è¿›è¡Œæµ‹è¯•è¿˜æ˜¯æŠ¥é”™ï¼›æ²¡åŠæ³•æ”¹æˆä¸€ä¸ªçº¿ç¨‹æ¥è¿è¡Œï¼Œæœç„¶ç¨‹åºå¯ä»¥æ­£å¸¸ä¸Šä¼ å°ç¥¨äº†ï¼Œç¡®è®¤æ˜¯å¹¶å‘å¯¼è‡´çš„é—®é¢˜ã€‚</p>

<p>è¿™æ ·å¯ä»¥å¾—å‡ºé¢„åˆ¤ï¼Œåœ¨ä¸šåŠ¡é«˜å³°æœŸé—´äº§ç”Ÿå¹¶å‘å¯¼è‡´éƒ¨åˆ†å°ç¥¨ä¸Šä¼ ä¸šåŠ¡å¤±è´¥ï¼Œé‚£ä¸ºä»€ä¹ˆè¿™ä¸ªé—®é¢˜ä¸€ç›´æ²¡æœ‰å‘ç°å‘¢ï¼Ÿæœ‰ä¸¤æ–¹é¢çš„å› ç´ ï¼šç¬¬ä¸€ï¼Œå¯èƒ½ä¸šåŠ¡åˆæœŸå¹¶å‘é‡å¹¶ä¸æ˜¯å¾ˆé«˜ï¼Œä¸Šä¼ å°ç¥¨ä¹Ÿä¸æ˜¯ä¸»å¹²ä¸šåŠ¡ï¼Œå¶å°”å‡ºç°ä¸€ä¸¤ç¬”å¤±è´¥ä¹Ÿæœ‰é‡è¯•æœºåˆ¶æ¥åè¡¥ï¼›ç¬¬äºŒï¼Œç”Ÿäº§ç¯å¢ƒä½¿ç”¨äº†å…­å°æœåŠ¡å™¨åšè´Ÿè½½ï¼Œè¯·æ±‚è¢«å‡åŒ€åˆ†å‘åˆ°å…­å°æœåŠ¡å™¨ä¸­ï¼Œåœ¨æŸç§ç¨‹åº¦ä¸Šä¹Ÿé¿å…äº†å•å°æœåŠ¡å™¨çš„å¹¶å‘é‡ï¼Œåªæœ‰ä¸šåŠ¡å¹¶å‘é‡è¿›ä¸€æ­¥æ‰©å¤§æ‰å‡ºç°æ˜æ˜¾çš„å¼‚å¸¸ã€‚</p>

<h2 id="å°è¯•ç€å»è§£å†³">å°è¯•ç€å»è§£å†³</h2>

<p>æ—¢ç„¶å¼‚å¸¸éƒ½å‘ç”Ÿåœ¨upload_fileæ–¹æ³•storageServerå‡ºç°çš„åœ°æ–¹ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±ç ”ç©¶ç ”ç©¶è¿™ä¸ªstorageServeræ˜¯ä¸ªä»€ä¹ˆé¬¼ï¼ŸstorageServeræ ¹æ®å±æ€§åå¯ä»¥çœ‹å‡ºæ¥ï¼ŒstorageServeræ˜¯ä¸Šä¼ æ–‡ä»¶çš„storageå­˜å‚¨èŠ‚ç‚¹ï¼Œæ¯æ¬¡ä¸Šä¼ æ–‡ä»¶çš„æ—¶å€™ä»trackerServerä¸­è·å–ã€‚</p>

<p>è·Ÿè¸ªæºç å¯ä»¥å‘ç°ï¼ŒstorageServerä¼šåœ¨ä¸¤ä¸ªåœ°æ–¹è¿›è¡Œåˆå§‹åŒ–ï¼šç¬¬ä¸€ï¼Œåœ¨åˆå§‹åŒ–storageClientçš„æ—¶å€™</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">storageClient</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StorageClient</span><span class="o">(</span><span class="n">trackerServer</span><span class="o">,</span> <span class="n">storageServer</span><span class="o">);</span>
</code></pre></div></div>

<p>è¿™é‡Œçš„storageServerå¯ä»¥ä¸ºç©ºï¼›å¦‚æœä¸ºç©ºä¼šè‡ªåŠ¨ä»trackerServerä¸­è·å–ï¼Œå¦‚æœéœ€è¦æŒ‡å®šå…·ä½“çš„storageå¯ä»¥åœ¨è¿™é‡Œè¿›è¡Œåˆå§‹åŒ–ã€‚</p>

<p>ç¬¬äºŒï¼Œåœ¨è°ƒç”¨<code class="highlighter-rouge">do_upload_file()</code>æ–¹æ³•å¼€å¤´ä¸­ï¼Œä¸‹é¢ä»£ç æˆªå–äº<code class="highlighter-rouge">do_upload_file()</code>æ–¹æ³•ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">bUploadSlave</span> <span class="o">=</span> <span class="o">((</span><span class="n">group_name</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">group_name</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">&amp;&amp;</span>
        <span class="o">(</span><span class="n">master_filename</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">master_filename</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">&amp;&amp;</span>
        <span class="o">(</span><span class="n">prefix_name</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">));</span>
<span class="k">if</span> <span class="o">(</span><span class="n">bUploadSlave</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">bNewConnection</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">newUpdatableStorageConnection</span><span class="o">(</span><span class="n">group_name</span><span class="o">,</span> <span class="n">master_filename</span><span class="o">);</span>
<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
  <span class="n">bNewConnection</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">newWritableStorageConnection</span><span class="o">(</span><span class="n">group_name</span><span class="o">);</span>
<span class="o">}</span>

<span class="k">try</span> <span class="o">{</span>
  <span class="n">storageSocket</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">storageServer</span><span class="o">.</span><span class="na">getSocket</span><span class="o">();</span>
<span class="o">...</span>
</code></pre></div></div>

<p>åœ¨<code class="highlighter-rouge">do_upload_file()</code>æ–¹æ³•çš„å¼€å¤´ï¼Œä¼šæ ¹æ®æ¡ä»¶è¿è¡Œ<code class="highlighter-rouge">this.newUpdatableStorageConnection(group_name, master_filename)</code>æ–¹æ³•æˆ–è€…<code class="highlighter-rouge">this.newWritableStorageConnection(group_name)</code>æ–¹æ³•ï¼Œåœ¨è¿™ä¸¤ä¸ªæ–¹æ³•ä¸­éƒ½ä¼šæœ‰å¯¹storageServerè¿›è¡Œåˆå§‹åŒ–ã€‚æˆ‘ä»¬æ¥çœ‹<code class="highlighter-rouge">newWritableStorageConnection(group_name)</code>æ–¹æ³•çš„æºç ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
* check storage socket, if null create a new connection
*
* @param group_name the group name to upload file to, can be empty
* @return true if create a new connection
*/</span>
<span class="kd">protected</span> <span class="kt">boolean</span> <span class="nf">newWritableStorageConnection</span><span class="o">(</span><span class="nc">String</span> <span class="n">group_name</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">,</span> <span class="nc">MyException</span> <span class="o">{</span>
<span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">storageServer</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
  <span class="nc">TrackerClient</span> <span class="n">tracker</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">TrackerClient</span><span class="o">();</span>
  <span class="k">this</span><span class="o">.</span><span class="na">storageServer</span> <span class="o">=</span> <span class="n">tracker</span><span class="o">.</span><span class="na">getStoreStorage</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">trackerServer</span><span class="o">,</span> <span class="n">group_name</span><span class="o">);</span>
  <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">storageServer</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nf">MyException</span><span class="o">(</span><span class="s">"getStoreStorage fail, errno code: "</span> <span class="o">+</span> <span class="n">tracker</span><span class="o">.</span><span class="na">getErrorCode</span><span class="o">());</span>
  <span class="o">}</span>
  <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
<span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>è¿™ä¸ªæ–¹æ³•æ¯”è¾ƒç®€å•ï¼Œé¦–å…ˆåˆ¤æ–­storageServeræ˜¯å¦è¿›è¡Œè¿‡åˆå§‹åŒ–ï¼Œå¦‚æœæ²¡æœ‰åˆå§‹åŒ–ï¼Œåˆ™ä»trackerä¸­è·å–ä¸€ä¸ªå¯ç”¨çš„storageServerè¿›è¡Œåˆå§‹åŒ–ã€‚åˆå§‹åŒ–ä¹‹ådo_upload_file()æ–¹æ³•ä¼šæ ¹æ®æ‹¿åˆ°çš„storageServerè¿›è¡Œæ–‡ä»¶ä¸Šä¼ æ“ä½œã€‚</p>

<p><strong>æ¥ä¸‹æ¥åˆ°äº†å…¨æ–‡æœ€å…³é”®çš„åœ°æ–¹çš„äº†ï¼Œdo_upload_file()æ–¹æ³•ä¼šåœ¨ä¸Šä¼ æ–‡ä»¶ç»“æŸçš„æ—¶å€™ï¼Œå°†storageServerå…³é—­å¹¶èµ‹å€¼ä¸ºç©º</strong>ï¼Œç›¸å…³ä»£ç å¦‚ä¸‹ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">if</span> <span class="o">(!</span><span class="n">bNewConnection</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">storageServer</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">ex1</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">ex1</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">storageServer</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="k">throw</span> <span class="n">ex</span><span class="o">;</span>
<span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">bNewConnection</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">storageServer</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">ex1</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">ex1</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">storageServer</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>å½“ç„¶è¿™ä¸ªé€»è¾‘æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œæ¯æ¬¡æ–¹æ³•æ‰§è¡Œçš„æ—¶å€™è·å–ä¸€ä¸ªå¯ç”¨çš„storageServerï¼Œç»“æŸçš„æ—¶å€™è¿›è¡Œå›æ”¶ï¼Œé¿å…å¤šæ¬¡è¯·æ±‚ä½¿ç”¨åŒä¸€ä¸ªstorageã€‚å¦‚æœç¨‹åºæ²¡æœ‰ä»»ä½•å¹¶å‘è¿™æ®µä»£ç æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œå¦‚æœå‡ºç°å¹¶å‘å‘¢ï¼Œå‡ºç°å°çš„å¹¶å‘ä¹Ÿä¸ä¸€å®šä¼šå‡ºç°é—®é¢˜ï¼Œå½“å¹¶å‘é‡ç¨å¾®å¤§ä¸€ç‚¹çš„æ—¶å€™å°±ä¸€å®šä¼šå‡ºç°é—®é¢˜ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ</p>

<p>æˆ‘ä»¬æ¥ç»§ç»­è·Ÿè¸ªstorageServerï¼Œå‘ç°storageServeræ˜¯StorageClientç±»çš„ä¸€ä¸ªå…¨å±€å±æ€§ï¼Œå½“å¹¶å‘ç‰¹åˆ«å¤§çš„æ—¶å€™å°±æœ‰å¯èƒ½å‡ºç°è¿™æ ·ä¸€ä¸ªç°è±¡ï¼šç¬¬ä¸€ä¸ªçº¿ç¨‹è¿›è¿™ä¸ªæ–¹æ³•çš„æ—¶å€™ï¼Œçœ‹åˆ°storageServeræ²¡æœ‰åˆå§‹åŒ–äºæ˜¯è¿›è¡Œèµ‹å€¼å¹¶ç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼›è¿™æ—¶å€™ç¬¬äºŒä¸ªçº¿ç¨‹åˆå¼€å§‹è¿›å…¥è¿™ä¸ªæ–¹æ³•ï¼Œå‘ç°storageServerå·²ç»è¿›è¡Œäº†åˆå§‹åŒ–ï¼Œå°±ä¸å†åˆå§‹åŒ–ï¼Œç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼›å½“ç¬¬ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œç»“æŸçš„æ—¶å€™ï¼Œå°†storageServerå…³é—­å¹¶èµ‹å€¼ä¸ºnullï¼Œç„¶åæ‹å±è‚¡èµ°äººäº†ï¼›è¿™ä¸ªæ—¶å€™å¯è‹¦é€¼ç¬¬äºŒä¸ªçº¿ç¨‹äº†ï¼Œæ–¹æ³•åˆšåˆšæ‰§è¡Œäº†ä¸€åŠï¼Œå½“éœ€è¦ä½¿ç”¨storageServerçš„æ—¶å€™ï¼Œæ‰å‘ç°storageServerå·²ç»è¢«ç½®ä¸ºäº†nullï¼Œäºæ˜¯åœ¨ä½¿ç”¨storageServerçš„åœ°æ–¹éƒ½æœ‰å¯èƒ½ä¼šå‡ºç°ç©ºæŒ‡é’ˆå¼‚å¸¸ï¼Œç¬¬äºŒä¸ªçº¿ç¨‹ï¼Œåœ¨æŒ‚æ‰çš„æ—¶å€™ä¸€å®šåœ¨æƒ³ï¼ŒçœŸXXçš„å‘çˆ¹ã€‚</p>

<p>äºæ˜¯ä¸Šé¢çš„è¿™ä¸ªæ•…äº‹ï¼Œè¿‡ä¸€æ®µæ—¶é—´å°±å·å·çš„åœ¨æˆ‘ä»¬ç”Ÿäº§ç¯å¢ƒä¸­ä¸Šæ¼”ã€‚</p>

<p>åé¢æˆ‘ç»§ç»­çœ‹äº†ä¸€ä¸‹StorageClientæºç ï¼Œä¸ä½†æ˜¯do_upload_file()ä¼šå­˜åœ¨æ­¤é—®é¢˜ï¼ŒStorageClientç±»ä¸­åªè¦è¿™æ ·ä½¿ç”¨storageServerçš„åœ°æ–¹éƒ½ä¼šå‡ºç°ç±»ä¼¼çš„å¹¶å‘é—®é¢˜ï¼Œå¦‚ï¼šdo_modify_fileæ–¹æ³•ã€delete_fileæ–¹æ³•ç­‰ç­‰ã€‚</p>

<p>é‚£ä¹ˆæ—¢ç„¶æ‰¾åˆ°äº†é—®é¢˜çš„æ ¹å› ï¼Œåˆ°åº•å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿè§£å†³è¿™ä¸ªé—®é¢˜çš„æœ¬è´¨å°±æ˜¯è§£å†³å…±äº«å˜é‡çš„å¹¶å‘é—®é¢˜ï¼Œé‚£è§£å†³å…±äº«å˜é‡å¹¶å‘æœ‰å“ªäº›æ‰‹æ®µå‘¢ï¼Ÿæœ€å¸¸ç”¨æœ‰åŠ é”æˆ–è€…ä½¿ç”¨Threadlocalï¼Œçœ‹äº†ä¸€ä¸‹ä½¿ç”¨Threadlocalè¿›è¡Œæ”¹é€ å·¥ä½œé‡æ¯”è¾ƒå¤§ï¼Œå› æ­¤æˆ‘æœ€åé€‰æ‹©ä½¿ç”¨äº†SynchronizedåŒæ­¥é”æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå°±æ˜¯åœ¨æ¯ä¸ªä½¿ç”¨storageServeræ–¹æ³•ä¸Šé¢æ·»åŠ ä¸€ä¸ªSynchronizedå…³é”®å­—ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protected</span> <span class="nc">Synchronized</span>  <span class="nc">String</span><span class="o">[]</span> <span class="nf">do_upload_file</span><span class="o">()</span>
</code></pre></div></div>

<p>åœ¨githubä¸Šé¢å°†æºç downä¸‹æ¥ <a href="https://github.com/happyfish100/fastdfs-client-java">fastdfs-client-java</a>ï¼Œä¿®æ”¹å®Œä¹‹åå†è¿›è¡Œå‹æµ‹ï¼Œå¦¥å¦¥çš„å†ä¸ä¼šæŠ¥ç©ºæŒ‡é’ˆå¼‚å¸¸ç±»äº†ã€‚</p>

<h2 id="å³°å›è·¯è½¬">å³°å›è·¯è½¬</h2>

<p>å¤§å®¶ä»¥ä¸ºè¿™æ ·å°±ç»“æŸäº†å—ï¼Ÿå½“æ—¶æˆ‘ä¹Ÿæ˜¯è¿™æ ·è®¤ä¸ºçš„ã€‚åæ¥å›å¤´ä¸€æƒ³ï¼Œè¿™æ ·è™½ç„¶è§£å†³äº†é—®é¢˜ï¼Œä½†æ˜¯å¹¶å‘æ•°å´æ€¥å‰§é™ä½ï¼ŒFastDFSä¸ä¼šè¿™ä¹ˆå‚»å§ï¼è‚¯å®šè¿˜æ˜¯è‡ªå·±å‡ºäº†é—®é¢˜ï¼Œç¬¬äºŒå¤©å°†é¡¹ç›®ä¸­FastDFSä½¿ç”¨çš„ä»£ç åˆæ’¸äº†ä¸€éï¼Œæœç„¶å‘ç°é—®é¢˜äº†ã€‚</p>

<p>FileManageræ˜¯æˆ‘ä»¬å°è£…å¥½çš„FastDFSå·¥å…·ç±»ï¼Œåœ¨å¯åŠ¨çš„æ—¶å€™ä¼šå¯¹storageClientè¿›è¡Œåˆå§‹åŒ–ï¼Œè¿™æ ·æ¯æ¬¡é¡¹ç›®è°ƒç ”çš„æ—¶å€™éƒ½ä¼šå¤ç”¨storageClientå®ä¾‹ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">FileManager</span> <span class="kd">implements</span> <span class="nc">FileManagerConfig</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="nc">StorageClient</span> <span class="n">storageClient</span><span class="o">;</span>
  <span class="kd">static</span> <span class="o">{</span>
      <span class="k">try</span> <span class="o">{</span>
      <span class="c1">//çœç•¥ä¸€éƒ¨åˆ†ä»£ç </span>
      <span class="n">trackerClient</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">TrackerClient</span><span class="o">();</span>
      <span class="n">trackerServer</span> <span class="o">=</span> <span class="n">trackerClient</span><span class="o">.</span><span class="na">getConnection</span><span class="o">();</span>
      <span class="n">storageClient</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StorageClient</span><span class="o">(</span><span class="n">trackerServer</span><span class="o">,</span> <span class="n">storageServer</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>upload()æ–¹æ³•æ¯æ¬¡ä¼šä»å…¨å±€å˜é‡ä¸­è·å–storageClientè¿›è¡Œè°ƒç”¨ï¼Œä¹Ÿå°±æ„å‘³ç€æ¯æ¬¡è¯·æ±‚ä½¿ç”¨çš„æ˜¯åŒä¸€ä¸ªstorageClientå®ä¾‹ï¼Œå½“ç„¶ä¹ŸåŒ…æ‹¬å®ä¾‹ä¸­çš„å˜é‡storageServerã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="nc">String</span><span class="o">[]</span> <span class="nf">upload</span><span class="o">(</span><span class="nc">FastDFSFile</span> <span class="n">file</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="n">uploadResults</span> <span class="o">=</span> <span class="n">storageClient</span><span class="o">.</span><span class="na">upload_file</span><span class="o">(</span><span class="n">file</span><span class="o">.</span><span class="na">getContent</span><span class="o">(),</span> <span class="n">file</span><span class="o">.</span><span class="na">getExt</span><span class="o">(),</span> <span class="n">meta_list</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"Exception when uploadind the file:"</span> <span class="o">+</span> <span class="n">file</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">//çœç•¥ä¸€éƒ¨åˆ†ä»£ç </span>
    <span class="k">return</span> <span class="n">uploadResults</span><span class="o">;</span>
  <span class="o">}</span>
</code></pre></div></div>

<p>å¦‚æœæˆ‘å°†ä¸Šé¢çš„ upload()æ–¹æ³•æ”¹é€ æˆä¸‹é¢è¿™æ ·å‘¢ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="nc">String</span><span class="o">[]</span> <span class="nf">upload</span><span class="o">(</span><span class="nc">FastDFSFile</span> <span class="n">file</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="nc">StorageClient</span>  <span class="n">storageClient</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StorageClient</span><span class="o">(</span><span class="n">trackerServer</span><span class="o">,</span> <span class="n">storageServer</span><span class="o">);</span>
      <span class="n">uploadResults</span> <span class="o">=</span> <span class="n">storageClient</span><span class="o">.</span><span class="na">upload_file</span><span class="o">(</span><span class="n">file</span><span class="o">.</span><span class="na">getContent</span><span class="o">(),</span> <span class="n">file</span><span class="o">.</span><span class="na">getExt</span><span class="o">(),</span> <span class="n">meta_list</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"Exception when uploadind the file:"</span> <span class="o">+</span> <span class="n">file</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">//çœç•¥ä¸€éƒ¨åˆ†ä»£ç </span>
    <span class="k">return</span> <span class="n">uploadResults</span><span class="o">;</span>
  <span class="o">}</span>
</code></pre></div></div>

<p><strong>é‡ç‚¹æ˜¯æ·»åŠ äº†è¿™æ®µä»£ç ï¼š<code class="highlighter-rouge">StorageClient  storageClient = new StorageClient(trackerServer, storageServer);</code></strong></p>

<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œæ¯æ¬¡è°ƒç”¨çš„æ—¶å€™ä¼šé‡æ–°newä¸€ä¸ªStorageClient()å®ä¾‹ï¼Œè¿™æ ·æ¯æ¬¡è¯·æ±‚æ‹¿åˆ°çš„å°±æ˜¯ä¸åŒçš„StorageClientï¼Œä¹Ÿå°±æ„å‘³ç€æ¯ä¸ªè¯·æ±‚ä¼šè·å–åˆ°ä¸åŒçš„storageServerï¼Œè¿™æ ·å°±ä¸å­˜åœ¨å…±äº«å˜é‡ï¼Œä¹Ÿå°±é¿å…äº†å‡ºç°å¹¶å‘çš„ç©ºæŒ‡é’ˆé—®é¢˜ã€‚</p>

<p><strong>æ ¹æ®ä¸Šé¢çš„åˆ†æå¯ä»¥çœ‹å‡ºï¼Œæœ€å¥½çš„è§£å†³æ–¹æ¡ˆå°±æ˜¯æ¯æ¬¡è°ƒç”¨çš„æ—¶å€™newä¸€ä¸ªæ–°çš„å®ä¾‹å»ä½¿ç”¨ã€‚ä¹Ÿæé†’å¤§å®¶åœ¨ä½¿ç”¨FastDFSçš„æ—¶å€™ï¼Œå°½é‡ä¸è¦é‡ç”¨StorageClientï¼</strong></p>

<p>åæ¥æˆ‘åœ¨githubä¸Šé¢ç»™FastDFSæäº¤äº†pullæ¥è¯´æ˜è¿™ä¸ªé—®é¢˜ï¼Œæœ‰ä¸€ä¸ªç½‘å‹ä¹Ÿç»™å‡ºäº†åŒæ ·çš„ç†è§£ï¼š<a href="https://github.com/happyfish100/fastdfs-client-java/pull/28">è§£å†³å¹¶å‘ç©ºæŒ‡é’ˆé—®é¢˜</a> ï¼›æ–‡ä¸­çš„æµ‹è¯•ä»£ç æˆ‘æ”¾åˆ°äº†è¿™é‡Œï¼š<a href="https://github.com/ityouknow/spring-examples">spring-examples</a>ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥ç»§ç»­å»äº†è§£ã€‚</p>

<h2 id="æœ€å">æœ€å</h2>

<p>é—®é¢˜ç»ˆäºè§£å†³äº†ï¼Œè™½ç„¶èµ°äº†å¼¯è·¯ï¼Œå´è®©æˆ‘å¯¹FastDFSæœ‰äº†æ›´æ·±çš„è®¤è¯†ã€‚å¹³æ—¶è§£å†³é—®é¢˜ä¹Ÿç»å¸¸ä¼šè¿™æ ·ï¼Œæœ‰æ—¶å€™æ’æŸ¥äº†æ•´æ•´ä¸€å¤©ï¼Œæ‰å‘ç°åŸæ¥æ˜¯æŸä¸ªéå¸¸ä½çº§é”™è¯¯å¯¼è‡´çš„ï¼Œè¿™å°±æ˜¯ç¨‹åºå‘˜çš„æ­£å¸¸å·¥ä½œã€‚</p>

<p>ç ”ç©¶å‘ç°ï¼Œåœ¨æ‰€æœ‰æŠ¥å‘Šçš„é”™è¯¯ä¸­ï¼Œå¤§çº¦æœ‰95%æ˜¯ç”±ç¨‹åºå‘˜é€ æˆçš„ï¼Œ2%æ˜¯ç”±ç³»ç»Ÿè½¯ä»¶ï¼ˆç¼–è¯‘å™¨å’Œæ“ä½œç³»ç»Ÿï¼‰é€ æˆçš„ï¼Œ2%æ˜¯ç”±å…¶ä»–è½¯ä»¶é€ æˆçš„ï¼Œ1%æ˜¯ç”±ç¡¬ä»¶é€ æˆçš„ã€‚å› æ­¤ä¸è¦æ€€ç–‘äººç”Ÿã€å‡ºç°ä»€ä¹ˆå¥‡è¿¹ã€å‘ç”ŸæŸäº›è¯¡å¼‚çš„äº‹æƒ…ï¼Œé‚£æ˜¯ä¸ä¼šå‘ç”Ÿçš„ã€‚</p>

<p>è¦ç›¸ä¿¡ç¼–ç¨‹çš„ç¬¬ä¸€æ³•åˆ™ï¼š<strong>æ°¸è¿œéƒ½æ˜¯ä½ çš„é”™ï¼</strong></p>

<p>ä½ åº”è¯¥çŸ¥é“é‚£ç§æ„Ÿè§‰ã€‚æˆ‘ä»¬æ‰€æœ‰äººéƒ½æ›¾ç¢°åˆ°è¿‡è¿™æ ·çš„äº‹æƒ…ï¼šå·²ç»ç›¯ç€ä»£ç çœ‹äº†æ— æ•°éï¼Œä½†è¿˜æ˜¯æ²¡æœ‰å‘ç°ä»»ä½•é—®é¢˜ã€‚ç„¶è€Œï¼Œæœ‰ä¸ªæ•…éšœæˆ–è€…é”™è¯¯å§‹ç»ˆæŒ¥ä¹‹ä¸å»ã€‚äºæ˜¯ä½ å¼€å§‹æ€€ç–‘ï¼Œå¯èƒ½æ˜¯ä½ å¼€å‘ç¨‹åºæ‰€ç”¨çš„é‚£å°æœºå™¨å‡ºäº†é—®é¢˜ï¼Œä¹Ÿå¯èƒ½æ˜¯æ“ä½œç³»ç»Ÿçš„é—®é¢˜ï¼Œæˆ–è€…æ˜¯ä½ ä½¿ç”¨çš„å·¥å…·å’Œåº“å‡ºäº†é—®é¢˜ã€‚è‚¯å®šæ˜¯å®ƒä»¬çš„åŸå› ï¼</p>

<p><strong>ç„¶è€Œï¼Œæ— è®ºä½ å¤šä¹ˆç»æœ›ï¼Œéƒ½ä¸è¦å¾€é‚£æ¡è·¯ä¸Šèµ°ã€‚æ²¿ç€é‚£æ¡è·¯ä¸‹å»å°±æ˜¯è–›å®šè°”çš„çŒ«å’Œé è¿æ°”ç¼–ç¨‹ã€‚</strong></p>

<p>æ€»æ˜¯è¦å¤„ç†ä¸€äº›å›°éš¾çš„ã€æ‰æ‘¸ä¸é€çš„é—®é¢˜ï¼Œè¿™æ˜¯ä¸€ä»¶ä»¤äººç»æœ›çš„äº‹æƒ…ï¼Œä½†æ˜¯ä¸è¦è®©ç»æœ›é¢†ç€ä½ è¯¯å…¥æ­§é€”ã€‚ä½œä¸ºä¸€åè°¦é€Šçš„ç¨‹åºå‘˜ï¼Œæœ€åŸºæœ¬çš„è¦æ±‚å°±æ˜¯è¦æœ‰æ„è¯†ï¼šä½ å†™çš„ä»£ç åœ¨ä»»ä½•æ—¶å€™å‡ºäº†é—®é¢˜ï¼Œ<strong>é‚£ä¸€å®šéƒ½æ˜¯ä½ çš„é”™</strong>ã€‚</p>

<blockquote>
  <p>ç•™è¨€åˆ†äº«ä½ æœ€æ³¢æŠ˜çš„ä¸€æ¬¡æ’æŸ¥é—®é¢˜ç»å†ã€‚</p>
</blockquote>

<p>æ³•åˆ™å‚è€ƒï¼š<a href="https://blog.codinghorror.com/the-first-rule-of-programming-its-always-your-fault/">The First Rule of Programming: Itâ€™s Always Your Fault</a></p>
:ET