I"‚<p>å®šæ—¶ä»»åŠ¡æ˜¯äº’è”ç½‘è¡Œä¸šé‡Œæœ€å¸¸ç”¨çš„æœåŠ¡ä¹‹ä¸€ï¼Œæœ¬æ–‡ç»™å¤§å®¶ä»‹ç»å®šæ—¶ä»»åŠ¡åœ¨æˆ‘å¸çš„å‘å±•å†ç¨‹ã€‚</p>

<p>linuxç³»ç»Ÿä¸­ä¸€èˆ¬ä½¿ç”¨crontabå‘½ä»¤æ¥å®ç°ï¼Œåœ¨Javaä¸–ç•Œé‡Œï¼Œä½¿ç”¨æœ€å¹¿æ³›çš„å°±æ˜¯quartzäº†ã€‚æˆ‘å¸ä½¿ç”¨quartzå°±å·²ç»å‡çº§äº†ä¸‰ä»£ï¼Œæ¯ä¸€ä»£åœ¨ä¸Šä¸€ä»£ç³»ç»Ÿä¹‹ä¸Šæœ‰æ‰€ä¼˜åŒ–ï¼Œå†™è¿™ç¯‡æ–‡ç« ä¸€æ–¹é¢ä»‹ç»ä¸€ä¸‹quartzçš„ä½¿ç”¨ï¼Œå¦ä¸€æ–¹é¢å¯ä»¥æ ¹æ®æ­¤é¡¹ç›®çš„å˜è¿ååº”å‡ºæˆ‘å¸å¹³å°æ¶æ„å‡çº§çš„ä¸€ä¸ªç¼©å½±ã€‚</p>

<p>å®šæ—¶ä»»åŠ¡çš„ä½¿ç”¨åœºæ™¯å¾ˆå¤šï¼Œä»¥æˆ‘ä»¬å¹³å°æ¥è®²ï¼šè®¡æ¯ï¼Œæ´¾æ¯ã€å¯¹è´¦ç­‰ç­‰ã€‚</p>

<h2 id="quartz-ä»‹ç»">quartz ä»‹ç»</h2>

<p>Quartzæ˜¯ä¸ªå¼€æºçš„ä½œä¸šè°ƒåº¦æ¡†æ¶ï¼Œä¸ºåœ¨Javaåº”ç”¨ç¨‹åºä¸­è¿›è¡Œä½œä¸šè°ƒåº¦æä¾›äº†ç®€å•å´å¼ºå¤§çš„æœºåˆ¶ã€‚Quartzå…è®¸å¼€å‘äººå‘˜æ ¹æ®æ—¶é—´é—´éš”ï¼ˆæˆ–å¤©ï¼‰æ¥è°ƒåº¦ä½œä¸šã€‚å®ƒå®ç°äº†ä½œä¸šå’Œè§¦å‘å™¨çš„å¤šå¯¹å¤šå…³ç³»ï¼Œè¿˜èƒ½æŠŠå¤šä¸ªä½œä¸šä¸ä¸åŒçš„è§¦å‘å™¨å…³è”ã€‚Quartzå¯ä»¥é›†æˆå‡ ä¹ä»»ä½•çš„javaåº”ç”¨ç¨‹åºâ€”ä»å°çš„å•ç‰‡æœºç³»ç»Ÿåˆ°å¤§å‹çš„ç”µå­å•†åŠ¡ç³»ç»Ÿã€‚Quartzå¯ä»¥æ‰§è¡Œä¸Šåƒä¸Šä¸‡çš„ä»»åŠ¡è°ƒåº¦ã€‚</p>

<p>Quartzæ ¸å¿ƒçš„æ¦‚å¿µï¼šschedulerä»»åŠ¡è°ƒåº¦ã€Jobä»»åŠ¡ã€JobDetailä»»åŠ¡ç»†èŠ‚ã€Triggerè§¦å‘å™¨</p>

<ul>
  <li>Schedulerï¼šè°ƒåº¦å™¨ï¼Œè°ƒåº¦å™¨æ¥å—ä¸€ç»„JobDetail+Triggerå³å¯å®‰æ’ä¸€ä¸ªä»»åŠ¡ï¼Œå…¶ä¸­ä¸€ä¸ªJobDetailå¯ä»¥å…³è”å¤šä¸ªTrigger</li>
  <li>Jobï¼šJobæ˜¯ä»»åŠ¡æ‰§è¡Œçš„æµç¨‹ï¼Œæ˜¯ä¸€ä¸ªç±»</li>
  <li>JobDetailï¼šJobDetailæ˜¯Jobæ˜¯å®ä¾‹ï¼Œæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼ŒåŒ…å«äº†è¯¥å®ä¾‹çš„æ‰§è¡Œè®¡åˆ’å’Œæ‰€éœ€è¦çš„æ•°æ®</li>
  <li>Triggerï¼šTriggeræ˜¯å®šæ—¶å™¨ï¼Œå†³å®šä»»åŠ¡ä½•æ—¶æ‰§è¡Œ</li>
</ul>

<p>ä½¿ç”¨Quartzè°ƒåº¦ç³»ç»Ÿçš„æ€è·¯å°±æ˜¯ï¼Œé¦–å…ˆå†™ä¸€ä¸ªå…·ä½“çš„ä»»åŠ¡ï¼ˆjobï¼‰ï¼Œé…ç½®ä»»åŠ¡çš„è§¦å‘æ—¶é—´ï¼ˆTriggerï¼‰ï¼ŒSchedulerå¾ˆæ ¹æ®JobDetail+Triggerå®‰æ’å»æ‰§è¡Œæ­¤ä»»åŠ¡ã€‚</p>

<p>Quartz å®šæ—¶å™¨çš„æ—¶é—´è®¾ç½®</p>

<p>æ—¶é—´çš„é…ç½®å¦‚ä¸‹ï¼š<value>0 30 16 * * ?</value></p>

<p>æ—¶é—´å¤§å°ç”±å°åˆ°å¤§æ’åˆ—ï¼Œä»ç§’å¼€å§‹ï¼Œé¡ºåºä¸º ç§’ï¼Œåˆ†ï¼Œæ—¶ï¼Œå¤©ï¼Œæœˆï¼Œå¹´ *ä¸ºä»»æ„ ï¼Ÿä¸ºæ— é™åˆ¶ã€‚ç”±æ­¤ä¸Šé¢æ‰€é…ç½®çš„å†…å®¹å°±æ˜¯ï¼Œåœ¨æ¯å¤©çš„16ç‚¹30åˆ†å¯åŠ¨buildSendHtml() æ–¹æ³•</p>

<p>å…·ä½“æ—¶é—´è®¾å®šå¯å‚è€ƒ ï¼š</p>

<p>â€œ0/10 * * * * ?â€ æ¯10ç§’è§¦å‘<br />
â€œ0 0 12 * * ?â€ æ¯å¤©ä¸­åˆ12ç‚¹è§¦å‘ 
â€œ0 * 14 * * ?â€ åœ¨æ¯å¤©ä¸‹åˆ2ç‚¹åˆ°ä¸‹åˆ2:59æœŸé—´çš„æ¯1åˆ†é’Ÿè§¦å‘ <br />
â€œ0 10,44 14 ? 3 WEDâ€ æ¯å¹´ä¸‰æœˆçš„æ˜ŸæœŸä¸‰çš„ä¸‹åˆ2:10å’Œ2:44è§¦å‘ <br />
â€œ0 15 10 ? * MON-FRIâ€ å‘¨ä¸€è‡³å‘¨äº”çš„ä¸Šåˆ10:15è§¦å‘ <br />
â€œ0 0 06,18 * * ?â€  åœ¨æ¯å¤©ä¸Šåˆ6ç‚¹å’Œä¸‹åˆ6ç‚¹è§¦å‘</p>

<h2 id="ç¬¬ä¸€ä»£å®šæ—¶ä»»åŠ¡ç³»ç»Ÿ">ç¬¬ä¸€ä»£å®šæ—¶ä»»åŠ¡ç³»ç»Ÿ</h2>

<p>ç¬¬ä¸€ä»£å®šæ—¶ä»»åŠ¡ç³»ç»Ÿä½¿ç”¨çš„å¾ˆç®€å•ï¼Œå…¨éƒ¨æŒ‰ç…§å½“æ—¶springæ¨èçš„é…ç½®æ–¹å¼æ¥è¿›è¡Œï¼Œå¼€å‘äº2014å¹´åˆã€‚</p>

<p>é¦–å…ˆåœ¨é…ç½®çº¿ç¨‹æ± </p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"executor"</span> <span class="na">class=</span><span class="s">"org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor"</span><span class="nt">&gt;</span>
 	<span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"corePoolSize"</span> <span class="na">value=</span><span class="s">"50"</span> <span class="nt">/&gt;</span>
 	<span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"maxPoolSize"</span> <span class="na">value=</span><span class="s">"100"</span> <span class="nt">/&gt;</span>
 	<span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"queueCapacity"</span> <span class="na">value=</span><span class="s">"500"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</code></pre></div></div>

<p>é…ç½®å®šæ—¶ä»»åŠ¡å·¥å‚å’Œä»»åŠ¡åŸºç±»</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"timerFactory"</span> <span class="na">class=</span><span class="s">"com.zx.timer.TimerFactory"</span> <span class="nt">/&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"baseTask"</span> <span class="na">class=</span><span class="s">"com.zx.timer.core.BaseTask"</span><span class="nt">&gt;</span>
	<span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"machineId"</span> <span class="na">value=</span><span class="s">"${machine.id}"</span><span class="nt">/&gt;</span>
	<span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"recordErrorDetail"</span> <span class="na">value=</span><span class="s">"${is.record.errordetail}"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</code></pre></div></div>

<ul>
  <li>machineIdï¼šæœºå™¨ç¼–ç </li>
  <li>recordErrorDetailï¼šæ˜¯å¦è®°å½•è¯¦ç»†æ—¥å¿—</li>
</ul>

<p>é€šè¿‡timerFactory æ¥è·å–å…·ä½“çš„ä»»åŠ¡å’Œè§¦å‘å™¨</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TimerFactory</span> <span class="kd">implements</span> <span class="nc">BeanFactoryAware</span> <span class="o">{</span>

	<span class="kd">private</span> <span class="nc">BeanFactory</span> <span class="n">beanFactory</span><span class="o">;</span>

	<span class="kd">public</span> <span class="nc">Object</span> <span class="nf">getTask</span><span class="o">(</span><span class="nc">String</span> <span class="n">taskCode</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">beanFactory</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="n">taskCode</span><span class="o">+</span><span class="s">"Task"</span><span class="o">);</span>
	<span class="o">}</span>
	
	<span class="kd">public</span> <span class="nc">Object</span> <span class="nf">getTrigger</span><span class="o">(</span><span class="nc">String</span> <span class="n">taskCode</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">beanFactory</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="n">taskCode</span><span class="o">+</span><span class="s">"Trigger"</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setBeanFactory</span><span class="o">(</span><span class="nc">BeanFactory</span> <span class="n">beanFactory</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">beanFactory</span> <span class="o">=</span> <span class="n">beanFactory</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="nc">BeanFactory</span> <span class="nf">getBeanFactory</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">beanFactory</span><span class="o">;</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>baseTaské›†æˆäº†taskï¼Œåœ¨é‡Œé¢åšäº†ä¸€äº›åŸºç¡€çš„ä¸šåŠ¡ï¼Œæ¯”å¦‚å®šæ—¶ä»»åŠ¡å¼€å§‹æ‰§è¡Œçš„æ—¶å€™è®°å½•å®šæ—¶ä»»åŠ¡çš„å¼€å§‹æ‰§è¡Œæ—¶é—´ï¼Œå®šæ—¶ä»»åŠ¡ç»“æŸçš„æ—¶å€™è®°å½•æ‰§è¡Œçš„ç»“æœç­‰ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Task</span> <span class="o">{</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">executeTask</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<p>é…ç½®å…·ä½“çš„å®šæ—¶ä»»åŠ¡ã€‚ä»¥é‡å‘çŸ­ä¿¡é‚®ä»¶çš„å®šæ—¶ä»»åŠ¡ä¸ºä¾‹</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"resendSmsAndEmailTask"</span> <span class="na">class=</span><span class="s">"com.zx.timer.core.tasks.ResendSmsAndEmailTask"</span>
		<span class="na">parent=</span><span class="s">"baseTask"</span><span class="nt">&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"resendSmsAndEmailJob"</span> <span class="na">class=</span><span class="s">"org.springframework.scheduling.quartz.MethodInvokingJobDetailFactoryBean"</span><span class="nt">&gt;</span>
	<span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"targetObject"</span> <span class="na">ref=</span><span class="s">"resendSmsAndEmailTask"</span> <span class="nt">/&gt;</span>
	<span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"targetMethod"</span> <span class="na">value=</span><span class="s">"executeTask"</span> <span class="nt">/&gt;</span>
	<span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"concurrent"</span> <span class="na">value=</span><span class="s">"false"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"resendSmsAndEmailTrigger"</span> <span class="na">class=</span><span class="s">"org.springframework.scheduling.quartz.CronTriggerBean"</span><span class="nt">&gt;</span>
	<span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"jobDetail"</span> <span class="na">ref=</span><span class="s">"resendSmsAndEmailJob"</span> <span class="nt">/&gt;</span>
	<span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"cronExpression"</span><span class="nt">&gt;</span>
		<span class="nt">&lt;value&gt;</span>0 0 0 * * ?<span class="nt">&lt;/value&gt;</span>
	<span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</code></pre></div></div>

<ul>
  <li>resendSmsAndEmailTaskï¼šå…·ä½“çš„å®šæ—¶ä»»åŠ¡ç±»</li>
  <li>resendSmsAndEmailJobï¼šåŒ…è£…æˆå…·ä½“çš„Job</li>
  <li>resendSmsAndEmailTriggerï¼šè®¾ç½®å…·ä½“æ‰§è¡Œçš„æ—¶é—´ï¼ŒåŒ…è£…æˆTrigger</li>
</ul>

<p>å…·ä½“çš„taskç±»,åˆ æ‰äº†éƒ¨åˆ†ä¸šåŠ¡ä»£ç ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ResendSmsAndEmailTask</span> <span class="kd">extends</span> <span class="nc">BaseTask</span><span class="o">{</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">TASK_CODE</span> <span class="o">=</span> <span class="s">"resendSmsAndEmail"</span><span class="o">;</span>
	<span class="nc">AtomicInteger</span> <span class="n">ai</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AtomicInteger</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
	
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">execute</span><span class="o">(){</span>
		<span class="k">try</span> <span class="o">{</span>
			<span class="n">ai</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AtomicInteger</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
			<span class="c1">// todo</span>
		<span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
			<span class="nc">String</span> <span class="n">exception</span> <span class="o">=</span> <span class="nc">ExceptionUtils</span><span class="o">.</span><span class="na">getStackTrace</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
			<span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"stat error with exception[{}]."</span><span class="o">,</span> <span class="n">exception</span><span class="o">);</span>
			<span class="k">this</span><span class="o">.</span><span class="na">recordTaskErrorDetail</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">taskRecordId</span><span class="o">,</span> <span class="s">"ResendSmsAndEmailTask-"</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">(),</span> <span class="n">exception</span><span class="o">);</span>
		<span class="o">}</span><span class="k">finally</span><span class="o">{</span>
			<span class="k">this</span><span class="o">.</span><span class="na">modifyTaskRecord</span><span class="o">(</span><span class="n">ai</span><span class="o">.</span><span class="na">get</span><span class="o">(),</span> <span class="n">taskRecordId</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>
	
	<span class="kd">public</span> <span class="nc">String</span> <span class="nf">getTaskNo</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="no">TASK_CODE</span><span class="o">;</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>æœ€åé…ç½®schedulerä»»åŠ¡è°ƒåº¦</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"scheduler"</span> <span class="na">class=</span><span class="s">"org.springframework.scheduling.quartz.SchedulerFactoryBean"</span><span class="nt">&gt;</span>
	<span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"triggers"</span><span class="nt">&gt;</span>
		<span class="nt">&lt;list&gt;</span>
			<span class="nt">&lt;ref</span> <span class="na">bean=</span><span class="s">"resendSmsAndEmailTrigger"</span> <span class="nt">/&gt;</span>
		<span class="nt">&lt;/list&gt;</span>
	<span class="nt">&lt;/property&gt;</span>
	<span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"taskExecutor"</span> <span class="na">ref=</span><span class="s">"executor"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">"com.zx.timer.core.scheduler.DynamicJobAssembler"</span> <span class="na">init-method=</span><span class="s">"init"</span> <span class="na">scope=</span><span class="s">"singleton"</span><span class="nt">/&gt;</span>
</code></pre></div></div>

<p>DynamicJobAssemblerç±»ä»£ç ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DynamicJobAssembler</span> <span class="o">{</span>

	<span class="kd">private</span> <span class="kd">static</span> <span class="nc">Logger</span> <span class="n">logger</span> <span class="o">=</span> <span class="nc">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="nc">DynamicJobAssembler</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

	<span class="nd">@Resource</span>
	<span class="nc">Scheduler</span> <span class="n">scheduler</span><span class="o">;</span>

	<span class="nd">@Resource</span>
	<span class="nc">TimerFactory</span> <span class="n">timerFactory</span><span class="o">;</span>

	<span class="nd">@Resource</span>
	<span class="nc">TaskDao</span> <span class="n">taskDao</span><span class="o">;</span>

	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">()</span> <span class="o">{</span>
		<span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"start to assemble task from db."</span><span class="o">);</span>
		<span class="nc">List</span><span class="o">&lt;</span><span class="nc">TaskEntity</span><span class="o">&gt;</span> <span class="n">tasks</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">taskDao</span><span class="o">.</span><span class="na">getAllTask</span><span class="o">();</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">tasks</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">tasks</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">return</span><span class="o">;</span>
		<span class="o">}</span>

		<span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">jobNameMap</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">getAllJobNames</span><span class="o">();</span>
		<span class="k">for</span> <span class="o">(</span><span class="nc">TaskEntity</span> <span class="n">task</span> <span class="o">:</span> <span class="n">tasks</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="n">task</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
			<span class="nc">CronTriggerBean</span> <span class="n">taskTrigger</span> <span class="o">=</span> <span class="o">(</span><span class="nc">CronTriggerBean</span><span class="o">)</span> <span class="n">timerFactory</span><span class="o">.</span><span class="na">getTrigger</span><span class="o">(</span><span class="n">task</span><span class="o">.</span><span class="na">getTaskNo</span><span class="o">());</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">taskTrigger</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
				<span class="k">if</span> <span class="o">(!</span><span class="n">task</span><span class="o">.</span><span class="na">getSchedulerRule</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">taskTrigger</span><span class="o">.</span><span class="na">getCronExpression</span><span class="o">()))</span> <span class="o">{</span>
					<span class="k">try</span> <span class="o">{</span>
						<span class="n">taskTrigger</span><span class="o">.</span><span class="na">setCronExpression</span><span class="o">(</span><span class="n">task</span><span class="o">.</span><span class="na">getSchedulerRule</span><span class="o">());</span>
					<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">ParseException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
						<span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"db task's cronExpression parse error:{}"</span><span class="o">,</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
					<span class="o">}</span>
					<span class="k">try</span> <span class="o">{</span>
						<span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"rescheduleJob jobName:{}"</span><span class="o">,</span><span class="n">task</span><span class="o">.</span><span class="na">getTaskNo</span><span class="o">());</span>
						<span class="n">scheduler</span><span class="o">.</span><span class="na">rescheduleJob</span><span class="o">(</span><span class="n">task</span><span class="o">.</span><span class="na">getTaskNo</span><span class="o">()</span> <span class="o">+</span> <span class="s">"Trigger"</span><span class="o">,</span> <span class="nc">Scheduler</span><span class="o">.</span><span class="na">DEFAULT_GROUP</span><span class="o">,</span> <span class="n">taskTrigger</span><span class="o">);</span>
					<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">SchedulerException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
						<span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"revieved task[{},{}] reschedule error:{}"</span><span class="o">,</span> <span class="n">task</span><span class="o">.</span><span class="na">getTaskNo</span><span class="o">(),</span> <span class="n">task</span><span class="o">.</span><span class="na">getSchedulerRule</span><span class="o">(),</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
					<span class="o">}</span>
				<span class="o">}</span>
				<span class="n">jobNameMap</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">task</span><span class="o">.</span><span class="na">getTaskNo</span><span class="o">()</span> <span class="o">+</span> <span class="s">"Job"</span><span class="o">);</span>
			<span class="o">}</span>
		<span class="o">}</span>

		<span class="k">if</span> <span class="o">(</span><span class="n">jobNameMap</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"====================================="</span><span class="o">);</span>
			<span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Jobs need to be removed:"</span> <span class="o">+</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">jobNameMap</span><span class="o">.</span><span class="na">keySet</span><span class="o">().</span><span class="na">toArray</span><span class="o">()));</span>
			<span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"====================================="</span><span class="o">);</span>
			<span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">jobName</span> <span class="o">:</span> <span class="n">jobNameMap</span><span class="o">.</span><span class="na">keySet</span><span class="o">())</span> <span class="o">{</span>
				<span class="k">try</span> <span class="o">{</span>
					<span class="n">scheduler</span><span class="o">.</span><span class="na">deleteJob</span><span class="o">(</span><span class="n">jobName</span><span class="o">,</span> <span class="n">jobNameMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">jobName</span><span class="o">));</span>
				<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">SchedulerException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
					<span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"Error occured when deleting Job[{}] with Exception:{}"</span><span class="o">,</span> <span class="n">jobName</span><span class="o">,</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
				<span class="o">}</span>
			<span class="o">}</span>
		<span class="o">}</span>
		<span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"end to assemble task from db."</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="kd">private</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="nf">getAllJobNames</span><span class="o">()</span> <span class="o">{</span>
		<span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">jobNameMap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;();</span>
		<span class="k">try</span> <span class="o">{</span>
			<span class="nc">String</span><span class="o">[]</span> <span class="n">groups</span> <span class="o">=</span> <span class="n">scheduler</span><span class="o">.</span><span class="na">getJobGroupNames</span><span class="o">();</span>
			<span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">group</span> <span class="o">:</span> <span class="n">groups</span><span class="o">)</span> <span class="o">{</span>
				<span class="nc">String</span><span class="o">[]</span> <span class="n">jobs</span> <span class="o">=</span> <span class="n">scheduler</span><span class="o">.</span><span class="na">getJobNames</span><span class="o">(</span><span class="n">group</span><span class="o">);</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">jobs</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
					<span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">job</span> <span class="o">:</span> <span class="n">jobs</span><span class="o">)</span> <span class="o">{</span>
						<span class="n">jobNameMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">job</span><span class="o">,</span> <span class="n">group</span><span class="o">);</span>
					<span class="o">}</span>
				<span class="o">}</span>
			<span class="o">}</span>
		<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">SchedulerException</span> <span class="n">e1</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"Failed in geting all job names with exception:{}"</span><span class="o">,</span> <span class="n">e1</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
		<span class="o">}</span>
		<span class="k">return</span> <span class="n">jobNameMap</span><span class="o">;</span>
	<span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>

<p>å®šæ—¶ä»»åŠ¡è¡¨ï¼Œæ‰§è¡Œçš„æ—¶å€™ä»¥è¡¨é‡Œé¢çš„æ•°æ®ä¸ºå‡†ï¼Œæ–¹ä¾¿ç¼–è¾‘ã€‚</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SET</span> <span class="n">FOREIGN_KEY_CHECKS</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>

<span class="c1">-- ----------------------------</span>
<span class="c1">-- Table structure for `zx_task_informations`</span>
<span class="c1">-- ----------------------------</span>
<span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="nv">`zx_task_informations`</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="nv">`zx_task_informations`</span> <span class="p">(</span>
  <span class="nv">`id`</span> <span class="nb">bigint</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="n">AUTO_INCREMENT</span><span class="p">,</span>
  <span class="nv">`version`</span> <span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="s1">'ç‰ˆæœ¬å·ï¼šéœ€è¦ä¹è§‚é”æ§åˆ¶'</span><span class="p">,</span>
  <span class="nv">`taskNo`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="s1">'ä»»åŠ¡ç¼–å·'</span><span class="p">,</span>
  <span class="nv">`taskName`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="s1">'ä»»åŠ¡åç§°'</span><span class="p">,</span>
  <span class="nv">`schedulerRule`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="s1">'å®šæ—¶è§„åˆ™è¡¨è¾¾å¼'</span><span class="p">,</span>
  <span class="nv">`frozenStatus`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="s1">'å†»ç»“çŠ¶æ€'</span><span class="p">,</span>
  <span class="nv">`executorNo`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="s1">'æ‰§è¡Œæ–¹'</span><span class="p">,</span>
  <span class="nv">`timeKey`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="s1">'æ‰§è¡Œæ—¶é—´æ ¼å¼'</span><span class="p">,</span>
  <span class="nv">`frozenTime`</span> <span class="nb">bigint</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="s1">'å†»ç»“æ—¶é—´'</span><span class="p">,</span>
  <span class="nv">`unfrozenTime`</span> <span class="nb">bigint</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="s1">'è§£å†»æ—¶é—´'</span><span class="p">,</span>
  <span class="nv">`createTime`</span> <span class="nb">bigint</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="s1">'åˆ›å»ºæ—¶é—´'</span><span class="p">,</span>
  <span class="nv">`lastModifyTime`</span> <span class="nb">bigint</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="s1">'æœ€è¿‘ä¿®æ”¹æ—¶é—´'</span><span class="p">,</span>
  <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="nv">`id`</span><span class="p">)</span>
<span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="n">AUTO_INCREMENT</span><span class="o">=</span><span class="mi">26</span> <span class="k">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8</span> <span class="k">COMMENT</span><span class="o">=</span><span class="s1">'å®šæ—¶ä»»åŠ¡ä¿¡æ¯è¡¨'</span><span class="p">;</span>

<span class="c1">-- ----------------------------</span>
<span class="c1">-- Records of zx_task_informations</span>
<span class="c1">-- ----------------------------</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="nv">`zx_task_informations`</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">'1'</span><span class="p">,</span> <span class="s1">'0'</span><span class="p">,</span> <span class="s1">'resendSmsAndEmail'</span><span class="p">,</span> <span class="s1">'é‡å‘çŸ­ä¿¡å’Œé‚®ä»¶'</span><span class="p">,</span> <span class="s1">'10 */10 * * * ?'</span><span class="p">,</span> <span class="s1">'FROZEN'</span><span class="p">,</span> <span class="s1">'0'</span><span class="p">,</span> <span class="s1">'yyyy-MM-dd HH:mm'</span><span class="p">,</span> <span class="s1">'0'</span><span class="p">,</span> <span class="s1">'0'</span><span class="p">,</span> <span class="s1">'0'</span><span class="p">,</span> <span class="s1">'1486807296009'</span><span class="p">);</span>
</code></pre></div></div>

<p>è¿™å°±æ˜¯æˆ‘ä»¬ç¬¬ä¸€ä»£å®šæ—¶ä»»åŠ¡ç³»ç»Ÿï¼Œè¾¾åˆ°äº†å®šæœŸæ‰§è¡Œå®šæ—¶ä»»åŠ¡çš„æ•ˆæœï¼Œä½†æ˜¯åŒæ ·æœ‰ä¸¤ä¸ªç¼ºç‚¹ï¼š</p>

<ul>
  <li>1ã€å®šæ—¶è°ƒåº¦å’Œä¸šåŠ¡ä»£ç è€¦åˆåœ¨ä¸€èµ·</li>
  <li>2ã€æ¯æ¬¡è°ƒæ•´å®šæ—¶ä»»åŠ¡çš„æ—¶é—´éœ€è¦é‡å¯æœåŠ¡</li>
</ul>

:ET