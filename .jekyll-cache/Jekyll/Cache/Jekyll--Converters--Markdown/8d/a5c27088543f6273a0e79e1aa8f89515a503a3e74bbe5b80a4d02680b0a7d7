I"‰F<p>æ•°æ®åœ¨ä»»ä½•ä¸€å®¶å…¬å¸é‡Œé¢éƒ½æ˜¯æœ€æ ¸å¿ƒçš„èµ„äº§ï¼Œå®šæœŸå¤‡ä»½åˆ™æ˜¯ä¸ºäº†ä¿è¯æ•°æ®åº“å‡ºç°é—®é¢˜çš„æ—¶å€™èƒ½å¤ŸåŠæ—¶å›æ»šåˆ°æœ€è¿‘çš„å¤‡ä»½ç‚¹ï¼Œå°†æŸå¤±ç¼©å°åˆ°æœ€å°</p>

<p>è¿™ç¯‡æ–‡ç« å°†ä¼šä¸¤éƒ¨åˆ†æ¥è¯´æ˜ï¼š1ã€mysqlçš„å®šæœŸå¤‡ä»½ï¼›2ã€åŒæ­¥åˆ°å…¶å®ƒæœåŠ¡å™¨</p>

<h2 id="mysql-å¤‡ä»½">mysql å¤‡ä»½</h2>

<h3 id="å¤‡ä»½è¿˜åŸæŸä¸ªæ•°æ®åº“">å¤‡ä»½è¿˜åŸæŸä¸ªæ•°æ®åº“</h3>

<p>å¤‡ä»½è¿˜åŸ</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># å¯¼å‡ºæ•°æ®åº“</span>
/usr/bin/mysqldump <span class="nt">-u</span> root <span class="nt">-ppwd</span> database <span class="o">&gt;</span> database20160929.sql
<span class="c"># å¯¼å…¥æ•°æ®åº“</span>
mysql <span class="nt">-u</span> root <span class="nt">-p</span> database &lt; database20160929.sql
</code></pre></div></div>

<p>å¤‡ä»½åˆ°å‹ç¼©æ–‡ä»¶ä»å‹ç¼©æ–‡ä»¶å¯¼å…¥</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#å¤‡ä»½åˆ°å‹ç¼©æ–‡ä»¶</span>
/usr/bin/mysqldump <span class="nt">-u</span> root <span class="nt">-ppwd</span> database  | <span class="nb">gzip</span> <span class="o">&gt;</span> database20160929.sql.gz
<span class="c">#ä»å‹ç¼©æ–‡ä»¶å¯¼å…¥</span>
<span class="nb">gzip</span> &lt; database20160929.sql.gz | mysql <span class="nt">-u</span> root <span class="nt">-p</span> database
</code></pre></div></div>

<h3 id="crontabå®šæ—¶å¤‡ä»½">crontabå®šæ—¶å¤‡ä»½</h3>

<p>1ã€åˆ›å»ºå¤‡ä»½ç›®å½•</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># root ç”¨æˆ·,åˆ›å»ºå¤‡ä»½ç›®å½•</span>
<span class="nb">mkdir</span> <span class="nt">-p</span> /bak/mysqlbak
<span class="nb">cd</span> /bak/mysqldata
</code></pre></div></div>

<p>2ã€ç¼–å†™è¿è¡Œè„šæœ¬</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vi  /usr/sbin/bakmysql.sh
</code></pre></div></div>

<p>è„šæœ¬ä»£ç ï¼š</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
<span class="c"># Name:bakmysql.sh</span>
<span class="c"># This is a ShellScript For Auto DB Backup and Delete old Backup</span>
<span class="c">#</span>
<span class="nv">backupdir</span><span class="o">=</span>/bak/mysqlbak
<span class="nb">time</span><span class="o">=</span><span class="sb">`</span> <span class="nb">date</span> +%Y%m%d%H <span class="sb">`</span>
mysql_bin_dir/mysqldump <span class="nt">-u</span> root <span class="nt">-ppwd</span> database | <span class="nb">gzip</span> <span class="o">&gt;</span> <span class="nv">$backupdir</span>/database<span class="nv">$time</span>.sql.gz
<span class="c">#</span>
find <span class="nv">$backupdir</span> <span class="nt">-name</span> <span class="s2">"name_*.sql.gz"</span> <span class="nt">-type</span> f <span class="nt">-mtime</span> +7 <span class="nt">-exec</span> <span class="nb">rm</span> <span class="o">{}</span> <span class="p">;</span> <span class="o">&gt;</span> /dev/null 2&gt;&amp;1

<span class="c">#</span>
</code></pre></div></div>

<p>è„šæœ¬è¯´æ˜ï¼š</p>

<blockquote>
  <p><code class="highlighter-rouge">backupdir</code> mysqlå¤‡ä»½åœ°å€<br />
<code class="highlighter-rouge">root</code> mysqlç”¨æˆ·å<br />
<code class="highlighter-rouge">pwd</code> mysqlå¯†ç <br />
<code class="highlighter-rouge">database</code> æ•°æ®åº“å<br />
<code class="highlighter-rouge">mysql_bin_dir</code> mysqlçš„binè·¯å¾„ï¼›<br />
<code class="highlighter-rouge">time=` date +%Y%m%d%H `</code>ä¹Ÿå¯ä»¥å†™ä¸º<code class="highlighter-rouge">time="$(date +"%Y%m%d$H")"</code>å…¶ä¸­<code class="highlighter-rouge">`</code>  ç¬¦å·æ˜¯TABé”®ä¸Šé¢çš„ç¬¦å·ï¼Œä¸æ˜¯ENTERå·¦è¾¹çš„â€™ç¬¦å·ï¼Œè¿˜æœ‰dateåè¦æœ‰ä¸€ä¸ªç©ºæ ¼ã€‚<br />
<code class="highlighter-rouge">type f</code>   è¡¨ç¤ºæŸ¥æ‰¾æ™®é€šç±»å‹çš„æ–‡ä»¶ï¼Œfè¡¨ç¤ºæ™®é€šæ–‡ä»¶ã€‚<br />
<code class="highlighter-rouge">mtime +7</code>   æŒ‰ç…§æ–‡ä»¶çš„æ›´æ”¹æ—¶é—´æ¥æŸ¥æ‰¾æ–‡ä»¶ï¼Œ+7è¡¨ç¤ºæ–‡ä»¶æ›´æ”¹æ—¶é—´è·ç°åœ¨7å¤©ä»¥å‰ï¼›å¦‚æœæ˜¯ -mmin +5 è¡¨ç¤ºæ–‡ä»¶æ›´æ”¹æ—¶é—´è·ç°åœ¨5åˆ†é’Ÿä»¥å‰ã€‚<br />
<code class="highlighter-rouge">exec rm {} \</code>  è¡¨ç¤ºæ‰§è¡Œä¸€æ®µshellå‘½ä»¤ï¼Œexecé€‰é¡¹åé¢è·Ÿéšç€æ‰€è¦æ‰§è¡Œçš„å‘½ä»¤æˆ–è„šæœ¬ï¼Œç„¶åæ˜¯ä¸€å¯¹å„¿{}ï¼Œä¸€ä¸ªç©ºæ ¼å’Œä¸€ä¸ª\ï¼Œæœ€åæ˜¯ä¸€ä¸ªåˆ†å·ã€‚<br />
<code class="highlighter-rouge">/dev/null 2&gt;&amp;1</code>  æŠŠæ ‡å‡†å‡ºé”™é‡å®šå‘åˆ°æ ‡å‡†è¾“å‡ºï¼Œç„¶åæ‰”åˆ°/DEV/NULLä¸‹é¢å»ã€‚é€šä¿—çš„è¯´ï¼Œå°±æ˜¯æŠŠæ‰€æœ‰æ ‡å‡†è¾“å‡ºå’Œæ ‡å‡†å‡ºé”™éƒ½æ‰”åˆ°åƒåœ¾æ¡¶é‡Œé¢ï¼›å…¶ä¸­çš„&amp; è¡¨ç¤ºè®©è¯¥å‘½ä»¤åœ¨åå°æ‰§è¡Œã€‚</p>
</blockquote>

<p>3ã€ä¸ºè„šæœ¬æ·»åŠ æ‰§è¡Œæƒé™</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># chmod +x /usr/sbin/bakmysql.sh</span>
</code></pre></div></div>

<p>4ã€è®¾ç½®crontabå®šæ—¶æ‰§è¡Œ</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vi /etc/crontab 
<span class="c">#åœ¨æœ€åä¸€è¡Œä¸­åŠ å…¥ï¼š  </span>
00 3 <span class="k">*</span> <span class="k">*</span> <span class="k">*</span> root /usr/sbin/bakmysql.sh
<span class="c">#è¡¨ç¤ºæ¯å¤©3ç‚¹00åˆ†æ‰§è¡Œå¤‡ä»½</span>
</code></pre></div></div>

<blockquote>
  <p>æ³¨ï¼šcrontabé…ç½®æ–‡ä»¶æ ¼å¼å¦‚ä¸‹ï¼š<br />
åˆ†ã€€æ—¶ã€€æ—¥ã€€æœˆã€€å‘¨ã€€ å‘½ä»¤</p>
</blockquote>

<p>5ã€é‡å¯crontab</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/etc/rc.d/init.d/crond restart  
</code></pre></div></div>

<p>è¿™æ ·å°±å®Œäº†å®šæ—¶å¤‡ä»½å¹¶æ¸…ç†å‰7å¤©çš„å¤‡ä»½æ•°æ®</p>

<h2 id="åŒæ­¥åˆ°å…¶å®ƒæœåŠ¡å™¨">åŒæ­¥åˆ°å…¶å®ƒæœåŠ¡å™¨</h2>

<p>è¿™é‡Œä½¿ç”¨LinuxåŒæ­¥æ–‡ä»¶å·¥å…·rsync+inotifyæ¥è¿›è¡Œæ–‡ä»¶çš„åŒæ­¥</p>

<h3 id="rsync">rsync</h3>

<p>rsyncæ˜¯ç±»unixç³»ç»Ÿä¸‹çš„æ•°æ®é•œåƒå¤‡ä»½å·¥å…·â€”â€”remote syncã€‚ä¸€æ¬¾å¿«é€Ÿå¢é‡å¤‡ä»½å·¥å…· Remote Syncï¼Œè¿œç¨‹åŒæ­¥ æ”¯æŒæœ¬åœ°å¤åˆ¶ï¼Œæˆ–è€…ä¸å…¶ä»–SSHã€rsyncä¸»æœºåŒæ­¥</p>

<p><strong>ç”¨æ³•</strong></p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rsync src dest
</code></pre></div></div>

<p>è¿™æ˜¯æœ€ç®€å•çš„ç”¨æ³•ï¼Œè¡¨ç¤ºåŒæ­¥src,destæ–‡ä»¶ã€‚ï¼ˆå³ï¼Œæ‰§è¡Œä¹‹åï¼Œdestçš„æ–‡ä»¶ä¸srcçš„ç›¸åŒï¼Œä»¥srcçš„ä¸ºå‡†)</p>

<p>å¸¸ç”¨é€‰é¡¹</p>
<blockquote>
  <p><code class="highlighter-rouge">-a</code>: ç­‰ä»·äº-rlptgoD,å½’æ¡£å¼<br />
<code class="highlighter-rouge">-r</code>: é€’å½’<br />
<code class="highlighter-rouge">-l</code>: å¤åˆ¶è½¯ä»¶é“¾æ¥<br />
<code class="highlighter-rouge">-p</code>: ä¿ç•™æƒé™ä¿¡æ¯<br />
<code class="highlighter-rouge">-t</code>: å°†srcçš„ä¿®æ”¹æ—¶é—´ï¼ŒåŒæ­¥åˆ°dest<br />
<code class="highlighter-rouge">-g</code>: åŒæ­¥ç»„ä¿¡æ¯(group)<br />
<code class="highlighter-rouge">-o</code>: åŒæ­¥æ‹¥æœ‰è€…ä¿¡æ¯(own)<br />
<code class="highlighter-rouge">-D</code>: ä¿æŒå­—ç¬¦ä¸å—è®¾å¤‡æ–‡ä»¶<br />
<code class="highlighter-rouge">-z</code>: å¯ç”¨å‹ç¼©ä¼ è¾“<br />
<code class="highlighter-rouge">â€“delete</code>ï¼šå¦‚æœsrcæ²¡æœ‰æ­¤æ–‡ä»¶ï¼Œé‚£ä¹ˆdestä¹Ÿä¸èƒ½æœ‰ï¼Œå³åœ¨deståˆ é™¤srcé‡Œæ²¡æœ‰çš„æ–‡ä»¶ã€‚ï¼ˆå¦‚æœä½ ä½¿ç”¨è¿™ä¸ªé€‰é¡¹ï¼Œå°±å¿…é¡»æ­é…-ré€‰é¡¹ä¸€èµ·ï¼‰</p>
</blockquote>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">## å°†æœ¬åœ°/bak/mysqlbak/æ–‡ä»¶åŒæ­¥åˆ° è¿œç¨‹æœåŠ¡å™¨ /bak/mysql/bak ç›®å½•ä¸‹é¢ æ’é™¤ mysqlbak/indexç›®å½• é€šè¿‡sshç«¯å£</span>
rsync <span class="nt">-vzacu</span>  /bak/mysqlbak/  root@192.168.53.86:/bak/mysqlbak   <span class="nt">--exclude</span>  <span class="s2">"mysqlbak/index"</span>   <span class="nt">-e</span> <span class="s2">"ssh -p 22"</span>
<span class="c"># å°†è¿œç¨‹ç›®å½• /bak/mysqlbakä¸‹çš„æ–‡ä»¶åŒæ­¥åˆ°æœ¬åœ° /bak/mysqlbak/ç›®å½•ä¸‹</span>
rsync <span class="nt">-vzrtopg</span> <span class="nt">--progress</span> <span class="nt">--delete</span> root@192.168.53.85:/bak/mysqlbak  /bak
</code></pre></div></div>

<p><strong>å¯ç”¨rsyncæœåŠ¡å™¨ç«¯åŒæ­¥è¿œç¨‹æ–‡ä»¶</strong></p>

<p>rsycnçš„æœåŠ¡ç«¯ä¸ºæœåŠ¡å™¨çš„æ–‡ä»¶æ¥æ”¶ç«¯ï¼Œrsycnçš„å®¢æˆ·ç«¯ä¸ºæœåŠ¡å™¨çš„æ–‡ä»¶æ¨åŠ¨ç«¯ã€‚</p>

<p><strong>rsycnçš„æœåŠ¡ç«¯/æ–‡ä»¶æ¥æ”¶ç«¯é…ç½®</strong></p>

<p>æœåŠ¡ç«¯éœ€è¦å¼€å¯rsyncdæœåŠ¡</p>

<p>æ·»åŠ é…ç½®æ–‡ä»¶rsyncd.conf</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vi /etc/rsyncd.conf
<span class="c">#ä»¥ä¸‹æ˜¯å…¨å±€é…ç½®</span>
log file <span class="o">=</span> /var/log/rsyncd.log
pid file <span class="o">=</span> /var/run/rsyncd.pid
lock file <span class="o">=</span> /var/lock/rsyncd
<span class="o">[</span>mysqlbak]     <span class="c">#æ¨¡å—åï¼Œåœ¨æºæœåŠ¡å™¨æŒ‡å®šè¿™ä¸ªåå­—</span>
   comment <span class="o">=</span> <span class="nb">sync </span>rsync/home      <span class="c">#æè¿°ä¿¡æ¯</span>
   path <span class="o">=</span> /bak/mysqlbak      <span class="c">#å¤‡ä»½ç›®å½•</span>
   use <span class="nb">chroot</span><span class="o">=</span>no           <span class="c">#ä¸ä½¿ç”¨chrootï¼Œä¸ç”¨rootæƒé™</span>
   <span class="nb">read </span>only <span class="o">=</span> no          <span class="c">#è®¾ç½®æœ¬åœ°å¤‡ä»½ç›®å½•ä¸ºè¯»å†™æƒé™</span>
   <span class="nv">uid</span><span class="o">=</span>root          
   <span class="nv">gid</span><span class="o">=</span>root
   max <span class="nv">connections</span><span class="o">=</span>10       <span class="c">#å®¢æˆ·ç«¯æœ€å¤§è¿æ¥æ•°</span>
   auth <span class="nb">users</span> <span class="o">=</span> root      <span class="c">#æŒ‡å®šæ•°æ®åŒæ­¥ç”¨æˆ·</span>
   secrets file <span class="o">=</span> /etc/rsyncd.pass          <span class="c">#æŒ‡å®šæ•°æ®åŒæ­¥ç”¨æˆ·ä¿¡æ¯æ–‡ä»¶</span>
   hosts <span class="nv">allow</span><span class="o">=</span>192.168.53.0/85     <span class="c">#å…è®¸è¿æ¥çš„å®¢æˆ·ç«¯</span>
   ignore errors <span class="o">=</span> <span class="nb">yes</span>     <span class="c">#å¿½ç•¥å‡ºç°I/Oé”™è¯¯</span>
   <span class="nb">timeout</span> <span class="o">=</span> 600
</code></pre></div></div>

<p>åˆ›å»ºè®¤è¯æ–‡ä»¶</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  vi /etc/rsyncd.pass
  <span class="c">##ä»£ç </span>
  root:root      <span class="c">#æ ¼å¼æ˜¯ç”¨æˆ·åï¼šå¯†ç </span>
  <span class="c">#å±ä¸»è¦æœ‰æƒé™è¯»è¿™ä¸ªæ–‡ä»¶ï¼Œå¦åˆ™ä¼šæŠ¥æ²¡æƒé™</span>
  <span class="nb">chmod </span>600 /etc/rsyncd.pass  
</code></pre></div></div>

<p>ä¿®æ”¹/etc/xinetd.d/rsyncæ–‡ä»¶ï¼Œdisable æ”¹ä¸º no</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>service rsync
<span class="o">{</span>
        disable <span class="o">=</span> no
        socket_type     <span class="o">=</span> stream
        <span class="nb">wait</span>            <span class="o">=</span> no
        user            <span class="o">=</span> root
        server          <span class="o">=</span> /usr/bin/rsync
        server_args     <span class="o">=</span> <span class="nt">--daemon</span>
        log_on_failure  +<span class="o">=</span> USERID
<span class="o">}</span>
</code></pre></div></div>

<p>å¯åŠ¨æœåŠ¡ç«¯</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rsync <span class="nt">--daemon</span> <span class="nt">--config</span><span class="o">=</span>/etc/rsyncd.conf
</code></pre></div></div>

<p><strong>rsycnçš„å®¢æˆ·ç«¯/æ–‡ä»¶å‘é€ç«¯é…ç½®</strong></p>

<p>å®¢æˆ·ç«¯é…ç½®ç®€å• åªéœ€è¦é…ç½®å¯†ç æ—¢å¯</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  vi /etc/rsync_client.pwd
  <span class="c">##ä»£ç </span>
  root    <span class="c">#åªéœ€è¦å¡«å†™rsyncæœåŠ¡çš„å¯†ç </span>
  <span class="c">#å±ä¸»è¦æœ‰æƒé™è¯»è¿™ä¸ªæ–‡ä»¶ï¼Œå¦åˆ™ä¼šæŠ¥æ²¡æƒé™</span>
  <span class="nb">chmod </span>600 /etc/rsync_client.pwd 
</code></pre></div></div>

<p>å®¢æˆ·ç«¯åŒæ­¥æµ‹è¯•</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/usr/bin/rsync <span class="nt">-auvrtzopgP</span> <span class="nt">--progress</span> <span class="nt">--password-file</span><span class="o">=</span>/etc/rsync_client.pwd /bak/mysqlbak/ root@192.168.53.86::mysqlbak
</code></pre></div></div>

<blockquote>
  <p><strong>rsyncåªæ˜¯ä¸€æ¬¡æ€§åŒæ­¥,å¦‚æœéœ€è¦å®æ—¶åŒæ­¥å°±éœ€è¦å¼•å…¥å¦ä¸€ä¸ªå·¥å…·äº†</strong></p>
</blockquote>

<h3 id="inotify">inotify</h3>

<p>Inotify æ˜¯ä¸€ç§å¼ºå¤§çš„ã€ç»†ç²’åº¦çš„ã€å¼‚æ­¥çš„æ–‡ä»¶ç³»ç»Ÿäº‹ä»¶ç›‘æ§æœºåˆ¶ï¼Œlinuxå†…æ ¸ä»2.6.13èµ·ï¼ŒåŠ å…¥äº†Inotifyæ”¯æŒï¼Œé€šè¿‡Inotifyå¯ä»¥ç›‘æ§æ–‡ä»¶ç³»ç»Ÿä¸­æ·»åŠ ã€åˆ é™¤ï¼Œä¿®æ”¹ã€ç§»åŠ¨ç­‰å„ç§ç»†å¾®äº‹ä»¶ï¼Œåˆ©ç”¨è¿™ä¸ªå†…æ ¸æ¥å£ï¼Œç¬¬ä¸‰æ–¹è½¯ä»¶å°±å¯ä»¥ç›‘æ§æ–‡ä»¶ç³»ç»Ÿä¸‹æ–‡ä»¶çš„å„ç§å˜åŒ–æƒ…å†µï¼Œè€Œinotify-toolså°±æ˜¯è¿™æ ·çš„ä¸€ä¸ªç¬¬ä¸‰æ–¹è½¯ä»¶ã€‚</p>

<blockquote>
  <p>Inotifyåªéœ€è¦è¦æŒ‰ç…§éƒ¨ç½²åœ¨åŒæ­¥çš„å®¢æˆ·ç«¯ï¼Œå½“ç›‘æ§çš„æ–‡ä»¶æœ‰å˜åŒ–è§¦åŠ¨ rsyncè„šæœ¬æ¥åŒæ­¥</p>
</blockquote>

<p>å®‰è£…</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>yum <span class="nb">install </span>inotify-tools
</code></pre></div></div>

<p>é…ç½®ç›‘æ§çš„æ–‡ä»¶è·¯å¾„</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vi /etc/inotify_exclude.lst
<span class="c">#ä»£ç </span>
/bak/mysqlbak <span class="c">#ç›‘æ§ç›®å½•</span>
@/bak/log <span class="c">#æ’é™¤ç›‘æ§ç›®å½•</span>
</code></pre></div></div>

<p>rsyncæ’é™¤ç›‘æ§æ–‡ä»¶ç›®å½•</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vi /etc/rsyncd.d/rsync_exclude.lst
<span class="c">#ä»£ç </span>
src/<span class="k">*</span>.html<span class="k">*</span>
src/js/
src/2014/20140[1-9]/
</code></pre></div></div>

<p>å®¢æˆ·ç«¯åŒæ­¥åˆ°è¿œç¨‹çš„è„šæœ¬rsync.sh</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#rsync auto sync script with inotify</span>
<span class="c">#variables</span>
<span class="nv">current_date</span><span class="o">=</span><span class="si">$(</span><span class="nb">date</span> +%Y%m%d_%H%M%S<span class="si">)</span>
<span class="nv">source_path</span><span class="o">=</span>/bak/mysqlbak/
<span class="nv">log_file</span><span class="o">=</span>/var/log/rsync_client.log
<span class="c">#rsync</span>
<span class="nv">rsync_server</span><span class="o">=</span>192.168.53.86
<span class="nv">rsync_user</span><span class="o">=</span>root
<span class="nv">rsync_pwd</span><span class="o">=</span>/etc/rsync_client.pwd
<span class="nv">rsync_module</span><span class="o">=</span>mysqlbak
<span class="nv">INOTIFY_EXCLUDE</span><span class="o">=</span><span class="s1">'(.*/*\.log|.*/*\.swp)$|^/tmp/src/mail/(2014|20.*/.*che.*)'</span>
<span class="nv">RSYNC_EXCLUDE</span><span class="o">=</span><span class="s1">'/bak/rsync_exclude.lst'</span>
<span class="c">#rsync client pwd check</span>
<span class="k">if</span> <span class="o">[</span> <span class="o">!</span> <span class="nt">-e</span> <span class="k">${</span><span class="nv">rsync_pwd</span><span class="k">}</span> <span class="o">]</span><span class="p">;</span><span class="k">then
    </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"rsync client passwod file </span><span class="k">${</span><span class="nv">rsync_pwd</span><span class="k">}</span><span class="s2"> does not exist!"</span>
    <span class="nb">exit </span>0
<span class="k">fi</span>
<span class="c">#inotify_function</span>
inotify_fun<span class="o">(){</span>
    /usr/bin/inotifywait <span class="nt">-mrq</span> <span class="nt">--timefmt</span> <span class="s1">'%Y/%m/%d-%H:%M:%S'</span> <span class="nt">--format</span> <span class="s1">'%T %w %f'</span> <span class="se">\</span>
          <span class="nt">--exclude</span> <span class="k">${</span><span class="nv">INOTIFY_EXCLUDE</span><span class="k">}</span>  <span class="nt">-e</span> modify,delete,create,move,attrib <span class="k">${</span><span class="nv">source_path</span><span class="k">}</span> <span class="se">\</span>
          | <span class="k">while </span><span class="nb">read </span>file
      <span class="k">do</span>
          /usr/bin/rsync <span class="nt">-auvrtzopgP</span> <span class="nt">--exclude-from</span><span class="o">=</span><span class="k">${</span><span class="nv">RSYNC_EXCLUDE</span><span class="k">}</span> <span class="nt">--progress</span> <span class="nt">--bwlimit</span><span class="o">=</span>200 <span class="nt">--password-file</span><span class="o">=</span><span class="k">${</span><span class="nv">rsync_pwd</span><span class="k">}</span> <span class="k">${</span><span class="nv">source_path</span><span class="k">}</span> <span class="k">${</span><span class="nv">rsync_user</span><span class="k">}</span>@<span class="k">${</span><span class="nv">rsync_server</span><span class="k">}</span>::<span class="k">${</span><span class="nv">rsync_module</span><span class="k">}</span> 
      <span class="k">done</span>
<span class="o">}</span>
<span class="c">#inotify log</span>
inotify_fun <span class="o">&gt;&gt;</span> <span class="k">${</span><span class="nv">log_file</span><span class="k">}</span> 2&gt;&amp;1 &amp;
</code></pre></div></div>

<p>ç»™è„šæœ¬æ‰§è¡Œæƒé™ï¼Œæ‰§è¡Œåå°±å¯ä»¥äº†</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">chmod </span>777 rsync.sh
./rsync.sh 
</code></pre></div></div>

<h2 id="å‚è€ƒ">å‚è€ƒï¼š</h2>

<p><a href="http://seanlook.com/2014/12/12/rsync_inotify_setup/">Linuxä¸‹åŒæ­¥å·¥å…·inotify+rsyncä½¿ç”¨è¯¦è§£</a></p>

<hr />

<p><strong>ä½œè€…ï¼šçº¯æ´çš„å¾®ç¬‘</strong><br />
<strong>å‡ºå¤„ï¼š<a href="http://www.ityouknow.com">www.ityouknow.com</a></strong> <br />
<strong>ç‰ˆæƒæ‰€æœ‰ï¼Œæ¬¢è¿ä¿ç•™åŸæ–‡é“¾æ¥è¿›è¡Œè½¬è½½ :)</strong></p>
:ET