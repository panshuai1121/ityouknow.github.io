I"Õx<p>è¿™ç¯‡æ–‡ä»¶ä»‹ç»å¦‚ä½•åŠ¨æ€çš„æ·»åŠ ã€ä¸‹æ¶mongodåˆ†ç‰‡å’Œå‰¯æœ¬é›†ï¼Œä»¥åŠå¦‚ä½•ç›‘æ§å’Œè¿ç»´mongodbã€‚</p>

<h2 id="æ·»åŠ èŠ‚ç‚¹">æ·»åŠ èŠ‚ç‚¹</h2>

<h3 id="å‰¯æœ¬é›†-æ”¹ä¸ºä»²è£èŠ‚ç‚¹">å‰¯æœ¬é›† æ”¹ä¸ºä»²è£èŠ‚ç‚¹</h3>

<p><a href="https://docs.mongodb.com/manual/tutorial/convert-secondary-into-arbiter/">convert-secondary-into-arbiter</a></p>

<p>ç™»å½•</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mongo 192.168.0.35:27005
<span class="c">#ä½¿ç”¨adminæ•°æ®åº“</span>
use admin
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#æŸ¥çœ‹åˆ†åŒºçŠ¶æ€</span>
rs.status<span class="o">()</span><span class="p">;</span>
</code></pre></div></div>

<p>ç§»é™¤å‰¯æœ¬é›†</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rs.remove<span class="o">(</span><span class="s2">"192.168.0.35:27005"</span><span class="o">)</span>
</code></pre></div></div>

<p>æŸ¥çœ‹é…ç½®</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rs.conf<span class="o">()</span>
</code></pre></div></div>

<p>åˆ é™¤shard5çš„æ•°æ®ç›®å½•ï¼Œé‡å¯shard5</p>

<p>é‡æ–°æ·»åŠ ä»²è£èŠ‚ç‚¹</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rs.addArb<span class="o">(</span><span class="s2">"192.168.0.35:27005"</span><span class="o">)</span>
</code></pre></div></div>

<p>æŸ¥çœ‹é…ç½®</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rs.conf<span class="o">()</span>
</code></pre></div></div>

<h3 id="ä»²è£èŠ‚ç‚¹æ”¹æˆå‰¯æœ¬é›†">ä»²è£èŠ‚ç‚¹æ”¹æˆå‰¯æœ¬é›†</h3>

<p><a href="https://docs.mongodb.com/manual/tutorial/expand-replica-set/">Add Members to a Replica Set</a></p>

<p>ç§»é™¤ä»²è£èŠ‚ç‚¹</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rs.remove<span class="o">(</span><span class="s2">"192.168.0.35:27005"</span><span class="o">)</span>
</code></pre></div></div>

<p>åˆ é™¤æ€»è£èŠ‚ç‚¹çš„æ•°æ®ï¼Œå¹¶é‡å¯</p>

<p>åœ¨ primary æ·»åŠ å‰¯æœ¬èŠ‚ç‚¹</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rs.add<span class="o">(</span><span class="s2">"192.168.0.35:27005"</span><span class="o">)</span>
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rs.conf<span class="o">()</span>
rs.status<span class="o">()</span><span class="p">;</span>
</code></pre></div></div>

<p>åˆšæ·»åŠ çš„å‰¯æœ¬é›†çŠ¶æ€ä¸ºï¼šSTARTUP2</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s2">"stateStr"</span> : <span class="s2">"STARTUP2"</span>,
</code></pre></div></div>

<h2 id="é›†ç¾¤ä¸­æ·»åŠ åˆ†ç‰‡">é›†ç¾¤ä¸­æ·»åŠ åˆ†ç‰‡</h2>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mongo 192.168.0.31:20000
<span class="c">#ä½¿ç”¨adminæ•°æ®åº“</span>
use  admin
<span class="c">#æ·»åŠ åˆ†ç‰‡</span>
sh.addShard<span class="o">(</span><span class="s2">"shard5/192.168.0.35:27005,192.168.0.31:27005,192.168.0.32:27005"</span><span class="o">)</span>
<span class="c">#æŸ¥çœ‹é›†ç¾¤çŠ¶æ€</span>
sh.status<span class="o">()</span>
</code></pre></div></div>

<h2 id="ç›‘æ§">ç›‘æ§</h2>

<h3 id="mongostat">mongostat</h3>

<p>mongostatæ˜¯mongdbè‡ªå¸¦çš„çŠ¶æ€æ£€æµ‹å·¥å…·ï¼Œåœ¨å‘½ä»¤è¡Œä¸‹ä½¿ç”¨ã€‚å®ƒä¼šé—´éš”å›ºå®šæ—¶é—´è·å–mongodbçš„å½“å‰è¿è¡ŒçŠ¶æ€ï¼Œå¹¶è¾“å‡ºã€‚å¦‚æœä½ å‘ç°æ•°æ®åº“çªç„¶å˜æ…¢æˆ–è€…æœ‰å…¶ä»–é—®é¢˜çš„è¯ï¼Œä½ ç¬¬ä¸€æ‰‹çš„æ“ä½œå°±è€ƒè™‘é‡‡ç”¨mongostatæ¥æŸ¥çœ‹mongoçš„çŠ¶æ€ã€‚</p>

<p>å®ƒçš„è¾“å‡ºæœ‰ä»¥ä¸‹å‡ åˆ—ï¼š</p>

<ul>
  <li>inserts/s æ¯ç§’æ’å…¥æ¬¡æ•°</li>
  <li>query/s æ¯ç§’æŸ¥è¯¢æ¬¡æ•°</li>
  <li>update/s æ¯ç§’æ›´æ–°æ¬¡æ•°</li>
  <li>delete/s æ¯ç§’åˆ é™¤æ¬¡æ•°</li>
  <li>getmore/s æ¯ç§’æ‰§è¡Œgetmoreæ¬¡æ•°</li>
  <li>command/s æ¯ç§’çš„å‘½ä»¤æ•°ï¼Œæ¯”ä»¥ä¸Šæ’å…¥ã€æŸ¥æ‰¾ã€æ›´æ–°ã€åˆ é™¤çš„ç»¼åˆè¿˜å¤šï¼Œè¿˜ç»Ÿè®¡äº†åˆ«çš„å‘½ä»¤</li>
  <li>flushs/s æ¯ç§’æ‰§è¡Œfsyncå°†æ•°æ®å†™å…¥ç¡¬ç›˜çš„æ¬¡æ•°ã€‚</li>
  <li>mapped/s æ‰€æœ‰çš„è¢«mmapçš„æ•°æ®é‡ï¼Œå•ä½æ˜¯MBï¼Œ</li>
  <li>vsize è™šæ‹Ÿå†…å­˜ä½¿ç”¨é‡ï¼Œå•ä½MB</li>
  <li>res ç‰©ç†å†…å­˜ä½¿ç”¨é‡ï¼Œå•ä½MB</li>
  <li>faults/s æ¯ç§’è®¿é—®å¤±è´¥æ•°ï¼ˆåªæœ‰Linuxæœ‰ï¼‰ï¼Œæ•°æ®è¢«äº¤æ¢å‡ºç‰©ç†å†…å­˜ï¼Œæ”¾åˆ°swapã€‚ä¸è¦è¶…è¿‡100ï¼Œå¦åˆ™å°±æ˜¯æœºå™¨å†…å­˜å¤ªå°ï¼Œé€ æˆé¢‘ç¹swapå†™å…¥ã€‚æ­¤æ—¶è¦å‡çº§å†…å­˜æˆ–è€…æ‰©å±•</li>
  <li>locked % è¢«é”çš„æ—¶é—´ç™¾åˆ†æ¯”ï¼Œå°½é‡æ§åˆ¶åœ¨50%ä»¥ä¸‹å§</li>
  <li>idx miss % ç´¢å¼•ä¸å‘½ä¸­æ‰€å ç™¾åˆ†æ¯”ã€‚å¦‚æœå¤ªé«˜çš„è¯å°±è¦è€ƒè™‘ç´¢å¼•æ˜¯ä¸æ˜¯å°‘äº†</li>
  <li><code class="highlighter-rouge">q t|r|w</code> å½“Mongodbæ¥æ”¶åˆ°å¤ªå¤šçš„å‘½ä»¤è€Œæ•°æ®åº“è¢«é”ä½æ— æ³•æ‰§è¡Œå®Œæˆï¼Œå®ƒä¼šå°†å‘½ä»¤åŠ å…¥é˜Ÿåˆ—ã€‚è¿™ä¸€æ æ˜¾ç¤ºäº†æ€»å…±ã€è¯»ã€å†™3ä¸ªé˜Ÿåˆ—çš„é•¿åº¦ï¼Œéƒ½ä¸º0çš„è¯è¡¨ç¤ºmongoæ¯«æ— å‹åŠ›ã€‚é«˜å¹¶å‘æ—¶ï¼Œä¸€èˆ¬é˜Ÿåˆ—å€¼ä¼šå‡é«˜ã€‚</li>
  <li>conn å½“å‰è¿æ¥æ•°</li>
  <li>time æ—¶é—´æˆ³</li>
</ul>

<p>ç¤ºä¾‹ï¼š</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mongostat <span class="nt">-h</span> 192.168.0.31:27001
<span class="c">##è¿”å›ç»“æœ</span>
insert query update delete getmore <span class="nb">command </span>dirty  used flushes vsize   res qrw arw net_in net_out conn    <span class="nb">set </span>repl                <span class="nb">time
   </span>576    <span class="k">*</span>0     <span class="k">*</span>0     <span class="k">*</span>0     455  1370|0  2.7% 64.0%       0 15.8G 13.9G 0|1 0|0  1.82m   1.44m   77 shard1  PRI Aug 23 17:05:25.495
   514    <span class="k">*</span>0     <span class="k">*</span>0     <span class="k">*</span>0     446  1336|0  2.7% 64.0%       0 15.8G 13.9G 0|1 0|0  1.71m   1.29m   77 shard1  PRI Aug 23 17:05:26.495
   499    <span class="k">*</span>0     <span class="k">*</span>0     <span class="k">*</span>0     461  1310|0  2.7% 64.0%       0 15.8G 13.9G 0|0 1|0  1.68m   1.27m   77 shard1  PRI Aug 23 17:05:27.495
   485    <span class="k">*</span>0     <span class="k">*</span>0     <span class="k">*</span>0     442  1285|0  2.7% 64.0%       0 15.8G 13.9G 0|0 0|1  1.64m   1.24m   77 shard1  PRI Aug 23 17:05:28.496
   498    <span class="k">*</span>0     <span class="k">*</span>0     <span class="k">*</span>0     444  1317|0  2.7% 64.0%       0 15.8G 13.9G 0|0 0|0  1.68m   1.26m   77 shard1  PRI Aug 23 17:05:29.494
   477    <span class="k">*</span>0     <span class="k">*</span>0     <span class="k">*</span>0     445  1272|0  2.7% 64.0%       0 15.8G 13.9G 0|0 0|0  1.61m   1.22m   77 shard1  PRI Aug 23 17:05:30.494
</code></pre></div></div>

<p>mongostaté—´éš”æ—¶é—´åˆ·æ–°mongodbåˆ†ç‰‡çš„å„é¡¹æ“ä½œã€‚</p>

<h2 id="mongotop">mongotop</h2>

<p>mongotopç”¨æ¥è·Ÿè¸ªMongoDBçš„å®ä¾‹ï¼Œ æä¾›æ¯ä¸ªé›†åˆçš„ç»Ÿè®¡æ•°æ®ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œmongotopæ¯ä¸€ç§’åˆ·æ–°ä¸€æ¬¡ã€‚
mongotopç”¨æ³•ï¼š</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mongotop <span class="nt">-h</span> 192.168.0.31:27001 10
</code></pre></div></div>

<p>åé¢çš„10æ˜¯<sleeptime>å‚æ•° ï¼Œå¯ä»¥ä¸ä½¿ç”¨ï¼Œç­‰å¾…çš„æ—¶é—´é•¿åº¦ï¼Œä»¥ç§’ä¸ºå•ä½ï¼Œmongotopç­‰å¾…è°ƒç”¨ä¹‹é—´ã€‚é€šè¿‡çš„é»˜è®¤mongotopè¿”å›æ•°æ®çš„æ¯ä¸€ç§’ã€‚</sleeptime></p>

<p>mongotop â€“locks
æŠ¥å‘Šæ¯ä¸ªæ•°æ®åº“çš„é”çš„ä½¿ç”¨ä¸­ï¼Œä½¿ç”¨mongotop - é”ï¼Œè¿™å°†äº§ç”Ÿä»¥ä¸‹è¾“å‡ºï¼š</p>

<p>ç»“æœå­—æ®µä»‹ç»ï¼š
nsï¼šåŒ…å«æ•°æ®åº“å‘½åç©ºé—´ï¼Œåè€…ç»“åˆäº†æ•°æ®åº“åç§°å’Œé›†åˆã€‚
dbï¼šåŒ…å«æ•°æ®åº“çš„åç§°ã€‚åä¸º . çš„æ•°æ®åº“é’ˆå¯¹å…¨å±€é”å®šï¼Œè€Œéç‰¹å®šæ•°æ®åº“ã€‚
totalï¼šmongodèŠ±è´¹çš„æ—¶é—´å·¥ä½œåœ¨è¿™ä¸ªå‘½åç©ºé—´æä¾›æ€»é¢ã€‚
readï¼šæä¾›äº†å¤§é‡çš„æ—¶é—´ï¼Œè¿™mongodèŠ±è´¹åœ¨æ‰§è¡Œè¯»æ“ä½œï¼Œåœ¨æ­¤å‘½åç©ºé—´ã€‚
writeï¼šæä¾›è¿™ä¸ªå‘½åç©ºé—´è¿›è¡Œå†™æ“ä½œï¼Œè¿™mongodèŠ±äº†å¤§é‡çš„æ—¶é—´ã€‚</p>

<h3 id="profiler">profiler</h3>

<p>ç±»ä¼¼äºMySQLçš„slow log, MongoDBå¯ä»¥ç›‘æ§æ‰€æœ‰æ…¢çš„ä»¥åŠä¸æ…¢çš„æŸ¥è¯¢ã€‚</p>

<p>Profileré»˜è®¤æ˜¯å…³é—­çš„ï¼Œä½ å¯ä»¥é€‰æ‹©å…¨éƒ¨å¼€å¯ï¼Œæˆ–è€…æœ‰æ…¢æŸ¥è¯¢çš„æ—¶å€™å¼€å¯ã€‚</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> use <span class="nb">test
</span>switched to db <span class="nb">test</span>
<span class="o">&gt;</span> db.setProfilingLevel<span class="o">(</span>2<span class="o">)</span><span class="p">;</span>
<span class="o">{</span><span class="s2">"was"</span> : 0 , <span class="s2">"slowms"</span> : 100, <span class="s2">"ok"</span> : 1<span class="o">}</span> // <span class="s2">"was"</span> is the old setting
<span class="o">&gt;</span> db.getProfilingLevel<span class="o">()</span>
</code></pre></div></div>

<p>æŸ¥çœ‹Profileæ—¥å¿—</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> db.system.profile.find<span class="o">()</span>.sort<span class="o">({</span><span class="nv">$natural</span>:-1<span class="o">})</span>
<span class="o">{</span><span class="s2">"ts"</span> : <span class="s2">"Thu Jan 29 2009 15:19:32 GMT-0500 (EST)"</span> , <span class="s2">"info"</span> :
<span class="s2">"query test.</span><span class="nv">$cmd</span><span class="s2"> ntoreturn:1 reslen:66 nscanned:0 query: { profile: 2 } nreturned:1 bytes:50"</span> ,
<span class="s2">"millis"</span> : 0<span class="o">}</span> ...
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#æŸ¥çœ‹ç³»ç»Ÿä¸­çš„æ…¢æŸ¥è¯¢æ•°é‡</span>
db.system.profile.count<span class="o">()</span><span class="p">;</span>
</code></pre></div></div>

<p>3ä¸ªå­—æ®µçš„æ„ä¹‰</p>

<ul>
  <li>tsï¼šæ—¶é—´æˆ³</li>
  <li>infoï¼šå…·ä½“çš„æ“ä½œ</li>
  <li>millisï¼šæ“ä½œæ‰€èŠ±æ—¶é—´ï¼Œæ¯«ç§’</li>
</ul>

<p>å‚è€ƒï¼š<a href="https://docs.mongodb.com/manual/tutorial/manage-the-database-profiler/">Database Profiler</a></p>

<p>æ³¨æ„ï¼Œé€ æˆæ»¡æŸ¥è¯¢å¯èƒ½æ˜¯ç´¢å¼•çš„é—®é¢˜ï¼Œä¹Ÿå¯èƒ½æ˜¯æ•°æ®ä¸åœ¨å†…å­˜é€ æˆå› æ­¤ç£ç›˜è¯»å…¥é€ æˆã€‚</p>

<h3 id="dbserverstatus">db.serverStatus()</h3>

<p>db.serverStatus()</p>

<p>è·å–æœåŠ¡å™¨çš„çŠ¶æ€</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">{</span>
        <span class="s2">"host"</span> : <span class="s2">"mongodb31.hkrt.cn:20000"</span>,
        <span class="s2">"version"</span> : <span class="s2">"3.4.6"</span>,
        <span class="s2">"process"</span> : <span class="s2">"mongos"</span>,
        <span class="s2">"pid"</span> : NumberLong<span class="o">(</span>1940<span class="o">)</span>,
        <span class="s2">"uptime"</span> : 67854,
        <span class="s2">"uptimeMillis"</span> : NumberLong<span class="o">(</span>67853593<span class="o">)</span>,
        <span class="s2">"uptimeEstimate"</span> : NumberLong<span class="o">(</span>67853<span class="o">)</span>,
        <span class="s2">"localTime"</span> : ISODate<span class="o">(</span><span class="s2">"2017-08-23T09:39:55.400Z"</span><span class="o">)</span>,
        <span class="s2">"asserts"</span> : <span class="o">{</span>
                <span class="s2">"regular"</span> : 0,
                <span class="s2">"warning"</span> : 0,
                <span class="s2">"msg"</span> : 0,
                <span class="s2">"user"</span> : 7048,
                <span class="s2">"rollovers"</span> : 0
        <span class="o">}</span>,
        <span class="s2">"connections"</span> : <span class="o">{</span>
                <span class="s2">"current"</span> : 56,
                <span class="s2">"available"</span> : 52372,
                <span class="s2">"totalCreated"</span> : 523
        <span class="o">}</span>,
        <span class="s2">"extra_info"</span> : <span class="o">{</span>
                <span class="s2">"note"</span> : <span class="s2">"fields vary by platform"</span>,
                <span class="s2">"page_faults"</span> : 3
        <span class="o">}</span>,
        <span class="s2">"network"</span> : <span class="o">{</span>
                <span class="s2">"bytesIn"</span> : NumberLong<span class="o">(</span><span class="s2">"102972729600"</span><span class="o">)</span>,
                <span class="s2">"bytesOut"</span> : NumberLong<span class="o">(</span><span class="s2">"7551683898"</span><span class="o">)</span>,
                <span class="s2">"physicalBytesIn"</span> : NumberLong<span class="o">(</span><span class="s2">"102972729600"</span><span class="o">)</span>,
                <span class="s2">"physicalBytesOut"</span> : NumberLong<span class="o">(</span><span class="s2">"7551683898"</span><span class="o">)</span>,
                <span class="s2">"numRequests"</span> : NumberLong<span class="o">(</span>210803831<span class="o">)</span>
        <span class="o">}</span>,
        <span class="s2">"opcounters"</span> : <span class="o">{</span>
                <span class="s2">"insert"</span> : 79028505,
                <span class="s2">"query"</span> : 26334341,
                <span class="s2">"update"</span> : 0,
                <span class="s2">"delete"</span> : 4,
                <span class="s2">"getmore"</span> : 0,
                <span class="s2">"command"</span> : 79067537
        <span class="o">}</span>,
        <span class="s2">"sharding"</span> : <span class="o">{</span>
                <span class="s2">"configsvrConnectionString"</span> : <span class="s2">"config/192.168.0.33:21000,192.168.0.34:21000,192.168.0.35:21000"</span>,
                <span class="s2">"lastSeenConfigServerOpTime"</span> : <span class="o">{</span>
                        <span class="s2">"ts"</span> : Timestamp<span class="o">(</span>1503481193, 1<span class="o">)</span>,
                        <span class="s2">"t"</span> : NumberLong<span class="o">(</span>1<span class="o">)</span>
                <span class="o">}</span>
        <span class="o">}</span>,
        <span class="s2">"tcmalloc"</span> : <span class="o">{</span>
                <span class="s2">"generic"</span> : <span class="o">{</span>
                        <span class="s2">"current_allocated_bytes"</span> : 3643648,
                        <span class="s2">"heap_size"</span> : 40898560
                <span class="o">}</span>,
                <span class="s2">"tcmalloc"</span> : <span class="o">{</span>
                        <span class="s2">"pageheap_free_bytes"</span> : 36864,
                        <span class="s2">"pageheap_unmapped_bytes"</span> : 24522752,
                        <span class="s2">"max_total_thread_cache_bytes"</span> : NumberLong<span class="o">(</span>1073741824<span class="o">)</span>,
                        <span class="s2">"current_total_thread_cache_bytes"</span> : 4660344,
                        <span class="s2">"total_free_bytes"</span> : 12695296,
                        <span class="s2">"central_cache_free_bytes"</span> : 2833608,
                        <span class="s2">"transfer_cache_free_bytes"</span> : 5201344,
                        <span class="s2">"thread_cache_free_bytes"</span> : 4660344,
                        <span class="s2">"aggressive_memory_decommit"</span> : 0,
                        <span class="s2">"formattedString"</span> : <span class="s2">"------------------------------------------------</span><span class="se">\n</span><span class="s2">MALLOC:        3643648 (    3.5 MiB) Bytes in use by application</span><span class="se">\n</span><span class="s2">MALLOC: +        36864 (    0.0 MiB) Bytes in page heap freelist</span><span class="se">\n</span><span class="s2">MALLOC: +      2833608 (    2.7 MiB) Bytes in central cache freelist</span><span class="se">\n</span><span class="s2">MALLOC: +      5201344 (    5.0 MiB) Bytes in transfer cache freelist</span><span class="se">\n</span><span class="s2">MALLOC: +      4660344 (    4.4 MiB) Bytes in thread cache freelists</span><span class="se">\n</span><span class="s2">MALLOC: +      1401024 (    1.3 MiB) Bytes in malloc metadata</span><span class="se">\n</span><span class="s2">MALLOC:   ------------</span><span class="se">\n</span><span class="s2">MALLOC: =     17776832 (   17.0 MiB) Actual memory used (physical + swap)</span><span class="se">\n</span><span class="s2">MALLOC: +     24522752 (   23.4 MiB) Bytes released to OS (aka unmapped)</span><span class="se">\n</span><span class="s2">MALLOC:   ------------</span><span class="se">\n</span><span class="s2">MALLOC: =     42299584 (   40.3 MiB) Virtual address space used</span><span class="se">\n</span><span class="s2">MALLOC:</span><span class="se">\n</span><span class="s2">MALLOC:           1936              Spans in use</span><span class="se">\n</span><span class="s2">MALLOC:            109              Thread heaps in use</span><span class="se">\n</span><span class="s2">MALLOC:           4096              Tcmalloc page size</span><span class="se">\n</span><span class="s2">------------------------------------------------</span><span class="se">\n</span><span class="s2">Call ReleaseFreeMemory() to release freelist memory to the OS (via madvise()).</span><span class="se">\n</span><span class="s2">Bytes released to the OS take up virtual address space but no physical memory.</span><span class="se">\n</span><span class="s2">"</span>
                <span class="o">}</span>
        <span class="o">}</span>,
        <span class="s2">"mem"</span> : <span class="o">{</span>
                <span class="s2">"bits"</span> : 64,
                <span class="s2">"resident"</span> : 24,
                <span class="s2">"virtual"</span> : 689,
                <span class="s2">"supported"</span> : <span class="nb">true</span>
        <span class="o">}</span>,
        <span class="s2">"metrics"</span> : <span class="o">{</span>
                <span class="s2">"cursor"</span> : <span class="o">{</span>
                        <span class="s2">"timedOut"</span> : NumberLong<span class="o">(</span>21<span class="o">)</span>,
                        <span class="s2">"open"</span> : <span class="o">{</span>
                                <span class="s2">"multiTarget"</span> : NumberLong<span class="o">(</span>0<span class="o">)</span>,
                                <span class="s2">"singleTarget"</span> : NumberLong<span class="o">(</span>0<span class="o">)</span>,
                                <span class="s2">"pinned"</span> : NumberLong<span class="o">(</span>0<span class="o">)</span>,
                                <span class="s2">"total"</span> : NumberLong<span class="o">(</span>0<span class="o">)</span>
                        <span class="o">}</span>
                <span class="o">}</span>,
                <span class="s2">"commands"</span> : <span class="o">{</span>
                        <span class="s2">"aggregate"</span> : <span class="o">{</span>
                                <span class="s2">"failed"</span> : NumberLong<span class="o">(</span>1<span class="o">)</span>,
                                <span class="s2">"total"</span> : NumberLong<span class="o">(</span>16<span class="o">)</span>
                        <span class="o">}</span>,
                        <span class="s2">"balancerStatus"</span> : <span class="o">{</span>
                                <span class="s2">"failed"</span> : NumberLong<span class="o">(</span>0<span class="o">)</span>,
                                <span class="s2">"total"</span> : NumberLong<span class="o">(</span>2<span class="o">)</span>
                        <span class="o">}</span>,
                        <span class="s2">"buildInfo"</span> : <span class="o">{</span>
                                <span class="s2">"failed"</span> : NumberLong<span class="o">(</span>0<span class="o">)</span>,
                                <span class="s2">"total"</span> : NumberLong<span class="o">(</span>519<span class="o">)</span>
                        <span class="o">}</span>,
                        <span class="s2">"collStats"</span> : <span class="o">{</span>
                                <span class="s2">"failed"</span> : NumberLong<span class="o">(</span>1<span class="o">)</span>,
                                <span class="s2">"total"</span> : NumberLong<span class="o">(</span>97<span class="o">)</span>
                        <span class="o">}</span>,
                        <span class="s2">"count"</span> : <span class="o">{</span>
                                <span class="s2">"failed"</span> : NumberLong<span class="o">(</span>0<span class="o">)</span>,
                                <span class="s2">"total"</span> : NumberLong<span class="o">(</span>12<span class="o">)</span>
                        <span class="o">}</span>,
                        <span class="s2">"createIndexes"</span> : <span class="o">{</span>
                                <span class="s2">"failed"</span> : NumberLong<span class="o">(</span>0<span class="o">)</span>,
                                <span class="s2">"total"</span> : NumberLong<span class="o">(</span>4<span class="o">)</span>
                        <span class="o">}</span>,
                        <span class="s2">"currentOp"</span> : <span class="o">{</span>
                                <span class="s2">"failed"</span> : NumberLong<span class="o">(</span>0<span class="o">)</span>,
                                <span class="s2">"total"</span> : NumberLong<span class="o">(</span>2<span class="o">)</span>
                        <span class="o">}</span>,
                        <span class="s2">"dbStats"</span> : <span class="o">{</span>
                                <span class="s2">"failed"</span> : NumberLong<span class="o">(</span>0<span class="o">)</span>,
                                <span class="s2">"total"</span> : NumberLong<span class="o">(</span>4<span class="o">)</span>
                        <span class="o">}</span>,
                        <span class="s2">"delete"</span> : <span class="o">{</span>
                                <span class="s2">"failed"</span> : NumberLong<span class="o">(</span>0<span class="o">)</span>,
                                <span class="s2">"total"</span> : NumberLong<span class="o">(</span>4<span class="o">)</span>
                        <span class="o">}</span>,
                        <span class="s2">"drop"</span> : <span class="o">{</span>
                                <span class="s2">"failed"</span> : NumberLong<span class="o">(</span>0<span class="o">)</span>,
                                <span class="s2">"total"</span> : NumberLong<span class="o">(</span>7<span class="o">)</span>
                        <span class="o">}</span>,
                        <span class="s2">"dropDatabase"</span> : <span class="o">{</span>
                                <span class="s2">"failed"</span> : NumberLong<span class="o">(</span>0<span class="o">)</span>,
                                <span class="s2">"total"</span> : NumberLong<span class="o">(</span>2<span class="o">)</span>
                        <span class="o">}</span>,
                        <span class="s2">"find"</span> : <span class="o">{</span>
                                <span class="s2">"failed"</span> : NumberLong<span class="o">(</span>2<span class="o">)</span>,
                                <span class="s2">"total"</span> : NumberLong<span class="o">(</span>26334294<span class="o">)</span>
                        <span class="o">}</span>,
                        <span class="s2">"getLastError"</span> : <span class="o">{</span>
                                <span class="s2">"failed"</span> : NumberLong<span class="o">(</span>0<span class="o">)</span>,
                                <span class="s2">"total"</span> : NumberLong<span class="o">(</span>252<span class="o">)</span>
                        <span class="o">}</span>,
                        <span class="s2">"getLog"</span> : <span class="o">{</span>
                                <span class="s2">"failed"</span> : NumberLong<span class="o">(</span>0<span class="o">)</span>,
                                <span class="s2">"total"</span> : NumberLong<span class="o">(</span>6<span class="o">)</span>
                        <span class="o">}</span>,
                        <span class="s2">"insert"</span> : <span class="o">{</span>
                                <span class="s2">"failed"</span> : NumberLong<span class="o">(</span>0<span class="o">)</span>,
                                <span class="s2">"total"</span> : NumberLong<span class="o">(</span>79028505<span class="o">)</span>
                        <span class="o">}</span>,
                        <span class="s2">"isMaster"</span> : <span class="o">{</span>
                                <span class="s2">"failed"</span> : NumberLong<span class="o">(</span>0<span class="o">)</span>,
                                <span class="s2">"total"</span> : NumberLong<span class="o">(</span>24048<span class="o">)</span>
                        <span class="o">}</span>,
                        <span class="s2">"listCollections"</span> : <span class="o">{</span>
                                <span class="s2">"failed"</span> : NumberLong<span class="o">(</span>0<span class="o">)</span>,
                                <span class="s2">"total"</span> : NumberLong<span class="o">(</span>44<span class="o">)</span>
                        <span class="o">}</span>,
                        <span class="s2">"listDatabases"</span> : <span class="o">{</span>
                                <span class="s2">"failed"</span> : NumberLong<span class="o">(</span>1<span class="o">)</span>,
                                <span class="s2">"total"</span> : NumberLong<span class="o">(</span>135<span class="o">)</span>
                        <span class="o">}</span>,
                        <span class="s2">"ping"</span> : <span class="o">{</span>
                                <span class="s2">"failed"</span> : NumberLong<span class="o">(</span>0<span class="o">)</span>,
                                <span class="s2">"total"</span> : NumberLong<span class="o">(</span>13575<span class="o">)</span>
                        <span class="o">}</span>,
                        <span class="s2">"profile"</span> : <span class="o">{</span>
                                <span class="s2">"failed"</span> : NumberLong<span class="o">(</span>3<span class="o">)</span>,
                                <span class="s2">"total"</span> : NumberLong<span class="o">(</span>3<span class="o">)</span>
                        <span class="o">}</span>,
                        <span class="s2">"replSetGetStatus"</span> : <span class="o">{</span>
                                <span class="s2">"failed"</span> : NumberLong<span class="o">(</span>34<span class="o">)</span>,
                                <span class="s2">"total"</span> : NumberLong<span class="o">(</span>34<span class="o">)</span>
                        <span class="o">}</span>,
                        <span class="s2">"serverStatus"</span> : <span class="o">{</span>
                                <span class="s2">"failed"</span> : NumberLong<span class="o">(</span>0<span class="o">)</span>,
                                <span class="s2">"total"</span> : NumberLong<span class="o">(</span>131<span class="o">)</span>
                        <span class="o">}</span>,
                        <span class="s2">"whatsmyuri"</span> : <span class="o">{</span>
                                <span class="s2">"failed"</span> : NumberLong<span class="o">(</span>0<span class="o">)</span>,
                                <span class="s2">"total"</span> : NumberLong<span class="o">(</span>135<span class="o">)</span>
                        <span class="o">}</span>
                <span class="o">}</span>
        <span class="o">}</span>,
        <span class="s2">"ok"</span> : 1
<span class="o">}</span>
</code></pre></div></div>

<p>éœ€è¦å…³å¿ƒçš„åœ°æ–¹ï¼š</p>

<ul>
  <li>connections å½“å‰è¿æ¥å’Œå¯ç”¨è¿æ¥æ•°ï¼Œå¬è¿‡ä¸€ä¸ªåŒè¡Œä»‹ç»è¿‡ï¼Œmongodbæœ€å¤§å¤„ç†åˆ°2000ä¸ªè¿æ¥å°±ä¸è¡Œäº†ï¼ˆè¦æ ¹æ®ä½ çš„æœºå™¨æ€§èƒ½å’Œä¸šåŠ¡æ¥è®¾å®šï¼‰ï¼Œæ‰€ä»¥è®¾å¤§äº†æ²¡æ„ä¹‰ã€‚è®¾ä¸ªåˆç†å€¼çš„è¯ï¼Œåˆ°è¾¾è¿™ä¸ªå€¼mongodbå°±æ‹’ç»æ–°çš„è¿æ¥è¯·æ±‚ï¼Œé¿å…è¢«å¤ªå¤šçš„è¿æ¥æ‹–å®ã€‚</li>
  <li>indexCounters:btree:misses ç´¢å¼•çš„ä¸å‘½ä¸­æ•°ï¼Œå’Œhitsçš„æ¯”ä¾‹é«˜å°±è¦è€ƒè™‘ç´¢å¼•æ˜¯å¦æ­£ç¡®å»ºç«‹ã€‚ä½ çœ‹æˆ‘çš„â€missRatioâ€3.543930204420982e-7ï¼Œå¾ˆå¥åº·å§ã€‚æ‰€ä»¥missç‡åœ¨mongostaté‡Œé¢ä¹Ÿå¯ä»¥çœ‹</li>
  <li>å…¶ä»–çš„éƒ½èƒ½è‡ªè§£é‡Šï¼Œä¹Ÿä¸æ˜¯æŸ¥çœ‹mongoå¥åº·çŠ¶å†µçš„å…³é”®ï¼Œå°±ä¸è¯´æ˜äº†ã€‚</li>
</ul>

<p>è¯¦ç»†çš„è§£é‡Šå‚è€ƒè¿™é‡Œï¼š<a href="https://docs.mongodb.com/manual/reference/command/serverStatus/#dbcmd.serverStatus">serverStatus</a></p>

<h3 id="dbcurrentop">db.currentOp()</h3>

<p>Mongodb çš„å‘½ä»¤ä¸€èˆ¬å¾ˆå¿«å°±å®Œæˆï¼Œä½†æ˜¯åœ¨ä¸€å°ç¹å¿™çš„æœºå™¨æˆ–è€…æœ‰æ¯”è¾ƒæ…¢çš„å‘½ä»¤æ—¶ï¼Œä½ å¯ä»¥é€šè¿‡db.currentOp()è·å–å½“å‰æ­£åœ¨æ‰§è¡Œçš„æ“ä½œã€‚</p>

<p>åœ¨æ²¡æœ‰è´Ÿè½½çš„æœºå™¨ä¸Šï¼Œè¯¥å‘½ä»¤åŸºæœ¬ä¸Šéƒ½æ˜¯è¿”å›ç©ºçš„</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span>  db.currentOp<span class="o">()</span>
<span class="o">{</span> <span class="s2">"inprog"</span> : <span class="o">[</span> <span class="o">]</span> <span class="o">}</span>
</code></pre></div></div>

<p>ä»¥ä¸‹æ˜¯ä¸€ä¸ªæœ‰è´Ÿè½½çš„æœºå™¨ä¸Šå¾—åˆ°çš„è¿”å›å€¼æ ·ä¾‹ï¼š</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">{</span> <span class="s2">"opid"</span> : <span class="s2">"shard3:466404288"</span>, <span class="s2">"active"</span> : <span class="nb">false</span>, <span class="s2">"waitingForLock"</span> : <span class="nb">false</span>, <span class="s2">"op"</span> : <span class="s2">"query"</span>, <span class="s2">"ns"</span> : <span class="s2">"sd.usersEmails"</span>, <span class="s2">"query"</span> : <span class="o">{</span> <span class="o">}</span>, <span class="s2">"client_s"</span> : <span class="s2">"10.121.13.8:34473"</span>, <span class="s2">"desc"</span> : <span class="s2">"conn"</span> <span class="o">}</span>,
</code></pre></div></div>

<p>å­—æ®µåå­—éƒ½èƒ½è‡ªè§£é‡Šã€‚å¦‚æœä½ å‘ç°ä¸€ä¸ªæ“ä½œå¤ªé•¿ï¼ŒæŠŠæ•°æ®åº“å¡æ­»çš„è¯ï¼Œå¯ä»¥ç”¨è¿™ä¸ªå‘½ä»¤æ€æ­»ä»–</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> db.killOp<span class="o">(</span><span class="s2">"shard3:466404288"</span><span class="o">)</span>
</code></pre></div></div>

<p><a href="https://docs.mongodb.com/manual/reference/method/db.currentOp/index.html">db.currentOp()</a></p>

:ET