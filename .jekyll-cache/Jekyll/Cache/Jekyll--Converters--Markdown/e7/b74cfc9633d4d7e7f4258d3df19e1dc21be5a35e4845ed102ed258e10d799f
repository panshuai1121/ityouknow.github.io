I"Én<p>by å¤ªé˜³é›ª</p>

<p>ç°åœ¨å•é¡µ Web é¡¹ç›®å¾ˆæµè¡Œï¼Œä½¿ç”¨å„ç§ Js æ¡†æ¶ï¼Œé€šè¿‡ Ajax å’ŒæœåŠ¡å™¨çš„ Api è¿›è¡Œäº¤äº’ï¼Œå®ç°ç±»ä¼¼åŸç”Ÿ app æ•ˆæœï¼Œå¾ˆé…·ï¼Œå¯¹ Flask æ¥è¯´å°èœä¸€ç¢Ÿï¼Œæ˜¯æ—¶å€™äº†è§£ä¸‹ Flask-RESTful äº†</p>

<!--more-->

<p>å¼€å§‹å‰å…ˆäº†è§£ä¸‹ RESTfulï¼Œé˜®ä¸€å³°è€å¸ˆæœ‰è¿™æ ·çš„è§£é‡Š:</p>

<blockquote>
  <p>ç½‘ç»œåº”ç”¨ç¨‹åºï¼Œåˆ†ä¸ºå‰ç«¯å’Œåç«¯ä¸¤ä¸ªéƒ¨åˆ†ã€‚å½“å‰çš„å‘å±•è¶‹åŠ¿ï¼Œå°±æ˜¯å‰ç«¯è®¾å¤‡å±‚å‡ºä¸ç©·ï¼ˆæ‰‹æœºã€å¹³æ¿ã€æ¡Œé¢ç”µè„‘ã€å…¶ä»–ä¸“ç”¨è®¾å¤‡â€¦â€¦ï¼‰ã€‚
å› æ­¤ï¼Œå¿…é¡»æœ‰ä¸€ç§ç»Ÿä¸€çš„æœºåˆ¶ï¼Œæ–¹ä¾¿ä¸åŒçš„å‰ç«¯è®¾å¤‡ä¸åç«¯è¿›è¡Œé€šä¿¡ã€‚è¿™å¯¼è‡´APIæ„æ¶çš„æµè¡Œï¼Œç”šè‡³å‡ºç°â€API Firstâ€çš„è®¾è®¡æ€æƒ³ã€‚RESTful APIæ˜¯ç›®å‰æ¯”è¾ƒæˆç†Ÿçš„ä¸€å¥—äº’è”ç½‘åº”ç”¨ç¨‹åºçš„APIè®¾è®¡ç†è®º</p>
</blockquote>

<p>ä¹Ÿå°±æ˜¯è¯´ RESTful ä¸€ä¸ªæ¡†æ¶å’Œäº’è”ç½‘åº”ç”¨çš„è®¾è®¡åŸåˆ™ï¼Œéµå¾ªè¿™ä¸ªè®¾è®¡åŸåˆ™ï¼Œå¯ä»¥è®©åº”ç”¨è„±ç¦»å‰å°å±•ç°çš„æŸç¼šï¼Œæ”¯æŒä¸åŒçš„å‰ç«¯è®¾å¤‡ã€‚</p>

<h2 id="å®‰è£…">å®‰è£…</h2>

<p>Flask çš„ RESTful æ¨¡å—æ˜¯ flask-restful ï¼Œä½¿ç”¨ pip å®‰è£…:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pip <span class="nb">install </span>flask-restful
</code></pre></div></div>

<p>å¦‚æœå®‰è£…é¡ºåˆ©ï¼Œå¯ä»¥åœ¨ Python Shell ç¯å¢ƒä¸‹å¯¼å…¥</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">flask_restful</span> <span class="kn">import</span> <span class="n">Api</span>
<span class="o">&gt;&gt;&gt;</span>
</code></pre></div></div>

<h2 id="å°è¯•ç‰›åˆ€">å°è¯•ç‰›åˆ€</h2>

<p>å®‰è£…å¥½åï¼Œç®€å•è¯•è¯•ã€‚
flask-restful åƒä¹‹å‰çš„ bootstrop-flask ä»¥åŠ flask-sqlalchamy æ¨¡å—ä¸€æ ·ï¼Œä½¿ç”¨å‰éœ€è¦å¯¹ Flask åº”ç”¨è¿›è¡Œåˆå§‹åŒ–ï¼Œç„¶åä¼šå¾—åˆ°å½“å‰åº”ç”¨çš„ api å¯¹è±¡ï¼Œç”¨ api å¯¹è±¡è¿›è¡Œèµ„æºç»‘å®šå’Œè·¯ç”±è®¾ç½®ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
<span class="kn">from</span> <span class="nn">flask_restful</span> <span class="kn">import</span> <span class="n">Api</span><span class="p">,</span> <span class="n">Resource</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="n">api</span> <span class="o">=</span> <span class="n">Api</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>  <span class="c1"># åˆå§‹åŒ–å¾—åˆ° api å¯¹è±¡
</span></code></pre></div></div>

<p>ä¸Šé¢ä»£ç ä¸­ä» flask_restful ä¸­å¼•å…¥çš„ Resource ç±»æ˜¯ç”¨æ¥å®šä¹‰èµ„æºçš„ï¼Œå…·ä½“èµ„æºå¿…é¡»æ˜¯ Resource çš„å­ç±»ï¼Œä¸‹é¢å®šä¹‰ä¸€ä¸ª HelloRESTful èµ„æº:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">HelloRESTful</span><span class="p">(</span><span class="n">Resource</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s">'greet'</span><span class="p">:</span> <span class="s">'Hello Flask RESTful!'</span><span class="p">}</span>
</code></pre></div></div>

<p>æ¥ç€ï¼Œç»™èµ„æºç»‘å®š URIï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">api</span><span class="p">.</span><span class="n">add_resource</span><span class="p">(</span><span class="n">HelloRESTful</span><span class="p">,</span> <span class="s">'/'</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>   <span class="c1"># åˆ«å¿˜äº†å¯åŠ¨åº”ç”¨çš„ä»£ç 
</span>    <span class="n">app</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</code></pre></div></div>

<p>åœ¨ç»ˆç«¯æˆ–è€…å‘½ä»¤è¡Œä¸‹è¿è¡Œ <code class="highlighter-rouge">python app.py</code> å¯åŠ¨åº”ç”¨</p>

<p>è®¿é—® <code class="highlighter-rouge">localhost:5000</code> æˆ–è€… <code class="highlighter-rouge">127.0.0.1:5000</code> æŸ¥çœ‹æ•ˆæœï¼Œå°†ä¼šçœ‹åˆ° JSON æ ¼å¼çš„æ•°æ®è¾“å‡º:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"greet"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Hello Flask RESTful!"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>ä¹Ÿå¯ä»¥ç”¨ curl å·¥å…·åœ¨ç»ˆç«¯æˆ–è€…å‘½ä»¤è¡Œä¸‹å‘é€è¯·æ±‚:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> curl http://localhost:5000 <span class="nt">-s</span>
<span class="o">{</span>
    <span class="s2">"greet"</span>: <span class="s2">"Hello Flask RESTful!"</span>
<span class="o">}</span>
</code></pre></div></div>

<blockquote>
  <p>curl çš„å‚æ•° -s æ˜¯å¼€å¯å®‰é™æ¨¡å¼çš„æ„æ€</p>
</blockquote>

<h2 id="èµ„æº">èµ„æº</h2>

<p>ä»ä¸Šé¢ä»£ç ä¸­å¯ä»¥çœ‹åˆ°ï¼Œèµ„æºæ˜¯ Resource ç±»çš„å­ç±»ï¼Œä»¥è¯·æ±‚æ–¹æ³•( GETã€POST ç­‰)åç§°çš„<strong>å°å†™å½¢å¼</strong>å®šä¹‰çš„æ–¹æ³•ï¼Œèƒ½å¯¹å¯¹åº”æ–¹æ³•çš„è¯·æ±‚ä½œå‡ºç›¸åº”ï¼Œä¾‹å¦‚ä¸Šé¢èµ„æºç±»ä¸­å®šä¹‰çš„ <code class="highlighter-rouge">get</code> æ–¹æ³•å¯ä»¥å¯¹ <code class="highlighter-rouge">GET</code> è¯·æ±‚ä½œå‡ºç›¸åº”ï¼Œè¿˜å¯ä»¥å®šä¹‰ <code class="highlighter-rouge">put</code>ã€<code class="highlighter-rouge">post</code>ã€<code class="highlighter-rouge">delete</code> ç­‰ï¼Œç§°ä¹‹ä¸ºè§†å›¾æ–¹æ³•ã€‚</p>

<p>ä¾‹å¦‚åˆ›å»ºä¸€ä¸ª todo å­—æ ·ï¼Œæ”¯æŒè·å–ä»£åŠäº‹é¡¹å’Œæ–°å¢ä»£åŠäº‹é¡¹ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># åˆå§‹åŒ–å¾…åŠåˆ—è¡¨
</span><span class="n">todos</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s">'todo_1'</span><span class="p">:</span> <span class="s">"è¯»ã€Šç¨‹åºå‘˜çš„è‡ªæˆ‘ä¿®å…»ã€‹"</span><span class="p">,</span>
  <span class="s">'todo_2'</span><span class="p">:</span> <span class="s">"ä¹°ç‚¹åƒçš„"</span><span class="p">,</span>
  <span class="s">'todo_3'</span><span class="p">:</span> <span class="s">"å»çœ‹æ˜Ÿæ˜Ÿ"</span>
<span class="p">}</span>
<span class="k">class</span> <span class="nc">Todo</span><span class="p">(</span><span class="n">Resource</span><span class="p">):</span>
    <span class="c1"># æ ¹æ® todo_id è·å–ä»£åŠäº‹é¡¹
</span>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">todo_id</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span> <span class="n">todo_id</span><span class="p">:</span> <span class="n">todos</span><span class="p">[</span><span class="n">todo_id</span><span class="p">]</span> <span class="p">}</span>

    <span class="c1"># æ–°å¢ä¸€ä¸ªå¾…åŠäº‹é¡¹
</span>    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">todo_id</span><span class="p">):</span>
        <span class="n">todos</span><span class="p">[</span><span class="n">todo_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">form</span><span class="p">[</span><span class="s">'data'</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">todo_id</span><span class="p">:</span> <span class="n">todos</span><span class="p">[</span><span class="n">todo_id</span><span class="p">]}</span>
</code></pre></div></div>

<ul>
  <li>é€šè¿‡ GET æ–¹å¼ï¼Œæä¾› todo_id, ä» todos åˆ—è¡¨ä¸­è·å–å¾…åŠäº‹é¡¹å†…å®¹</li>
  <li>é€šè¿‡ PUT æ–¹å¼ï¼Œæä¾› todo_id, ä»è¯·æ±‚ä½“ä¸­è·å–åˆ°å†…å®¹ï¼Œä½œä¸ºå¾…åŠäº‹é¡¹å†…å®¹</li>
  <li>ä¸¤ç§æ–¹æ³•éƒ½è¿”å› todo_id æ‰€å¯¹åº”çš„å¾…åŠäº‹é¡¹å†…å®¹</li>
</ul>

<p>ä¸º Todo èµ„æºæŒ‡å®š URI:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">api</span><span class="p">.</span><span class="n">add_resource</span><span class="p">(</span><span class="n">Todo</span><span class="p">,</span> <span class="s">'/todo/&lt;string:todo_id&gt;/'</span><span class="p">)</span>
</code></pre></div></div>

<p>å¯åŠ¨é¡¹ç›®ï¼Œç”¨ curl å·¥å…·æµ‹è¯•:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># è¯»å– key ä¸º todo_1 çš„å¾…åŠäº‹é¡¹</span>
 curl http://localhost:5000/todo/todo_1/
<span class="o">{</span>
    <span class="s2">"todo_1"</span>: <span class="s2">"</span><span class="se">\u</span><span class="s2">8bfb</span><span class="se">\u</span><span class="s2">300a</span><span class="se">\u</span><span class="s2">7a0b</span><span class="se">\u</span><span class="s2">5e8f</span><span class="se">\u</span><span class="s2">5458</span><span class="se">\u</span><span class="s2">7684</span><span class="se">\u</span><span class="s2">81ea</span><span class="se">\u</span><span class="s2">6211</span><span class="se">\u</span><span class="s2">4fee</span><span class="se">\u</span><span class="s2">517b</span><span class="se">\u</span><span class="s2">300b"</span>
<span class="o">}</span>

<span class="c"># åˆ›å»ºä¸€ä¸ª key ä¸º todo_4 çš„ä»£åŠäº‹é¡¹</span>
 curl http://localhost:5000/todo/todo_4/ <span class="nt">-d</span> <span class="s2">"data=å­¦ä¹  Flask"</span> <span class="nt">-X</span> PUT
<span class="o">{</span>
    <span class="s2">"todo_4"</span>: <span class="s2">"</span><span class="se">\u</span><span class="s2">5b66</span><span class="se">\u</span><span class="s2">4e60 Flask"</span>
<span class="o">}</span>


<span class="c"># è¯»å–åˆšæ·»åŠ çš„å¾…åŠäº‹é¡¹ todo_4</span>
 curl http://localhost:5000/todo/todo_4/
<span class="o">{</span>
    <span class="s2">"todo_4"</span>: <span class="s2">"</span><span class="se">\u</span><span class="s2">5b66</span><span class="se">\u</span><span class="s2">4e60 Flask"</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Flask-RESTful æ”¯æŒå¤šç§è§†å›¾æ–¹æ³•çš„è¿”å›å€¼:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Todo1</span><span class="p">(</span><span class="n">Resource</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># ç›´æ¥è¿”å›
</span>        <span class="k">return</span> <span class="p">{</span> <span class="s">'task'</span><span class="p">:</span> <span class="s">'Hello world'</span><span class="p">}</span>

<span class="k">class</span> <span class="nc">Todo2</span><span class="p">(</span><span class="n">Resource</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># è¿”å›å†…å®¹åŠçŠ¶æ€ç 
</span>        <span class="k">return</span> <span class="p">{</span><span class="s">'task'</span><span class="p">:</span> <span class="s">'Hello world'</span><span class="p">},</span> <span class="mi">201</span>

<span class="k">class</span> <span class="nc">Todo3</span><span class="p">(</span><span class="n">Resource</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># è¿”å›å†…å®¹ï¼ŒçŠ¶æ€ç ä»¥åŠ Header
</span>        <span class="k">return</span> <span class="p">{</span><span class="s">'task'</span><span class="p">:</span> <span class="s">'Hello world'</span><span class="p">},</span> <span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="s">'Etag'</span><span class="p">:</span> <span class="s">'some-opaque-string'</span><span class="p">}</span>
</code></pre></div></div>

<p>ä¸ºä¸‰ä¸ªèµ„æºæŒ‡å®š URIï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">api</span><span class="p">.</span><span class="n">add_resource</span><span class="p">(</span><span class="n">Todo1</span><span class="p">,</span> <span class="s">'/todo_1/'</span><span class="p">)</span>
<span class="n">api</span><span class="p">.</span><span class="n">add_resource</span><span class="p">(</span><span class="n">Todo1</span><span class="p">,</span> <span class="s">'/todo_2/'</span><span class="p">)</span>
<span class="n">api</span><span class="p">.</span><span class="n">add_resource</span><span class="p">(</span><span class="n">Todo1</span><span class="p">,</span> <span class="s">'/todo_3/'</span><span class="p">)</span>
</code></pre></div></div>

<p>å¯åŠ¨é¡¹ç›®åï¼Œç”¨ curl å·¥å…·æ¥æµ‹è¯•:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> curl http://localhost:5000/todo_1/
<span class="o">{</span>
    <span class="s2">"task"</span>: <span class="s2">"Hello world"</span>
<span class="o">}</span>

<span class="c"># -è¯·æ±‚ todo_2 å¹¶æ˜¾ç¤ºå‡º HTTP æ ‡å¤´ï¼ŒHTTP çŠ¶æ€ç ä¸º 201</span>
 curl http://localhost:5000/todo_2/ <span class="nt">-i</span>
HTTP/1.0 201 CREATED
Content-Type: application/json
Content-Length: 30
Server: Werkzeug/0.16.0 Python/3.7.5rc1
Date: Thu, 31 Oct 2019 14:12:54 GMT

<span class="o">{</span>
    <span class="s2">"task"</span>: <span class="s2">"Hello world"</span>
<span class="o">}</span>

<span class="c"># -è¯·æ±‚ todo_3 å¹¶æ˜¾ç¤ºå‡º HTTP æ ‡å¤´ï¼ŒHTTP çŠ¶æ€ç ä¸º 200 ï¼Œæ ‡å¤´ä¸­è¿˜æœ‰ Etag</span>
 curl http://localhost:5000/todo_3/ <span class="nt">-i</span>
HTTP/1.0 200 OK
Content-Type: application/json
Content-Length: 30
Etag: some-opaque-string
Server: Werkzeug/0.16.0 Python/3.7.5rc1
Date: Thu, 31 Oct 2019 14:14:57 GMT

<span class="o">{</span>
    <span class="s2">"task"</span>: <span class="s2">"Hello world"</span>
<span class="o">}</span>

</code></pre></div></div>

<h2 id="è·¯ç”±">è·¯ç”±</h2>

<p>ä»ä¸Šé¢å¯ä»¥çœ‹åˆ°ï¼Œé€šè¿‡ api.add_resource æ–¹æ³•æ¥ä¸ºèµ„æºè®¾ç½®è·¯ç”±</p>

<p>ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯èµ„æºç±»ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯è·¯ç”±ï¼Œå’Œä¹‹å‰ä»‹ç»çš„ <code class="highlighter-rouge">@app.route</code> æ³¨è§£å‚æ•°ä¸€æ ·</p>

<p>å¯ä»¥ä¸ºä¸€ä¸ªèµ„æºåˆ¶å®šå¤šä¸ªç†ç”±ï¼Œä¾‹å¦‚:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">api</span><span class="p">.</span><span class="n">add_resource</span><span class="p">(</span><span class="n">Todo</span><span class="p">,</span> <span class="s">'/todo/'</span><span class="p">,</span> <span class="s">'/mytodo/'</span><span class="p">)</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">http://localhost:5000/todo/</code> å’Œ <code class="highlighter-rouge">http://localhost:5000/mytodo/</code> éƒ½å°†æŒ‡å‘ Todo</p>

<p>æ—¢ç„¶è·¯ç”±ï¼Œå°±åº”è¯¥æœ‰ <code class="highlighter-rouge">endpoint</code>ï¼Œé€šè¿‡å‘½åå‚æ•° <code class="highlighter-rouge">endpoint</code> æŒ‡å®š:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">api</span><span class="p">.</span><span class="n">add_resource</span><span class="p">(</span><span class="n">Todo</span><span class="p">,</span> <span class="s">'/todo/'</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="s">'todo_ep'</span><span class="p">)</span>
</code></pre></div></div>

<p>è®¾ç½®è·¯ç”±çš„ <code class="highlighter-rouge">endpoint</code> ä¸º <code class="highlighter-rouge">todo_ep</code>ï¼Œå¦‚æœä¸æŒ‡å®šï¼Œ<code class="highlighter-rouge">endpoint</code> å°±æ˜¯èµ„æºç±»åçš„å°å†™å½¢å¼</p>

<p><code class="highlighter-rouge">endpoint</code> æ˜¯ Flask ä¸­å¯¹å…·ä½“è·¯ç”±çš„å†…éƒ¨çš„å…·ä½“å®šä¹‰ï¼Œä¸€èˆ¬ä½œä¸º <code class="highlighter-rouge">url_for</code> æ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œå³é€šè¿‡ <code class="highlighter-rouge">endpoint</code> è·å¾—è¯¥è·¯ç”±çš„ URLï¼Œåœ¨åˆ—å‡º RESTful èµ„æº URL æ—¶éå¸¸æœ‰ç”¨ã€‚</p>

<h2 id="è¯·æ±‚è§£æ">è¯·æ±‚è§£æ</h2>

<p>RESTful æœåŠ¡å™¨å¯¹è¯·æ±‚æ•°æ®æœ‰å¾ˆå¼ºçš„ä¾èµ–ï¼Œå°±è¯·æ±‚æ•°æ®çš„è·å–åŠæ ¡éªŒæ˜¯å¾ˆç¹ççš„äº‹æƒ…ï¼Œè¿˜å¥½ Flask-RESTful æä¾›äº†éå¸¸å¥½çš„è¯·æ±‚è§£æå·¥å…· <code class="highlighter-rouge">reqparse</code>ï¼Œä¸ä»…å¯ä»¥è·å–è¯·æ±‚æ•°æ®ï¼Œè¿˜å¯ä»¥å¯¹æ•°æ®è¿›è¡Œæ ¡éªŒå¹¶è¿”å›åˆé€‚çš„é”™è¯¯æ¶ˆæ¯ã€‚</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">flask_restful</span> <span class="kn">import</span> <span class="n">reqparse</span>  <span class="c1"># å¼•å…¥ reqparse æ¨¡å—
# ...
</span>
<span class="n">parser</span> <span class="o">=</span> <span class="n">reqparse</span><span class="p">.</span><span class="n">RequestParser</span><span class="p">()</span>  <span class="c1"># å®šä¹‰å…¨å±€çš„è§£æå®ä½“
# å®šä¹‰å‚æ•° idï¼Œç±»å‹å¿…é¡»æ˜¯æ•´æ•°
</span><span class="n">parser</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">'id'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">'å¿…é¡»æä¾›å‚æ•° id'</span><span class="p">)</span>
<span class="c1"># å®šä¹‰å‚æ•° nameï¼Œä¸”ä¸ºå¿…å¡«
</span><span class="n">parser</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">'name'</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="c1"># ...
</span>
<span class="k">class</span> <span class="nc">Reqparser</span><span class="p">(</span><span class="n">Resource</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="n">parse_args</span><span class="p">()</span>  <span class="c1"># è·å–è§£æå™¨ä¸­å®šä¹‰çš„å‚æ•° å¹¶æ ¡éªŒ
</span>        <span class="k">return</span> <span class="n">args</span>

<span class="n">api</span><span class="p">.</span><span class="n">add_resource</span><span class="p">(</span><span class="n">Reqparser</span><span class="p">,</span> <span class="s">'/reqparser/'</span><span class="p">)</span>  <span class="c1"># æŒ‡å®šè·¯ç”±
</span></code></pre></div></div>

<p>çœ‹ä¸‹æ•ˆæœ:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># æä¾›ä¸€ä¸ªéæ•´æ•°å‚æ•° id</span>
 curl http://localhost:5000/reqparser/ <span class="nt">-d</span> <span class="s2">"id=noint"</span> <span class="nt">-X</span> GET
<span class="o">{</span>
    <span class="s2">"message"</span>: <span class="o">{</span>
        <span class="s2">"id"</span>: <span class="s2">"</span><span class="se">\u</span><span class="s2">53c2</span><span class="se">\u</span><span class="s2">6570 id </span><span class="se">\u</span><span class="s2">5fc5</span><span class="se">\u</span><span class="s2">987b</span><span class="se">\u</span><span class="s2">662f</span><span class="se">\u</span><span class="s2">6574</span><span class="se">\u</span><span class="s2">6570"</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="c"># ä¸æä¾›å‚æ•° name</span>
curl http://localhost:5000/reqparser/
<span class="o">{</span>
    <span class="s2">"message"</span>: <span class="o">{</span>
        <span class="s2">"name"</span>: <span class="s2">"Missing required parameter in the JSON body or the post body or the query string"</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>å½“å‚æ•°æ ¡éªŒå¤±è´¥ï¼Œè‡ªåŠ¨è¿”å› 400 çŠ¶æ€ç ï¼Œä»¥åŠé”™è¯¯ä¿¡æ¯ï¼Œé€šè¿‡å‘½åå‚æ•° help è®¾ç½®é”™è¯¯ä¿¡æ¯ï¼Œä¸æä¾›ä¼šæœ‰é»˜è®¤ä¿¡æ¯ï¼Œå¦‚æ¯”é€‰å‚æ•° name çš„é”™è¯¯ä¿¡æ¯ã€‚</li>
  <li>é»˜è®¤æƒ…å†µä¸‹æœ‰å¤šä¸ªå‚æ•°é”™è¯¯ï¼Œä¼šä»¥å®šä¹‰å‚æ•°çš„é¡ºåºï¼Œé€ä¸ªæ˜¾ç¤ºé”™è¯¯ï¼Œå®šä¹‰è§£æå™¨æ—¶å°† bundle_errors è®¾ç½®ä¸º Trueï¼Œåˆ™å¯æ˜¾ç¤ºå¤šä¸ªé”™è¯¯ï¼Œå¦‚ <code class="highlighter-rouge">parser = reqparse.RequestParser(bundle_errors=True)</code>ï¼Œæˆ–è€…è®¾ç½®åº”ç”¨é…ç½®ï¼Œå¦‚ <code class="highlighter-rouge">app.config['BUNDLE_ERRORS'] = True</code></li>
  <li>é»˜è®¤æƒ…å†µä¸‹å‚æ•°éƒ½æ˜¯ä»è¯·æ±‚è¡¨å•ä¸­è·å–ï¼Œå®šä¹‰å‚æ•°æ—¶å‘½åå‚æ•° location å¯ä»¥æŒ‡å®šä» formã€headersã€argsï¼ˆå³ querystringï¼‰è¿˜æ˜¯ä» cookies ç­‰ä¸­è·å–ï¼Œå¦‚ <code class="highlighter-rouge">parser.add_argument('id', type=int, help='å¿…é¡»æä¾›å‚æ•° id', location='args')</code></li>
</ul>

<p>è¯·æ±‚è§£æå™¨æ”¯æŒç»§æ‰¿ï¼Œå¯ä»¥å®šä¹‰æœ€é«˜çº§åˆ«çš„è§£æå™¨ï¼Œé€æ¸ç»†åŒ–ï¼Œæœ€ååº”ç”¨çš„å…·ä½“èµ„æºä¸Šï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">flask_restful</span> <span class="kn">import</span> <span class="n">reqparse</span>

<span class="n">parser</span> <span class="o">=</span> <span class="n">reqparse</span><span class="p">.</span><span class="n">RequestParser</span><span class="p">()</span>
<span class="n">parser</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">'foo'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

<span class="n">parser_copy</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># ç»§æ‰¿
</span><span class="n">parser_copy</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">'bar'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>  <span class="c1"># parser_copy å°†æœ‰ä¸¤ä¸ªå‚æ•°
</span>
<span class="c1"># æ”¹å˜ç»§æ‰¿æ¥çš„å‚æ•° foo å¿…å¡«ä¸”çš„è·å–ä½ç½®ä¸º querystring
</span><span class="n">parser_copy</span><span class="p">.</span><span class="n">replace_argument</span><span class="p">(</span><span class="s">'foo'</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="s">'args'</span><span class="p">)</span>

<span class="c1"># åˆ é™¤ç»§æ‰¿æ¥çš„å‚æ•° foo
</span><span class="n">parser_copy</span><span class="p">.</span><span class="n">remove_argument</span><span class="p">(</span><span class="s">'foo'</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="æ ¼å¼åŒ–è¾“å‡º">æ ¼å¼åŒ–è¾“å‡º</h2>

<p>è¯·æ±‚è§£æå¤„ç†ç”¨æ”¶åˆ°çš„ä¿¡æ¯ï¼Œå¯¹äºè¾“å…¥çš„ä¿¡æ¯ä¹Ÿå¯ä»¥å¤„ç†ï¼Œé€šè¿‡ Flask-RESTful æä¾›çš„ç±» fields å’Œæ³¨è§£ marshal_with æ¥å®ç°ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">flask_restful</span> <span class="kn">import</span> <span class="n">Resource</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">marshal_with</span>

<span class="n">resource_fields</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'name'</span><span class="p">:</span> <span class="n">fields</span><span class="p">.</span><span class="n">String</span><span class="p">,</span>
    <span class="s">'address'</span><span class="p">:</span> <span class="n">fields</span><span class="p">.</span><span class="n">String</span><span class="p">,</span>
    <span class="s">'date_updated'</span><span class="p">:</span> <span class="n">fields</span><span class="p">.</span><span class="n">DateTime</span><span class="p">(</span><span class="n">dt_format</span><span class="o">=</span><span class="s">'rfc822'</span><span class="p">),</span>
<span class="p">}</span>

<span class="k">class</span> <span class="nc">TodoFormat</span><span class="p">(</span><span class="n">Resource</span><span class="p">):</span>
    <span class="o">@</span><span class="n">marshal_with</span><span class="p">(</span><span class="n">resource_fields</span><span class="p">,</span> <span class="n">envelope</span><span class="o">=</span><span class="s">'resource'</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">db_get_todo</span><span class="p">()</span>  <span class="c1"># æŸä¸ªè·å¾—å¾…åŠäº‹é¡¹çš„æ–¹æ³•
</span></code></pre></div></div>

<ul>
  <li>å®šä¹‰ä¸€ä¸ªå­—æ®µæ ¼å¼åŒ–æ¨¡æ¿ï¼Œå±æ€§ç”¨ fields çš„ç±»å‹æ–¹æ³•å®šä¹‰</li>
  <li>åœ¨å“åº”æ–¹æ³•ä¸ŠåŠ ä¸Š <code class="highlighter-rouge">marshal_with</code> æ³¨è§£ï¼ŒæŒ‡å®šæ ¼å¼åŒ–æ¨¡æ¿ï¼Œå’Œå°è£…å±æ€§å</li>
</ul>

<p>æ ¼å¼åŒ–æ¨¡æ¿å±æ€§åï¼Œéœ€è¦åœ¨å“åº”å‡½æ•°è¿”å›çš„å¯¹è±¡å±æ€§ä¸­åŒ¹é…ï¼Œå¦‚æœéœ€è¦ä¼šè¦å¯¹å­—æ®µé‡å‘½åï¼Œå¯ä»¥è¿™æ ·:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fields</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1"># name å°†è¢«é‡å‘½åä¸º private_name
</span>    <span class="s">'name'</span><span class="p">:</span> <span class="n">fields</span><span class="p">.</span><span class="n">String</span><span class="p">(</span><span class="n">attribute</span><span class="o">=</span><span class="s">'private_name'</span><span class="p">),</span>
    <span class="s">'address'</span><span class="p">:</span> <span class="n">fields</span><span class="p">.</span><span class="n">String</span>
<span class="p">}</span>
</code></pre></div></div>

<p>è¿”å›å€¼ä¸­æ²¡æœ‰å¯ä»¥å®šä¹‰é»˜è®¤å€¼:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fields</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1"># ä¸º name è®¾ç½®é»˜è®¤å€¼
</span>    <span class="s">'name'</span><span class="p">:</span> <span class="n">fields</span><span class="p">.</span><span class="n">String</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s">'Anonymous User'</span><span class="p">),</span>
    <span class="s">'address'</span><span class="p">:</span> <span class="n">fields</span><span class="p">.</span><span class="n">String</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="æ€»ç»“">æ€»ç»“</h2>

<p>æœ¬èŠ‚è¯¾ç¨‹ç®€å•ä»‹ç»äº† Flask å¦‚ä½•ç© RESTfulï¼Œé€šè¿‡å¯¹ RESTful çš„è¯´æ˜ï¼Œè®²è§£äº† Flask-RESTful æ¨¡å—çš„ç”¨æ³•ï¼Œå¹¶ç®€å•è®²è§£äº†èµ„æºã€è·¯ç”±ï¼Œä»¥åŠè¯·æ±‚è§£æå’Œæ ¼å¼åŒ–è¾“å‡ºç­‰æŠ€æœ¯</p>

<blockquote>
  <p>ç¤ºä¾‹ä»£ç ï¼š<a href="https://github.com/JustDoPython/python-100-day/tree/master/day-047">Python-100-days-day047</a></p>
</blockquote>

<p>å‚è€ƒ</p>

<ul>
  <li><a href="http://www.ruanyifeng.com/blog/2014/05/restful_api.html">http://www.ruanyifeng.com/blog/2014/05/restful_api.html</a></li>
  <li><a href="http://www.ruanyifeng.com/blog/2011/09/restful.html">http://www.ruanyifeng.com/blog/2011/09/restful.html</a></li>
  <li><a href="https://flask-restful.readthedocs.io/en/latest/">https://flask-restful.readthedocs.io/en/latest/</a></li>
  <li><a href="http://www.ruanyifeng.com/blog/2019/09/curl-reference.html">http://www.ruanyifeng.com/blog/2019/09/curl-reference.html</a></li>
</ul>
:ET