<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Favicon Icon -->
    <link rel="shortcut icon" type="image/x-icon" href="/assets/images/favicon.ico">

    <title> Docker(三)：Dockerfile 命令详解 - 潘帅的博客 </title>
    <meta name="keywords" content="docker,Dockerfile,命令,指令详解">
    <meta name="description"
          content="&lt;p&gt;上一篇文章&lt;a href=&quot;http://www.ityouknow.com/docker/2018/03/12/docker-use-dockerfile.html&quot;&gt;Docker(二)：Dockerfile 使用介绍&lt;/a&gt;介绍了 Dockerfile 的使用，这篇文章我们来继续了解 Dockerfile ,学习 Dockerfile 各种命令的使用。&lt;/p&gt;
">

    <link rel="canonical" href="http://localhost:4000/docker/2018/03/15/docker-dockerfile-command-introduction.html">
    <link rel="alternate" type="application/rss+xml" title="潘帅的博客" href="http://localhost:4000/feed.xml">

    <!-- Third-Party CSS -->
    <link rel="stylesheet" href="http://favorites.ren/bower_components/bootstrap/dist/css/bootstrap.min.css?v=1">
    <link rel="stylesheet" href="http://panshuai1121.github.io/bower_components/octicons/octicons/octicons.css?v=1">
    <link rel="stylesheet" href="http://favorites.ren/bower_components/hover/css/hover-min.css">
    <link rel="stylesheet" href="http://favorites.ren/bower_components/primer-markdown/dist/user-content.min.css">
    <link rel="stylesheet" href="http://favorites.ren/assets/css/syntax.css">
    <link rel="stylesheet" href="http://favorites.ren/assets/css/gitalk.css">

    

    <!-- My CSS -->
    <link rel="stylesheet" href="http://favorites.ren/assets/css/common.css">

    <!-- CSS set in page -->
    

    <!-- CSS set in layout -->
    
    <link rel="stylesheet" href="http://favorites.ren/assets/css/sidebar-post-nav.css">
    

    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css">

    <script type="text/javascript" src="http://favorites.ren/bower_components/jquery/dist/jquery.min.js"></script>
    <script type="text/javascript" src="http://favorites.ren/bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="http://panshuai1121.github.io/assets/js/lock.js?v=1"></script>
</head>


    <body>

    <header class="site-header">
    <div class="site-header-topbar">
        <div class="container">
            <div class="topbar-menu">
                
                <div class="item">
                    <a href="/it.html"
                       target="_self"
                       title="深度">
                        深度
                    </a>
                </div>
                
                <div class="item">
                    <a href="/life.html"
                       target="_self"
                       title="故事">
                        故事
                    </a>
                </div>
                
                <div class="item">
                    <a href="/arch.html"
                       target="_self"
                       title="架构">
                        架构
                    </a>
                </div>
                
                <div class="item">
                    <a href="/link.html"
                       target="_self"
                       title="友链">
                        友链
                    </a>
                </div>
                
            </div>
        </div>
    </div>
    <div class="container">
        <a id="site-header-brand" href="/" title="潘帅的博客">
            <span class="octicon octicon-smiley"></span>
            潘帅的博客
        </a>
        <nav class="site-header-nav" role="navigation">
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/"
                   target=""
                   title="Home">
                    Home
                </a>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/spring-boot.html"
                   target="_self"
                   title="Spring Boot">
                    Spring Boot
                </a>
                
                <ul class="submenu">
                    
                    <li><a href="/spring-boot.html" 
                           target=""
                     >Spring Boot</a></li>
                    
                    <li><a href="/spring-cloud.html" 
                           target=""
                     >Spring Cloud</a></li>
                    
                </ul>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/php.html"
                   target="_self"
                   title="PHP">
                    PHP
                </a>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/python.html"
                   target=""
                   title="Python">
                    Python
                </a>
                
                <ul class="submenu">
                    
                    <li><a href="/python.html" 
                           target=""
                     >Python 教程</a></li>
                    
                    <li><a href="http://www.justdopython.com" 
                           target="_blank"
                     >Python 技术</a></li>
                    
                </ul>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/archives.html"
                   target="_self"
                   title="Archives">
                    Archives
                </a>
                
            </div>
            
        </nav>
    </div>
</header>


        <div class="content">
            <section class="jumbotron geopattern" data-pattern-id="Docker(三)：Dockerfile 命令详解">
    <div class="container">
        <div id="jumbotron-meta-info">        
            <h1>Docker(三)：Dockerfile 命令详解</h1>
            <span class="meta-info">
                
                
                <span class="octicon octicon-calendar"></span> 2018/03/15
                
            </span>
        </div>
    </div>
</section>
<script>
    $(document).ready(function(){

        $('.geopattern').each(function(){
            $(this).geopattern($(this).data('pattern-id'));
        });

    });
</script>
<article class="post container " itemscope itemtype="http://schema.org/BlogPosting">

    <div class="row">

        
        <div class="col-md-9 markdown-body">

            <p>上一篇文章<a href="http://www.ityouknow.com/docker/2018/03/12/docker-use-dockerfile.html">Docker(二)：Dockerfile 使用介绍</a>介绍了 Dockerfile 的使用，这篇文章我们来继续了解 Dockerfile ,学习 Dockerfile 各种命令的使用。</p>

<h2 id="dockerfile-指令详解">Dockerfile 指令详解</h2>

<h3 id="1-from-指定基础镜像">1 FROM 指定基础镜像</h3>

<p>FROM 指令用于指定其后构建新镜像所使用的基础镜像。FROM 指令必是 Dockerfile 文件中的首条命令，启动构建流程后，Docker 将会基于该镜像构建新镜像，FROM 后的命令也会基于这个基础镜像。</p>

<p>FROM语法格式为：</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>FROM &lt;image&gt;
</code></pre></div></div>

<p>或</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>FROM &lt;image&gt;:&lt;tag&gt;
</code></pre></div></div>

<p>或</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>FROM &lt;image&gt;:&lt;digest&gt;
</code></pre></div></div>

<p>通过 FROM 指定的镜像，可以是任何有效的基础镜像。FROM 有以下限制：</p>

<ul>
  <li>FROM 必须 是 Dockerfile 中第一条非注释命令</li>
  <li>在一个 Dockerfile 文件中创建多个镜像时，FROM 可以多次出现。只需在每个新命令 FROM 之前，记录提交上次的镜像 ID。</li>
  <li>tag 或 digest 是可选的，如果不使用这两个值时，会使用 latest 版本的基础镜像</li>
</ul>

<h3 id="2-run-执行命令">2 RUN 执行命令</h3>

<p>在镜像的构建过程中执行特定的命令，并生成一个中间镜像。格式:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#shell格式</span>
RUN &lt;<span class="nb">command</span><span class="o">&gt;</span>
<span class="c">#exec格式</span>
RUN <span class="o">[</span><span class="s2">"executable"</span>, <span class="s2">"param1"</span>, <span class="s2">"param2"</span><span class="o">]</span>
</code></pre></div></div>

<ul>
  <li>RUN 命令将在当前 image 中执行任意合法命令并提交执行结果。命令执行提交后，就会自动执行 Dockerfile 中的下一个指令。</li>
  <li>层级 RUN 指令和生成提交是符合 Docker 核心理念的做法。它允许像版本控制那样，在任意一个点，对 image 镜像进行定制化构建。</li>
  <li>RUN 指令创建的中间镜像会被缓存，并会在下次构建中使用。如果不想使用这些缓存镜像，可以在构建时指定 <code class="highlighter-rouge">--no-cache</code> 参数，如：<code class="highlighter-rouge">docker build --no-cache</code>。</li>
</ul>

<h3 id="3-copy-复制文件">3 COPY 复制文件</h3>

<p>格式：</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>COPY &lt;源路径&gt;... &lt;目标路径&gt;
COPY <span class="o">[</span><span class="s2">"&lt;源路径1&gt;"</span>,... <span class="s2">"&lt;目标路径&gt;"</span><span class="o">]</span>
</code></pre></div></div>

<p>和 RUN 指令一样，也有两种格式，一种类似于命令行，一种类似于函数调用。COPY 指令将从构建上下文目录中 <源路径> 的文件/目录复制到新的一层的镜像内的`<目标路径>`位置。比如：</目标路径></源路径></p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>COPY package.json /usr/src/app/
</code></pre></div></div>

<p><code class="highlighter-rouge">&lt;源路径&gt;</code>可以是多个，甚至可以是通配符，其通配符规则要满足 Go 的 filepath.Match 规则，如：</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>COPY hom<span class="k">*</span> /mydir/
COPY hom?.txt /mydir/
</code></pre></div></div>

<p><code class="highlighter-rouge">&lt;目标路径&gt;</code>可以是容器内的绝对路径，也可以是相对于工作目录的相对路径（工作目录可以用 WORKDIR 指令来指定）。目标路径不需要事先创建，如果目录不存在会在复制文件前先行创建缺失目录。</p>

<p>此外，还需要注意一点，使用 COPY 指令，源文件的各种元数据都会保留。比如读、写、执行权限、文件变更时间等。这个特性对于镜像定制很有用。特别是构建相关文件都在使用 Git 进行管理的时候。</p>

<h3 id="4-add-更高级的复制文件">4 ADD 更高级的复制文件</h3>

<p>ADD 指令和 COPY 的格式和性质基本一致。但是在 COPY 基础上增加了一些功能。比如<code class="highlighter-rouge">&lt;源路径&gt;</code>可以是一个 URL，这种情况下，Docker 引擎会试图去下载这个链接的文件放到<code class="highlighter-rouge">&lt;目标路径&gt;</code>去。</p>

<p>在构建镜像时，复制上下文中的文件到镜像内，格式：</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ADD &lt;源路径&gt;... &lt;目标路径&gt;
ADD <span class="o">[</span><span class="s2">"&lt;源路径&gt;"</span>,... <span class="s2">"&lt;目标路径&gt;"</span><span class="o">]</span>
</code></pre></div></div>

<p><strong>注意</strong><br />
如果 docker 发现文件内容被改变，则接下来的指令都不会再使用缓存。关于复制文件时需要处理的/，基本跟正常的 copy 一致</p>

<h3 id="5-env-设置环境变量">5 ENV 设置环境变量</h3>

<p>格式有两种：</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ENV &lt;key&gt; &lt;value&gt;
ENV &lt;key1&gt;<span class="o">=</span>&lt;value1&gt; &lt;key2&gt;<span class="o">=</span>&lt;value2&gt;...
</code></pre></div></div>

<p>这个指令很简单，就是设置环境变量而已，无论是后面的其它指令，如 RUN，还是运行时的应用，都可以直接使用这里定义的环境变量。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ENV <span class="nv">VERSION</span><span class="o">=</span>1.0 <span class="nv">DEBUG</span><span class="o">=</span>on <span class="se">\</span>
    <span class="nv">NAME</span><span class="o">=</span><span class="s2">"Happy Feet"</span>
</code></pre></div></div>

<p>这个例子中演示了如何换行，以及对含有空格的值用双引号括起来的办法，这和 Shell 下的行为是一致的。</p>

<h3 id="6-expose">6 EXPOSE</h3>

<p>为构建的镜像设置监听端口，使容器在运行时监听。格式：</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>EXPOSE &lt;port&gt; <span class="o">[</span>&lt;port&gt;...]
</code></pre></div></div>

<p>EXPOSE 指令并不会让容器监听 host 的端口，如果需要，需要在 docker run 时使用 <code class="highlighter-rouge">-p</code>、<code class="highlighter-rouge">-P</code> 参数来发布容器端口到 host 的某个端口上。</p>

<h3 id="7-volume-定义匿名卷">7 VOLUME 定义匿名卷</h3>

<p>VOLUME用于创建挂载点，即向基于所构建镜像创始的容器添加卷：</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>VOLUME <span class="o">[</span><span class="s2">"/data"</span><span class="o">]</span>
</code></pre></div></div>

<p>一个卷可以存在于一个或多个容器的指定目录，该目录可以绕过联合文件系统，并具有以下功能：</p>

<ul>
  <li>卷可以容器间共享和重用</li>
  <li>容器并不一定要和其它容器共享卷</li>
  <li>修改卷后会立即生效</li>
  <li>对卷的修改不会对镜像产生影响</li>
  <li>卷会一直存在，直到没有任何容器在使用它</li>
</ul>

<p>VOLUME 让我们可以将源代码、数据或其它内容添加到镜像中，而又不并提交到镜像中，并使我们可以多个容器间共享这些内容。</p>

<h3 id="8-workdir-指定工作目录">8 WORKDIR 指定工作目录</h3>

<p>WORKDIR用于在容器内设置一个工作目录：</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>WORKDIR /path/to/workdir
</code></pre></div></div>

<p>通过WORKDIR设置工作目录后，Dockerfile 中其后的命令 RUN、CMD、ENTRYPOINT、ADD、COPY 等命令都会在该目录下执行。
如，使用WORKDIR设置工作目录：</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>WORKDIR /a
WORKDIR b
WORKDIR c
RUN <span class="nb">pwd</span>
</code></pre></div></div>

<p>在以上示例中，pwd 最终将会在 <code class="highlighter-rouge">/a/b/c</code> 目录中执行。在使用 docker run 运行容器时，可以通过<code class="highlighter-rouge">-w</code>参数覆盖构建时所设置的工作目录。</p>

<h3 id="9-user-指定当前用户">9 USER 指定当前用户</h3>

<p>USER 用于指定运行镜像所使用的用户：</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>USER daemon
</code></pre></div></div>

<p>使用USER指定用户时，可以使用用户名、UID 或 GID，或是两者的组合。以下都是合法的指定试：</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>USER user
USER user:group
USER uid
USER uid:gid
USER user:gid
USER uid:group
</code></pre></div></div>

<p>使用USER指定用户后，Dockerfile 中其后的命令 RUN、CMD、ENTRYPOINT 都将使用该用户。镜像构建完成后，通过 docker run 运行容器时，可以通过 <code class="highlighter-rouge">-u</code> 参数来覆盖所指定的用户。</p>

<h3 id="10-cmd">10 CMD</h3>

<p>CMD用于指定在容器启动时所要执行的命令。CMD 有以下三种格式：</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CMD <span class="o">[</span><span class="s2">"executable"</span>,<span class="s2">"param1"</span>,<span class="s2">"param2"</span><span class="o">]</span>
CMD <span class="o">[</span><span class="s2">"param1"</span>,<span class="s2">"param2"</span><span class="o">]</span>
CMD <span class="nb">command </span>param1 param2
</code></pre></div></div>

<p>省略可执行文件的 exec 格式，这种写法使 CMD 中的参数当做 ENTRYPOINT 的默认参数，此时 ENTRYPOINT 也应该是 exec 格式，具体与 ENTRYPOINT 的组合使用，参考 ENTRYPOINT。</p>

<p><strong>注意</strong><br />
与 RUN 指令的区别：RUN 在构建的时候执行，并生成一个新的镜像，CMD 在容器运行的时候执行，在构建时不进行任何操作。</p>

<h3 id="11-entrypoint">11 ENTRYPOINT</h3>

<p>ENTRYPOINT 用于给容器配置一个可执行程序。也就是说，每次使用镜像创建容器时，通过 ENTRYPOINT 指定的程序都会被设置为默认程序。ENTRYPOINT 有以下两种形式：</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ENTRYPOINT <span class="o">[</span><span class="s2">"executable"</span>, <span class="s2">"param1"</span>, <span class="s2">"param2"</span><span class="o">]</span>
ENTRYPOINT <span class="nb">command </span>param1 param2
</code></pre></div></div>

<p>ENTRYPOINT 与 CMD 非常类似，不同的是通过<code class="highlighter-rouge">docker run</code>执行的命令不会覆盖 ENTRYPOINT，而<code class="highlighter-rouge">docker run</code>命令中指定的任何参数，都会被当做参数再次传递给 ENTRYPOINT。Dockerfile 中只允许有一个 ENTRYPOINT 命令，多指定时会覆盖前面的设置，而只执行最后的 ENTRYPOINT 指令。</p>

<p><code class="highlighter-rouge">docker run</code>运行容器时指定的参数都会被传递给 ENTRYPOINT ，且会覆盖 CMD 命令指定的参数。如，执行<code class="highlighter-rouge">docker run &lt;image&gt; -d</code>时，-d 参数将被传递给入口点。</p>

<p>也可以通过<code class="highlighter-rouge">docker run --entrypoint</code>重写 ENTRYPOINT 入口点。如：可以像下面这样指定一个容器执行程序：</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ENTRYPOINT <span class="o">[</span><span class="s2">"/usr/bin/nginx"</span><span class="o">]</span>
</code></pre></div></div>

<p>完整构建代码：</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Version: 0.0.3</span>
FROM ubuntu:16.04
MAINTAINER 何民三 <span class="s2">"cn.liuht@gmail.com"</span>
RUN apt-get update
RUN apt-get <span class="nb">install</span> <span class="nt">-y</span> nginx
RUN <span class="nb">echo</span> <span class="s1">'Hello World, 我是个容器'</span> <span class="se">\ </span>
   <span class="o">&gt;</span> /var/www/html/index.html
ENTRYPOINT <span class="o">[</span><span class="s2">"/usr/sbin/nginx"</span><span class="o">]</span>
EXPOSE 80
</code></pre></div></div>

<p>使用docker build构建镜像，并将镜像指定为 itbilu/test：</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker build <span class="nt">-t</span><span class="o">=</span><span class="s2">"itbilu/test"</span> <span class="nb">.</span>
</code></pre></div></div>

<p>构建完成后，使用itbilu/test启动一个容器：</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run <span class="nt">-i</span> <span class="nt">-t</span>  itbilu/test <span class="nt">-g</span> <span class="s2">"daemon off;"</span>
</code></pre></div></div>

<p>在运行容器时，我们使用了 <code class="highlighter-rouge">-g "daemon off;"</code>，这个参数将会被传递给 ENTRYPOINT，最终在容器中执行的命令为 <code class="highlighter-rouge">/usr/sbin/nginx -g "daemon off;"</code>。</p>

<h3 id="12-label">12 LABEL</h3>

<p>LABEL用于为镜像添加元数据，元数以键值对的形式指定：</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>LABEL &lt;key&gt;<span class="o">=</span>&lt;value&gt; &lt;key&gt;<span class="o">=</span>&lt;value&gt; &lt;key&gt;<span class="o">=</span>&lt;value&gt; ...
</code></pre></div></div>

<p>使用LABEL指定元数据时，一条LABEL指定可以指定一或多条元数据，指定多条元数据时不同元数据之间通过空格分隔。推荐将所有的元数据通过一条LABEL指令指定，以免生成过多的中间镜像。
如，通过LABEL指定一些元数据：</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>LABEL <span class="nv">version</span><span class="o">=</span><span class="s2">"1.0"</span> <span class="nv">description</span><span class="o">=</span><span class="s2">"这是一个Web服务器"</span> <span class="nv">by</span><span class="o">=</span><span class="s2">"IT笔录"</span>
</code></pre></div></div>

<p>指定后可以通过docker inspect查看：</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker inspect itbilu/test
<span class="s2">"Labels"</span>: <span class="o">{</span>
    <span class="s2">"version"</span>: <span class="s2">"1.0"</span>,
    <span class="s2">"description"</span>: <span class="s2">"这是一个Web服务器"</span>,
    <span class="s2">"by"</span>: <span class="s2">"IT笔录"</span>
<span class="o">}</span>,
</code></pre></div></div>

<h3 id="13-arg">13 ARG</h3>

<p>ARG用于指定传递给构建运行时的变量：</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ARG &lt;name&gt;[<span class="o">=</span>&lt;default value&gt;]
</code></pre></div></div>

<p>如，通过ARG指定两个变量：</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ARG site
ARG <span class="nv">build_user</span><span class="o">=</span>IT笔录
</code></pre></div></div>

<p>以上我们指定了 site 和 build_user 两个变量，其中 build_user 指定了默认值。在使用 docker build 构建镜像时，可以通过 <code class="highlighter-rouge">--build-arg &lt;varname&gt;=&lt;value&gt;</code> 参数来指定或重设置这些变量的值。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker build <span class="nt">--build-arg</span> <span class="nv">site</span><span class="o">=</span>itiblu.com <span class="nt">-t</span> itbilu/test <span class="nb">.</span>
</code></pre></div></div>

<p>这样我们构建了 itbilu/test 镜像，其中site会被设置为 itbilu.com，由于没有指定 build_user，其值将是默认值 IT 笔录。</p>

<h3 id="14-onbuild">14 ONBUILD</h3>

<p>ONBUILD用于设置镜像触发器：</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ONBUILD <span class="o">[</span>INSTRUCTION]
</code></pre></div></div>

<p>当所构建的镜像被用做其它镜像的基础镜像，该镜像中的触发器将会被钥触发。
如，当镜像被使用时，可能需要做一些处理：</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>...]
ONBUILD ADD <span class="nb">.</span> /app/src
ONBUILD RUN /usr/local/bin/python-build <span class="nt">--dir</span> /app/src
<span class="o">[</span>...]
</code></pre></div></div>

<h3 id="15-stopsignal">15 STOPSIGNAL</h3>

<p>STOPSIGNAL用于设置停止容器所要发送的系统调用信号：</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>STOPSIGNAL signal
</code></pre></div></div>

<p>所使用的信号必须是内核系统调用表中的合法的值，如：SIGKILL。</p>

<h3 id="16-shell">16 SHELL</h3>

<p>SHELL用于设置执行命令（shell式）所使用的的默认 shell 类型：</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SHELL <span class="o">[</span><span class="s2">"executable"</span>, <span class="s2">"parameters"</span><span class="o">]</span>
</code></pre></div></div>

<p>SHELL在Windows环境下比较有用，Windows 下通常会有 cmd 和 powershell 两种 shell，可能还会有 sh。这时就可以通过 SHELL 来指定所使用的 shell 类型：</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>FROM microsoft/windowsservercore

<span class="c"># Executed as cmd /S /C echo default</span>
RUN <span class="nb">echo </span>default

<span class="c"># Executed as cmd /S /C powershell -command Write-Host default</span>
RUN powershell <span class="nt">-command</span> Write-Host default

<span class="c"># Executed as powershell -command Write-Host hello</span>
SHELL <span class="o">[</span><span class="s2">"powershell"</span>, <span class="s2">"-command"</span><span class="o">]</span>
RUN Write-Host hello

<span class="c"># Executed as cmd /S /C echo hello</span>
SHELL <span class="o">[</span><span class="s2">"cmd"</span>, <span class="s2">"/S"", "</span>/C<span class="s2">"]
RUN echo hello
</span></code></pre></div></div>

<h2 id="dockerfile-使用经验">Dockerfile 使用经验</h2>

<h3 id="dockerfile-示例">Dockerfile 示例</h3>

<p><strong>构建Nginx运行环境</strong></p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 指定基础镜像</span>
FROM sameersbn/ubuntu:14.04.20161014

<span class="c"># 维护者信息</span>
MAINTAINER sameer@damagehead.com

<span class="c"># 设置环境</span>
ENV <span class="nv">RTMP_VERSION</span><span class="o">=</span>1.1.10 <span class="se">\</span>
    <span class="nv">NPS_VERSION</span><span class="o">=</span>1.11.33.4 <span class="se">\</span>
    <span class="nv">LIBAV_VERSION</span><span class="o">=</span>11.8 <span class="se">\</span>
    <span class="nv">NGINX_VERSION</span><span class="o">=</span>1.10.1 <span class="se">\</span>
    <span class="nv">NGINX_USER</span><span class="o">=</span>www-data <span class="se">\</span>
    <span class="nv">NGINX_SITECONF_DIR</span><span class="o">=</span>/etc/nginx/sites-enabled <span class="se">\</span>
    <span class="nv">NGINX_LOG_DIR</span><span class="o">=</span>/var/log/nginx <span class="se">\</span>
    <span class="nv">NGINX_TEMP_DIR</span><span class="o">=</span>/var/lib/nginx <span class="se">\</span>
    <span class="nv">NGINX_SETUP_DIR</span><span class="o">=</span>/var/cache/nginx

<span class="c"># 设置构建时变量，镜像建立完成后就失效</span>
ARG <span class="nv">BUILD_LIBAV</span><span class="o">=</span><span class="nb">false
</span>ARG <span class="nv">WITH_DEBUG</span><span class="o">=</span><span class="nb">false
</span>ARG <span class="nv">WITH_PAGESPEED</span><span class="o">=</span><span class="nb">true
</span>ARG <span class="nv">WITH_RTMP</span><span class="o">=</span><span class="nb">true</span>

<span class="c"># 复制本地文件到容器目录中</span>
COPY setup/ <span class="k">${</span><span class="nv">NGINX_SETUP_DIR</span><span class="k">}</span>/
RUN bash <span class="k">${</span><span class="nv">NGINX_SETUP_DIR</span><span class="k">}</span>/install.sh

<span class="c"># 复制本地配置文件到容器目录中</span>
COPY nginx.conf /etc/nginx/nginx.conf
COPY entrypoint.sh /sbin/entrypoint.sh

<span class="c"># 运行指令</span>
RUN <span class="nb">chmod </span>755 /sbin/entrypoint.sh

<span class="c"># 允许指定的端口</span>
EXPOSE 80/tcp 443/tcp 1935/tcp

<span class="c"># 指定网站目录挂载点</span>
VOLUME <span class="o">[</span><span class="s2">"</span><span class="k">${</span><span class="nv">NGINX_SITECONF_DIR</span><span class="k">}</span><span class="s2">"</span><span class="o">]</span>

ENTRYPOINT <span class="o">[</span><span class="s2">"/sbin/entrypoint.sh"</span><span class="o">]</span>
CMD <span class="o">[</span><span class="s2">"/usr/sbin/nginx"</span><span class="o">]</span>
</code></pre></div></div>

<p><strong>构建tomcat 环境</strong></p>

<p>Dockerfile文件</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 指定基于的基础镜像</span>
FROM ubuntu:13.10  

<span class="c"># 维护者信息</span>
MAINTAINER zhangjiayang <span class="s2">"zhangjiayang@sczq.com.cn"</span>  
  
<span class="c"># 镜像的指令操作</span>
<span class="c"># 获取APT更新的资源列表</span>
RUN <span class="nb">echo</span> <span class="s2">"deb http://archive.ubuntu.com/ubuntu precise main universe"</span><span class="o">&gt;</span> /etc/apt/sources.list
<span class="c"># 更新软件</span>
RUN apt-get update  
  
<span class="c"># Install curl  </span>
RUN apt-get <span class="nt">-y</span> <span class="nb">install </span>curl  
  
<span class="c"># Install JDK 7  </span>
RUN <span class="nb">cd</span> /tmp <span class="o">&amp;&amp;</span>  curl <span class="nt">-L</span> <span class="s1">'http://download.oracle.com/otn-pub/java/jdk/7u65-b17/jdk-7u65-linux-x64.tar.gz'</span> <span class="nt">-H</span> <span class="s1">'Cookie: oraclelicense=accept-securebackup-cookie; gpw_e24=Dockerfile'</span> | <span class="nb">tar</span> <span class="nt">-xz</span>  
RUN <span class="nb">mkdir</span> <span class="nt">-p</span> /usr/lib/jvm  
RUN <span class="nb">mv</span> /tmp/jdk1.7.0_65/ /usr/lib/jvm/java-7-oracle/  
  
<span class="c"># Set Oracle JDK 7 as default Java  </span>
RUN update-alternatives <span class="nt">--install</span> /usr/bin/java java /usr/lib/jvm/java-7-oracle/bin/java 300     
RUN update-alternatives <span class="nt">--install</span> /usr/bin/javac javac /usr/lib/jvm/java-7-oracle/bin/javac 300     

<span class="c"># 设置系统环境</span>
ENV JAVA_HOME /usr/lib/jvm/java-7-oracle/  
  
<span class="c"># Install tomcat7  </span>
RUN <span class="nb">cd</span> /tmp <span class="o">&amp;&amp;</span> curl <span class="nt">-L</span> <span class="s1">'http://archive.apache.org/dist/tomcat/tomcat-7/v7.0.8/bin/apache-tomcat-7.0.8.tar.gz'</span> | <span class="nb">tar</span> <span class="nt">-xz</span>  
RUN <span class="nb">mv</span> /tmp/apache-tomcat-7.0.8/ /opt/tomcat7/  
  
ENV CATALINA_HOME /opt/tomcat7  
ENV PATH <span class="nv">$PATH</span>:<span class="nv">$CATALINA_HOME</span>/bin  

<span class="c"># 复件tomcat7.sh到容器中的目录 </span>
ADD tomcat7.sh /etc/init.d/tomcat7  
RUN <span class="nb">chmod </span>755 /etc/init.d/tomcat7  
  
<span class="c"># Expose ports.  指定暴露的端口</span>
EXPOSE 8080  
  
<span class="c"># Define default command.  </span>
ENTRYPOINT service tomcat7 start <span class="o">&amp;&amp;</span> <span class="nb">tail</span> <span class="nt">-f</span> /opt/tomcat7/logs/catalina.out
</code></pre></div></div>

<p><code class="highlighter-rouge">tomcat7.sh</code>命令文件</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">export </span><span class="nv">JAVA_HOME</span><span class="o">=</span>/usr/lib/jvm/java-7-oracle/  
<span class="nb">export </span><span class="nv">TOMCAT_HOME</span><span class="o">=</span>/opt/tomcat7  
  
<span class="k">case</span> <span class="nv">$1</span> <span class="k">in  
</span>start<span class="p">)</span>  
  sh <span class="nv">$TOMCAT_HOME</span>/bin/startup.sh  
<span class="p">;;</span>  
stop<span class="p">)</span>  
  sh <span class="nv">$TOMCAT_HOME</span>/bin/shutdown.sh  
<span class="p">;;</span>  
restart<span class="p">)</span>  
  sh <span class="nv">$TOMCAT_HOME</span>/bin/shutdown.sh  
  sh <span class="nv">$TOMCAT_HOME</span>/bin/startup.sh  
<span class="p">;;</span>  
<span class="k">esac</span>  
<span class="nb">exit </span>0
</code></pre></div></div>

<h3 id="原则与建议">原则与建议</h3>

<ul>
  <li>容器轻量化。从镜像中产生的容器应该尽量轻量化，能在足够短的时间内停止、销毁、重新生成并替换原来的容器。</li>
  <li>使用 <code class="highlighter-rouge">.gitignore</code>。在大部分情况下，Dockerfile 会和构建所需的文件放在同一个目录中，为了提高构建的性能，应该使用 <code class="highlighter-rouge">.gitignore</code> 来过滤掉不需要的文件和目录。</li>
  <li>为了减少镜像的大小，减少依赖，仅安装需要的软件包。</li>
  <li>一个容器只做一件事。解耦复杂的应用，分成多个容器，而不是所有东西都放在一个容器内运行。如一个 Python Web 应用，可能需要 Server、DB、Cache、MQ、Log 等几个容器。一个更加极端的说法：One process per container。</li>
  <li>减少镜像的图层。不要多个 Label、ENV 等标签。</li>
  <li>对续行的参数按照字母表排序，特别是使用<code class="highlighter-rouge">apt-get install -y</code>安装包的时候。</li>
  <li>使用构建缓存。如果不想使用缓存，可以在构建的时候使用参数<code class="highlighter-rouge">--no-cache=true</code>来强制重新生成中间镜像。</li>
</ul>

<h2 id="参考">参考</h2>

<p><a href="https://docs.docker.com/engine/reference/builder/#usage">Dockerfile reference</a><br />
<a href="https://www.jianshu.com/p/cbce69c7a52f">使用Dockerfile构建Docker镜像</a><br />
<a href="https://itbilu.com/linux/docker/VyhM5wPuz.html">Docker镜像构建文件Dockerfile及相关命令介绍</a><br />
<a href="https://github.com/qianlei90/Blog/issues/35">深入Dockerfile（一）: 语法指南</a><br />
<a href="https://yeasy.gitbooks.io/docker_practice/content/">Docker — 从入门到实践</a></p>


            <!-- <div>
   <p align="center">
     	  
         <img src="http://favorites.ren/assets/images/cartoon.jpg" >
         <br/>
         微信扫描二维码，关注一个有故事的程序员
        

   </p>
   <p align="center" style="margin-top: 15px; font-size: 11px;color: #cc0000;">
       <strong>（转载本站文章请注明作者和出处 <a href="http://www.ityouknow.com">纯洁的微笑-ityouknow</a>）</strong>
   </p>
   <p align="center" style="margin-top: 15px; font-size: 16px;color: #337ab7;">
       <strong><a href="http://laughyouth.com/" target="_blank">点击了解：全网唯二以程序员为主题的漫画公众号</a></strong>
   </p>
</div> -->

            <!-- Comments -->
            <div class="comment">
             

  
    <a href="#" class="show_disqus_comment" onclick="return false;">Show Disqus Comments</a>
    <div id="disqus_thread"></div>
    <script>
    var disqus_config = function () {
        this.page.url = 'http://localhost:4000/docker/2018/03/15/docker-dockerfile-command-introduction.html';
        this.page.identifier = '/docker/2018/03/15/docker-dockerfile-command-introduction.html';
        this.page.title = 'Docker(三)：Dockerfile 命令详解';
    };
    var disqus_loaded = false;
    $(function() {
        $('.show_disqus_comment').on('click', function() { // DON'T EDIT BELOW THIS LINE
            $(this).html('加载中...');
            var that = this;
            if (!disqus_loaded) {
                var d = document, s = d.createElement('script');

                s.type = 'text/javascript';
                s.async = true;
                var shortname = 'panshuai1121';

                s.src = '//' + shortname + '.disqus.com/embed.js';

                s.setAttribute('data-timestamp', +new Date());
                (d.head || d.body).appendChild(s);

                disqus_loaded = true;
            }
            $(that).remove();
        })
    })
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
  

  
        <div id="gitalk-container"></div>
        <script src="/assets/js/gitalk.min.js"></script>
        <script>
        var gitalk = new Gitalk({
            id: '/docker/2018/03/15/docker-dockerfile-command-introduction.html',
            clientID: '01c69b4bdbdbc141e10d',
            clientSecret: '287c9fc8219a6ceba7428bbd9f3aa0e123e193fb',
            repo: 'blog-comments',
            owner: 'panshuai1121',
            admin: ['panshuai1121'],
            labels: ['gitment'],
            perPage: 50,
        })
        gitalk.render('gitalk-container')
        </script>
  


            </div>
        </div>

        <div class="col-md-3">
            <h3>Post Directory</h3>
<div id="post-directory-module">
<section class="post-directory">
    <!-- Links that trigger the jumping -->
    <!-- Added by javascript below -->
    <dl></dl>
</section>
</div>

<script type="text/javascript">

    $(document).ready(function(){
        $( "article h2" ).each(function( index ) {
            $(".post-directory dl").append("<dt><a class=\"jumper\" hre=#" +
                    $(this).attr("id")
                    + ">"
                    + $(this).text()
                    + "</a></dt>");

            var children = $(this).nextUntil("h2", "h3")

            children.each(function( index ) {
                $(".post-directory dl").append("<dd><a class=\"jumper\" hre=#" +
                        $(this).attr("id")
                        + ">"
                        + "&nbsp;&nbsp;- " + $(this).text()
                        + "</a></dd>");
            });
        });

        var fixmeTop = $('#post-directory-module').offset().top - 100;       // get initial position of the element

        $(window).scroll(function() {                  // assign scroll event listener

            var currentScroll = $(window).scrollTop(); // get current position

            if (currentScroll >= fixmeTop) {           // apply position: fixed if you
                $('#post-directory-module').css({      // scroll to that element or below it
                    top: '100px',
                    position: 'fixed',
                    width: 'inherit'
                });
            } else {                                   // apply position: static
                $('#post-directory-module').css({      // if you scroll above it
                    position: 'inherit',
                    width: 'inherit'
                });
            }

        });

        $("a.jumper").on("click", function( e ) {

            e.preventDefault();

            $("body, html").animate({
                scrollTop: ($( $(this).attr('hre') ).offset().top - 100)
            }, 600);

        });
    });

</script>
        </div>
        

    </div>
     <!-- <div class="asb-post-01">
        <div class="mask"></div>
            <div class="info">
                <div>扫码关注公众号：<span style="color: #E9405A; font-weight: bold;">纯洁的微笑</span></div>
            <div>
            <span>发送 </span><span class="token" style="color: #e9415a; font-weight: bold; font-size: 17px; margin-bottom: 45px;">290992</span>
            <div>
                即可<span style="color: #e9415a; font-weight: bold;">立即永久</span>解锁本站全部文章
            </div>
            <img class="code-img" style="width: 300px;display:unset" src="http://favorites.ren/assets/images/keeppuresmile.jpg">
        </div>
    </div> -->
</article>

        </div>

    
<footer class="container">
    <div class="site-footer">
       <!--  <div class="site-footer-icons">
            <a target="_blank" href="https://www.zhihu.com/people/ityouknow">
               知乎
            </a>
            <a target="_blank" href="http://weibo.com/ityouknow">
               微博
            </a>
            <a target="_blank" href="https://github.com/ityouknow">
                GitHub
            </a>
        </div> -->
          <!-- <div class="card text-center">
            <ul class="list-inline" style="margin-left: 0;">
               <li>
                <a target="_blank" href="https://github.com/panshuai1121">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a target="_blank" href="https://www.zhihu.com/people/ityouknow">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa  fa-stack-1x fa-inverse">知</i>
                  </span>
                </a>
              </li>
                  <li>
                <a target="_blank" href="https://weibo.com/ityouknow">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-weibo fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          </ul>
        </div> -->
        <div class="site-footer-links mobile-hidden">
            
            <a href="/payment.html" title="Pay" target="_self">Pay</a>
            
            <a href="/fastdfs.html" title="FastDFS" target="_blank">FastDFS</a>
            
            <a href="/mongodb.html" title="MongoDB" target="_blank">MongoDB</a>
            
            <a href="/docker.html" title="Docker" target="_blank">Docker</a>
            
            <a href="/open-source.html" title="Code" target="_blank">Code</a>
            
            <a href="/gitchat.html" title="Chat" target="_blank">Chat</a>
            
            <a href="/redis.html" title="redis" target="_blank">redis</a>
            
        </div>
        <div class="site-footer-icons">
               <a href="http://beian.miit.gov.cn" >京ICP备15067287号</a>
        </div>
        <div class="scrolltop">
            <a href="javascript:window.scrollTo(0,0)" >TOP</a>
        </div>
        <div class="rss">
            <a href="/feed.xml"><span class="octicon octicon-rss" style="color:orange;"></span></a>
            Power by <a href="https://github.com/DONGChuan/Yummy-Jekyll">Yummy Jekyll</a>
        </div>
    </div>
    <!-- Third-Party JS -->
    <script type="text/javascript" src="http://favorites.ren/bower_components/geopattern/js/geopattern.min.js"></script>
    <!-- My JS -->
    <script type="text/javascript" src="http://favorites.ren/assets/js/script.js"></script>
    
    
     <!-- Cnzz Analytics -->
       <!-- <div style="display:none">
         <script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1260945749'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s4.cnzz.com/z_stat.php%3Fid%3D1260945749' type='text/javascript'%3E%3C/script%3E"));</script>
       </div> -->
     <!-- Cnzz Analytics -->
</footer>


    </body>

</html>
